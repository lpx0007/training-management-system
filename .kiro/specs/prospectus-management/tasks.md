# 招商简章管理功能实现任务列表

## 任务概述

本任务列表将招商简章管理功能的实现分解为一系列可执行的编码任务。每个任务都是独立的、可测试的，并且按照依赖关系排序。

---

## 任务列表

- [x] 1. 数据库结构设置
  - 创建 prospectuses 表、prospectus_downloads 表
  - 更新 training_sessions 表添加 prospectus_id 字段
  - 创建必要的索引和外键约束
  - 设置 Row Level Security (RLS) 策略
  - _需求: 1.1, 1.2, 1.3, 7.1, 7.2, 7.3_

- [x] 2. TypeScript 类型定义
  - 在 src/lib/supabase/types.ts 中添加 Prospectus 接口
  - 添加 ProspectusDownload 接口
  - 扩展 TrainingSession 接口添加 prospectus_id 字段
  - 更新 Database 类型定义
  - _需求: 1.1, 1.2, 1.3_

- [x] 3. Supabase Storage 配置
  - 创建 prospectuses storage bucket
  - 配置 Storage RLS 策略（管理员上传/删除，管理员和业务员下载）
  - 设置 CORS 规则
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 4. ProspectusService 服务层实现
  - [ ] 4.1 创建 src/lib/supabase/prospectusService.ts 文件
    - 实现文件命名和路径生成工具函数
    - 实现文件验证函数（格式、大小）

    - _需求: 1.3, 7.1, 7.2_
  
  - [ ] 4.2 实现简章上传功能
    - 实现 uploadProspectus 方法（上传文件到 Storage，保存元数据到数据库）
    - 实现 uploadSealedVersion 方法（上传盖章文件）

    - 添加错误处理和验证
    - _需求: 1.1, 1.2, 1.3, 3.1, 3.2_
  
  - [ ] 4.3 实现简章查询功能
    - 实现 getProspectuses 方法（获取所有简章列表）
    - 实现 getProspectusById 方法（获取单个简章详情）

    - 实现 getRelatedTrainingSessions 方法（获取关联的培训场次）
    - _需求: 8.1, 8.2, 8.3_
  
  - [ ] 4.4 实现简章更新和删除功能
    - 实现 updateProspectus 方法（更新简章信息）

    - 实现 deleteProspectus 方法（删除简章及文件）
    - 实现 deleteSealedVersion 方法（删除盖章文件）
    - 添加关联检查逻辑



    - _需求: 2.3, 2.4, 2.5, 3.4, 8.5_
  
  - [ ] 4.5 实现简章下载功能
    - 实现 downloadProspectus 方法（生成签名URL并下载）
    - 实现 recordDownload 方法（记录下载历史）
    - 优先下载盖章版本逻辑
    - _需求: 3.3, 5.3, 5.4, 9.1_
  
  - [ ] 4.6 实现下载记录查询功能
    - 实现 getDownloadHistory 方法（获取下载记录）
    - 支持按简章ID筛选
    - 支持分页
    - _需求: 9.2, 9.3, 9.4_

- [ ] 5. 简章管理页面实现
  - [ ] 5.1 创建页面基础结构
    - 创建 src/pages/ProspectusManagement.tsx 文件
    - 实现页面布局（Sidebar + Header + Main Content）
    - 复用现有的 Sidebar 组件
    - 使用与其他管理页面一致的样式
    - _需求: 8.1_
  
  - [ ] 5.2 实现简章列表展示
    - 创建简章列表表格组件
    - 显示简章名称、类型、上传时间、状态、盖章标识
    - 实现排序功能
    - 实现分页功能
    - _需求: 8.1, 8.2, 8.4_
  
  - [ ] 5.3 实现搜索和筛选功能
    - 添加搜索框（按名称搜索）
    - 添加类型筛选下拉框
    - 添加状态筛选
    - 实时筛选逻辑
    - _需求: 8.2, 8.3_
  
  - [ ] 5.4 实现简章操作按钮
    - 添加"上传简章"按钮（仅管理员可见）
    - 添加"编辑"按钮
    - 添加"上传盖章文件"按钮
    - 添加"删除"按钮
    - 添加"查看下载记录"按钮
    - _需求: 1.1, 2.3, 3.1, 8.5, 9.2_

- [ ] 6. 简章上传模态框实现
  - [ ] 6.1 创建上传模态框组件
    - 创建模态框基础结构
    - 使用与现有模态框一致的样式
    - 实现打开/关闭逻辑
    - _需求: 1.1_
  
  - [ ] 6.2 实现文件选择和验证
    - 添加文件选择输入框（仅接受PDF）
    - 实现拖拽上传支持
    - 实现文件格式验证（前端）
    - 实现文件大小验证（最大10MB）
    - 显示验证错误提示
    - _需求: 1.2, 1.3, 1.5_
  
  - [ ] 6.3 实现元数据输入表单
    - 添加简章名称输入框（必填）
    - 添加简章类型选择框
    - 添加简章描述文本框
    - 实现表单验证
    - _需求: 2.1, 2.2_
  
  - [ ] 6.4 实现上传进度和提交
    - 显示上传进度条
    - 实现提交逻辑（调用 ProspectusService）
    - 显示成功/失败提示
    - 上传成功后刷新列表
    - _需求: 1.4, 2.4_

- [ ] 7. 简章编辑模态框实现
  - [ ] 7.1 创建编辑模态框组件
    - 创建模态框基础结构
    - 加载现有简章数据
    - 使用与上传模态框一致的样式
    - _需求: 2.3_
  
  - [ ] 7.2 实现信息编辑表单
    - 显示并允许编辑简章名称
    - 显示并允许编辑简章类型
    - 显示并允许编辑简章描述
    - 实现表单验证
    - _需求: 2.3_
  
  - [ ] 7.3 实现文件替换功能
    - 添加"替换文件"按钮
    - 实现文件选择和验证
    - 上传新文件并更新数据库
    - 删除旧文件
    - _需求: 2.5_
  
  - [ ] 7.4 实现盖章文件管理
    - 显示当前盖章文件状态
    - 添加"上传盖章文件"按钮
    - 添加"删除盖章文件"按钮
    - 实现上传和删除逻辑
    - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 8. 下载记录模态框实现
  - [ ] 8.1 创建下载记录模态框组件
    - 创建模态框基础结构
    - 使用与其他模态框一致的样式
    - _需求: 9.2_
  
  - [ ] 8.2 实现下载记录列表
    - 显示下载时间、下载人、文件类型
    - 显示关联的培训场次（如有）
    - 实现分页功能
    - _需求: 9.2, 9.3, 9.4_
  
  - [ ] 8.3 实现下载统计
    - 显示总下载次数
    - 显示最近下载时间
    - 显示下载人数统计
    - _需求: 9.2_

- [ ] 9. 培训场次简章关联功能
  - [ ] 9.1 更新培训添加/编辑表单
    - 在 TrainingPerformance.tsx 的添加/编辑模态框中添加简章选择下拉框
    - 加载可用简章列表
    - 显示简章盖章状态
    - 保存 prospectus_id 到数据库
    - _需求: 4.1, 4.2, 4.3_
  
  - [ ] 9.2 更新 supabaseService 的培训相关方法
    - 更新 addTrainingSession 方法支持 prospectus_id
    - 更新 updateTrainingSession 方法支持 prospectus_id
    - 更新 getTrainingSessions 方法返回 prospectus_id
    - 更新 getTrainingSessionById 方法返回简章信息
    - _需求: 4.1, 4.2, 4.4_

- [ ] 10. 培训详情页简章展示和下载
  - [ ] 10.1 更新培训详情模态框
    - 在 TrainingPerformance.tsx 的详情模态框中添加"招商简章"区域
    - 显示简章名称和盖章状态
    - 添加"下载简章"按钮





    - 处理未关联简章的情况（显示"暂无招商简章"）
    - _需求: 5.1, 5.2, 5.6_
  
  - [ ] 10.2 实现简章下载功能
    - 实现下载按钮点击事件


    - 调用 ProspectusService.downloadProspectus 方法
    - 优先下载盖章版本
    - 显示下载成功/失败提示
    - 记录下载历史
    - _需求: 5.3, 5.4, 9.1_
  
  - [ ] 10.3 实现权限控制
    - 管理员和业务员可以下载
    - 专家只能查看不能下载
    - 未登录用户无法访问
    - _需求: 6.1, 6.2, 6.3, 6.4_

- [ ] 11. 导航栏更新
  - [ ] 11.1 更新 Sidebar 组件
    - 在 src/components/Sidebar.tsx 中添加"招商简章"菜单项
    - 设置路由为 /prospectus-management
    - 仅对管理员显示
    - 使用合适的图标（如 FileText）
    - _需求: 8.1_
  
  - [ ] 11.2 更新路由配置
    - 在 src/App.tsx 中添加 /prospectus-management 路由
    - 配置路由保护（仅管理员可访问）
    - _需求: 8.1_

- [ ] 12. 错误处理和用户反馈
  - [ ] 12.1 实现统一错误处理
    - 创建 ProspectusError 类
    - 定义错误码枚举
    - 实现错误处理函数
    - _需求: 1.5, 6.5_
  
  - [ ] 12.2 添加用户提示
    - 使用 toast 显示成功提示
    - 使用 toast 显示错误提示
    - 添加确认对话框（删除操作）
    - 添加加载状态指示器
    - _需求: 1.4, 2.4, 8.5_

- [ ] 13. 数据验证和安全
  - [ ] 13.1 实现前端验证
    - 文件格式验证
    - 文件大小验证
    - 表单字段验证
    - _需求: 1.2, 1.3, 2.2_
  
  - [ ] 13.2 实现后端验证
    - 在 ProspectusService 中添加文件验证
    - 添加权限验证
    - 添加数据完整性检查
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 14. 集成测试和调试
  - [ ] 14.1 测试完整流程
    - 测试上传简章流程
    - 测试编辑简章流程
    - 测试上传盖章文件流程
    - 测试关联培训流程
    - 测试下载简章流程
    - 测试删除简章流程
    - _需求: 所有需求_
  
  - [ ] 14.2 测试权限控制
    - 测试管理员权限
    - 测试业务员权限
    - 测试专家权限
    - 测试未登录用户
    - _需求: 6.1, 6.2, 6.3, 6.4_
  
  - [ ] 14.3 测试边界情况
    - 测试大文件上传
    - 测试无效文件格式
    - 测试删除已关联的简章
    - 测试并发下载
    - _需求: 1.3, 1.5, 8.5_

---

## 任务执行说明

1. **任务顺序**: 按照任务编号顺序执行，确保依赖关系正确
2. **独立性**: 每个子任务都是独立的，可以单独完成和测试
3. **测试**: 完成每个任务后，进行基本的功能测试
4. **代码风格**: 遵循项目现有的代码风格和命名规范
5. **UI一致性**: 确保所有新增UI组件与现有系统保持一致的设计风格
6. **文档**: 在代码中添加必要的注释，说明复杂逻辑

## 预估工作量

- 数据库和类型定义: 1-2小时
- 服务层实现: 3-4小时
- 简章管理页面: 4-5小时
- 模态框组件: 3-4小时
- 培训场次集成: 2-3小时
- 测试和调试: 2-3小时

**总计**: 约15-21小时
