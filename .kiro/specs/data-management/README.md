# 数据管理功能 Spec

## 概述

数据管理功能是培训管理系统的核心管理模块，为管理员提供批量导入和导出培训课程、专家、客户、业务员、培训场次等核心业务数据的能力。

## 功能特性

### 🔄 数据导入
- 支持 Excel (.xlsx) 和 CSV (.csv) 格式
- 提供标准化的数据模板下载
- 智能数据验证（格式、范围、外键、重复检测）
- 导入预览功能，确认后再导入
- 灵活的重复数据处理策略（跳过、覆盖、保留）
- 自动为专家和业务员创建登录账号（初始密码：123456）
- 详细的错误报告和可下载的错误文件

### 📤 数据导出
- 支持 Excel、CSV、PDF 三种格式
- 灵活的字段选择
- 多种导出范围（全部、筛选、自定义日期范围）
- 自定义筛选条件
- 自动文件命名和下载

### 📊 支持的数据类型
1. **培训课程** - 课程 ID、名称、描述、时长、价格、分类、专家
2. **专家信息** - 姓名、职称、领域、经验、评分、课程、地区
3. **客户信息** - 姓名、手机、邮箱、公司、职位、业务员、状态
4. **业务员信息** - 姓名、手机、部门、职位、邮箱、入职日期、状态
5. **培训场次** - 名称、日期、时间、专家、业务员、地区、状态

### 📝 操作历史
- 记录所有导入导出操作
- 显示操作时间、类型、数据量、状态
- 查看详细的操作结果和错误信息
- 保留 90 天历史记录

## 文档结构

- **requirements.md** - 详细的功能需求文档（21 个需求，EARS 格式）
- **design.md** - 完整的技术设计文档（架构、组件、接口、数据库）
- **tasks.md** - 可执行的任务列表（24 个任务）
- **README.md** - 本文档，功能概述和快速开始

## 快速开始

### 开始实现

1. 打开 `tasks.md` 文件
2. 点击任务旁边的 "Start task" 按钮
3. 按照任务顺序逐个完成

### 推荐实现顺序

**阶段 1: 基础设施** (任务 1-3)
- 安装依赖和配置
- 创建数据库表
- 定义类型和常量

**阶段 2: 核心服务** (任务 4-9)
- 实现验证、解析、导出、服务层
- 这些是功能的核心逻辑

**阶段 3: UI 组件** (任务 10-17)
- 从小组件到大组件
- 最后集成主页面

**阶段 4: 系统集成** (任务 18-21)
- 更新路由和导航
- 添加错误处理和优化

**阶段 5: 测试验收** (任务 22-24)
- 可选的单元测试和集成测试
- 必需的用户验收测试

## 关键设计决策

### 必填字段
- **培训课程**: 课程 ID、课程名称
- **专家信息**: 专家姓名
- **客户信息**: 客户姓名、手机号
- **业务员信息**: 业务员姓名、手机号
- **培训场次**: 培训名称、开始日期、结束时间

### 账号创建规则
- 导入专家和业务员时，如果提供了邮箱或手机号，自动创建登录账号
- 优先使用邮箱作为用户名，没有邮箱则使用手机号
- 初始密码统一为 "123456"
- 如果账号已存在，只更新资料，不创建新账号

### 重复数据处理
- **跳过**: 检测到重复时跳过该条记录（适用于课程、客户、业务员）
- **覆盖**: 检测到重复时更新现有记录
- **保留两者**: 检测到重复时仍然插入新记录（适用于专家、培训场次）

### 性能要求
- 1000 条数据验证 < 3 秒
- 1000 条数据导入 < 10 秒
- 1000 条数据导出 < 5 秒
- 支持最多 50000 条数据单次导入
- 超过 10000 条数据使用分批处理

## 技术栈

- **前端**: React 18 + TypeScript + Tailwind CSS
- **数据处理**: xlsx, papaparse, jspdf
- **后端**: Supabase (PostgreSQL + Auth + RLS)
- **状态管理**: React Context + Hooks

## 依赖包

```bash
pnpm add xlsx papaparse jspdf jspdf-autotable file-saver
pnpm add -D @types/papaparse @types/file-saver
```

## 数据库变更

需要执行以下 SQL 创建新表：

```sql
-- 操作历史表
CREATE TABLE public.data_management_history (...);

-- 审计日志表
CREATE TABLE public.audit_logs (...);
```

详细的 SQL 脚本请参考 `design.md` 中的"数据库扩展"章节。

## 权限要求

- 只有 **admin** 角色可以访问数据管理功能
- 路由级别和 API 级别都有权限验证
- 使用 Supabase RLS 策略保护数据

## 注意事项

1. **数据验证**: 导入前会进行严格的数据验证，确保数据质量
2. **外键关联**: 支持通过姓名自动查找关联的专家和业务员 ID
3. **错误处理**: 导入失败的数据会生成详细的错误报告
4. **操作记录**: 所有操作都会记录到历史表中，便于追溯
5. **初始密码**: 新创建的账号初始密码为 "123456"，需提醒用户修改

## 后续扩展

- 模板自定义功能
- 数据转换和清洗规则
- 定时导出任务
- 与外部系统数据同步
- 高级筛选和批量编辑

## 相关文档

- [需求文档](./requirements.md) - 详细的功能需求
- [设计文档](./design.md) - 技术设计和架构
- [任务列表](./tasks.md) - 实现任务清单

## 联系方式

如有问题或建议，请联系开发团队。
