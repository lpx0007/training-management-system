# 权限管理系统使用指南

## 📋 概述

培训机构业务通的权限管理系统采用双层控制机制，确保数据安全和功能访问的精确控制。

## 🔐 权限系统架构

### 1. 两层权限控制

#### 菜单权限 (user_menu_access)
- **作用**：控制侧边栏菜单项的显示/隐藏
- **存储表**：`user_menu_access`
- **影响范围**：用户界面的功能面板访问

#### 操作权限 (user_permissions)
- **作用**：控制具体功能按钮的显示和操作
- **存储表**：`user_permissions`
- **影响范围**：页面内的具体操作（如添加、编辑、删除、导出等）

### 2. 角色默认权限

| 角色 | 默认菜单权限 | 说明 |
|------|------------|------|
| **管理员** | 所有功能面板 | 完全访问权限 |
| **部门经理** | 仪表盘、客户管理、培训管理、业务员管理、销售追踪、招商简章、个人设置 | 管理本部门业务 |
| **业务员** | 仪表盘、客户管理、培训管理、课程管理、专家管理、招商简章、个人设置 | 执行日常业务 |
| **专家** | 仪表盘、培训管理、专家管理、招商简章、个人设置 | 查看相关信息 |

## 🛠️ 权限管理操作

### 1. 访问权限管理页面

只有管理员角色可以访问权限管理页面：
1. 登录管理员账号
2. 点击侧边栏的"权限管理"菜单
3. 进入权限配置界面

### 2. 为单个用户设置权限

#### 步骤：
1. 在用户列表中找到目标用户
2. 点击"设置权限"按钮
3. 在弹出的模态框中：
   - **导航栏开关**：控制功能面板在侧边栏的显示
   - **权限复选框**：控制具体操作权限
4. 点击"保存"按钮

#### 重要提示：
- ⚠️ 用户必须**重新登录**才能生效
- ✅ 权限设置立即保存到数据库
- 🔄 不会影响当前已登录的用户

### 3. 批量设置角色权限

#### 操作方式：
1. 点击角色分组旁的"批量设置"按钮
2. 选择设置策略：
   - **完全覆盖**：删除现有权限，完全使用新设置
   - **合并模式**：保留现有权限，添加新权限
   - **重置默认**：恢复为角色默认权限
3. 配置权限和功能面板
4. 点击"确认批量设置"

## ⚠️ 常见问题与解决

### 问题1：权限设置后不生效

**原因**：
- 用户未重新登录
- 默认角色配置与数据库不一致

**解决方案**：
1. 通知用户重新登录
2. 执行权限诊断脚本：
```sql
-- 在Supabase SQL编辑器中执行
SELECT * FROM check_permission_consistency();
```

### 问题2：部门经理看到不该看的菜单

**原因**：
- 默认配置包含了该菜单
- 历史权限未清理

**解决方案**：
执行修复脚本（已提供）：
```bash
scripts/migrations/diagnose-permission-system.sql
```

### 问题3：新功能权限配置

**步骤**：
1. 在 `constants/permissions.ts` 添加新权限定义
2. 在 `constants/menuFeatures.ts` 添加菜单配置
3. 在 `constants/featurePermissionMapping.ts` 建立映射关系
4. 更新数据库默认权限

## 📊 权限验证工具

### 使用权限验证器

```typescript
import { validateUserPermissions, getPermissionDiagnosticReport } from '@/utils/permissionValidator';

// 验证单个用户
const issues = await validateUserPermissions(userId);

// 生成诊断报告
const report = await getPermissionDiagnosticReport();
console.log('权限问题数量：', report.issueCount);
```

### 定期检查建议

建议每周执行一次权限一致性检查：
1. 登录Supabase控制台
2. 执行诊断SQL脚本
3. 查看是否有权限不一致
4. 必要时执行修复脚本

## 🔄 权限更新流程

### 当需要调整权限配置时：

1. **更新默认配置**
   - 修改 `menuFeatures.ts` 中的 `ROLE_DEFAULT_MENU_FEATURES`
   - 修改 `permissions.ts` 中的 `ROLE_DEFAULT_PERMISSIONS`

2. **同步数据库**
   - 创建迁移脚本更新现有用户权限
   - 执行权限诊断脚本验证

3. **通知用户**
   - 发送通知要求受影响用户重新登录
   - 提供权限变更说明

## 📝 最佳实践

### DO ✅
- 定期检查权限一致性
- 修改权限后通知用户重新登录
- 使用批量设置功能统一管理角色权限
- 保持默认配置与业务需求同步

### DON'T ❌
- 直接修改数据库权限表（除非通过脚本）
- 忽略权限验证工具的警告
- 在生产环境随意测试权限变更
- 给普通用户过多权限

## 🚀 快速诊断命令

### SQL诊断查询

```sql
-- 查看所有部门经理的菜单权限
SELECT 
  up.name,
  ARRAY_AGG(uma.menu_feature_id) as menus
FROM user_profiles up
LEFT JOIN user_menu_access uma ON up.id = uma.user_id
WHERE up.role = 'manager'
GROUP BY up.id, up.name;

-- 查看权限不一致的用户
SELECT * FROM check_permission_consistency();

-- 查看特定用户的所有权限
SELECT 
  'menu' as type,
  menu_feature_id as permission
FROM user_menu_access 
WHERE user_id = 'USER_ID_HERE'
UNION ALL
SELECT 
  'operation' as type,
  permission_id as permission
FROM user_permissions
WHERE user_id = 'USER_ID_HERE';
```

## 📞 技术支持

如遇到权限系统问题：
1. 首先执行诊断脚本
2. 检查默认配置文件
3. 验证用户是否重新登录
4. 查看浏览器控制台错误信息

---

**最后更新**：2024年11月
**版本**：1.0.0
