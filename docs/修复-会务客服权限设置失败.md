# ä¿®å¤ - ä¼šåŠ¡å®¢æœæƒé™è®¾ç½®å¤±è´¥

**åˆ›å»ºæ—¥æœŸ**: 2025-11-16  
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ï¼ˆæƒé™åŠŸèƒ½å—å½±å“ï¼‰  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  

## é—®é¢˜æè¿°

ç®¡ç†å‘˜åœ¨è°ƒæ•´ä¼šåŠ¡å®¢æœæƒé™æ—¶é‡åˆ°2ä¸ªå¤±è´¥é”™è¯¯ï¼š

```
Supabase Error [updateUserMenuAccess]
Message: å…³è”æ•°æ®ä¸å­˜åœ¨
Code: FOREIGN_KEY_VIOLATION
Hint: è¯·ç¡®ä¿å…³è”çš„æ•°æ®å­˜åœ¨
```

### é”™è¯¯æˆªå›¾

![æƒé™è®¾ç½®å¤±è´¥](../../é”™è¯¯æˆªå›¾.png)

## é—®é¢˜åŸå› 

### æ ¹æœ¬åŸå› 

**æ•°æ®åº“ `menu_features` è¡¨ä¸­ç¼ºå°‘èœå•åŠŸèƒ½è®°å½•**

ç³»ç»Ÿä»£ç ä¸­å®šä¹‰äº†ä»¥ä¸‹èœå•åŠŸèƒ½ï¼ˆåœ¨ `src/constants/menuFeatures.ts`ï¼‰ï¼š
```typescript
- dashboard âœ…
- course_management âœ…ï¼ˆå·²æœ‰å•ç‹¬è¿ç§»è„šæœ¬ï¼‰
- training_management âœ…
- sales_tracking âœ…
- salesperson_management âœ…
- customer_management âœ…
- expert_management âœ…
- prospectus_management âœ…
- schedule_management âŒ ç¼ºå¤±ï¼
- poster_generator âœ…
- announcement_management âŒ ç¼ºå¤±ï¼
- permission_management âœ…
- audit_logs âœ…
- profile_settings âœ…
```

ä½†æ•°æ®åº“åªæœ‰éƒ¨åˆ†è®°å½•ï¼Œç¼ºå°‘ï¼š
1. **`schedule_management`** - è¯¾è¡¨ç®¡ç†
2. **`announcement_management`** - å…¬å‘Šç®¡ç†

### è§¦å‘åœºæ™¯

å½“ç®¡ç†å‘˜å°è¯•ä¸ºä¼šåŠ¡å®¢æœå‹¾é€‰"è¯¾è¡¨ç®¡ç†"èœå•åŠŸèƒ½æ—¶ï¼š

1. å‰ç«¯ä»£ç å°† `schedule_management` åŠ å…¥ `selectedMenuFeatures` åˆ—è¡¨
2. è°ƒç”¨ `supabaseService.updateUserMenuAccess(userId, selectedMenuFeatures)`
3. åç«¯å°è¯•æ’å…¥ `user_menu_access` è¡¨ï¼š
   ```sql
   INSERT INTO user_menu_access (user_id, menu_feature_id, enabled)
   VALUES (user_id, 'schedule_management', true)
   ```
4. ç”±äº `menu_feature_id` æ˜¯å¤–é”®ï¼Œå¼•ç”¨ `menu_features.id`
5. ä½† `menu_features` è¡¨ä¸­æ²¡æœ‰ `schedule_management` è¿™æ¡è®°å½•
6. **è§¦å‘å¤–é”®çº¦æŸè¿åé”™è¯¯** âŒ

### æ•°æ®æµç¨‹

```
å‰ç«¯ç•Œé¢
  â†“
å‹¾é€‰"è¯¾è¡¨ç®¡ç†"èœå•
  â†“
selectedMenuFeatures = [..., 'schedule_management']
  â†“
updateUserMenuAccess(userId, selectedMenuFeatures)
  â†“
INSERT INTO user_menu_access (user_id, menu_feature_id, ...)
  â†“
å¤–é”®æ£€æŸ¥: menu_feature_id REFERENCES menu_features(id)
  â†“
âŒ 'schedule_management' ä¸åœ¨ menu_features è¡¨ä¸­
  â†“
FOREIGN_KEY_VIOLATION é”™è¯¯
```

## ä¿®å¤æ–¹æ¡ˆ

### 1. å‰ç«¯ä»£ç ä¿®å¤ âœ…

**æ–‡ä»¶**: `src/constants/menuFeatures.ts`

ä¸ºä¼šåŠ¡å®¢æœæ·»åŠ  `schedule_management` åˆ°é»˜è®¤èœå•åˆ—è¡¨ï¼š

```typescript
conference_service: [
  'dashboard',              // ä»ªè¡¨ç›˜
  'training_management',    // åŸ¹è®­è®¡åˆ’
  'prospectus_management',  // æ‹›å•†ç®€ç« 
  'schedule_management',    // è¯¾è¡¨ç®¡ç† â† æ–°å¢
  'profile_settings',       // ä¸ªäººè®¾ç½®
]
```

**ä¿®æ”¹ä½ç½®**: ç¬¬189-196è¡Œ

---

### 2. æ•°æ®åº“ä¿®å¤ ğŸ”§

**æ–‡ä»¶**: `supabase-migrations/add-schedule-management-menu.sql`

æ‰§è¡ŒSQLè„šæœ¬æ·»åŠ ç¼ºå¤±çš„èœå•åŠŸèƒ½è®°å½•ï¼š

```sql
-- 1. æ·»åŠ è¯¾è¡¨ç®¡ç†èœå•åŠŸèƒ½
INSERT INTO public.menu_features (id, name, path, icon, description, required_permissions, display_order) 
VALUES ('schedule_management', 'è¯¾è¡¨ç®¡ç†', '/schedule-management', 'calendar', 'ç®¡ç†è¯¾è¡¨æ–‡ä»¶', '{schedule_view}', 9)
ON CONFLICT (id) DO UPDATE SET ...;

-- 2. æ·»åŠ å…¬å‘Šç®¡ç†èœå•åŠŸèƒ½  
INSERT INTO public.menu_features (id, name, path, icon, description, required_permissions, display_order)
VALUES ('announcement_management', 'å…¬å‘Šç®¡ç†', '/announcement-management', 'bullhorn', 'å‘å¸ƒå’Œç®¡ç†ç³»ç»Ÿå…¬å‘Š', '{}', 10)
ON CONFLICT (id) DO UPDATE SET ...;

-- 3. ä¸ºä¼šåŠ¡å®¢æœè‡ªåŠ¨åˆ†é…è¯¾è¡¨ç®¡ç†èœå•æƒé™
INSERT INTO public.user_menu_access (user_id, menu_feature_id, enabled)
SELECT up.id, 'schedule_management', true
FROM public.user_profiles up
WHERE up.role = 'conference_service' ...;
```

## å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§» ğŸ”§

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```bash
æ–‡ä»¶: supabase-migrations/add-schedule-management-menu.sql
```

**æ“ä½œ**:
1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶ `add-schedule-management-menu.sql` çš„å…¨éƒ¨å†…å®¹
4. ç²˜è´´å¹¶æ‰§è¡Œ
5. æŸ¥çœ‹æ‰§è¡Œç»“æœï¼Œç¡®è®¤æˆåŠŸ

**é¢„æœŸç»“æœ**:
```
âœ… æ–°å¢èœå•åŠŸèƒ½
- schedule_management (è¯¾è¡¨ç®¡ç†)
- announcement_management (å…¬å‘Šç®¡ç†)

âœ… è¯¾è¡¨ç®¡ç†æƒé™åˆ†é…æƒ…å†µ
- conference_service: X ä¸ªç”¨æˆ·
- salesperson: X ä¸ªç”¨æˆ·
- expert: X ä¸ªç”¨æˆ·
```

---

### æ­¥éª¤2ï¼šåˆ·æ–°å‰ç«¯ä»£ç  ğŸ’»

å‰ç«¯ä»£ç å·²ä¿®æ”¹ï¼Œéœ€è¦ï¼š

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
2. **åˆ·æ–°é¡µé¢**
3. **é‡æ–°ç™»å½•**ï¼ˆå¦‚æœéœ€è¦ï¼‰

---

### æ­¥éª¤3ï¼šéªŒè¯ä¿®å¤ âœ…

**æµ‹è¯•1ï¼šæŸ¥çœ‹èœå•åŠŸèƒ½è®°å½•**

```sql
SELECT id, name, path 
FROM public.menu_features 
WHERE id IN ('schedule_management', 'announcement_management');
```

**é¢„æœŸç»“æœ**:
```
id                        | name      | path
-------------------------|-----------|------------------------
schedule_management      | è¯¾è¡¨ç®¡ç†   | /schedule-management
announcement_management  | å…¬å‘Šç®¡ç†   | /announcement-management
```

---

**æµ‹è¯•2ï¼šç®¡ç†å‘˜è®¾ç½®ä¼šåŠ¡å®¢æœæƒé™**

1. ç®¡ç†å‘˜ç™»å½•
2. è¿›å…¥"æƒé™ç®¡ç†"é¡µé¢
3. é€‰æ‹©ä¸€ä¸ªä¼šåŠ¡å®¢æœç”¨æˆ·
4. ç‚¹å‡»"ç¼–è¾‘æƒé™"
5. å‹¾é€‰"è¯¾è¡¨ç®¡ç†"èœå•
6. ç‚¹å‡»"ä¿å­˜"

**é¢„æœŸç»“æœ**: âœ… ä¿å­˜æˆåŠŸï¼Œæ²¡æœ‰é”™è¯¯

---

**æµ‹è¯•3ï¼šä¼šåŠ¡å®¢æœç™»å½•æŸ¥çœ‹**

1. ä¼šåŠ¡å®¢æœç™»å½•
2. æŸ¥çœ‹å·¦ä¾§å¯¼èˆªæ 

**é¢„æœŸç»“æœ**: 
- âœ… æ˜¾ç¤º"ä»ªè¡¨ç›˜"
- âœ… æ˜¾ç¤º"åŸ¹è®­è®¡åˆ’"
- âœ… æ˜¾ç¤º"æ‹›å•†ç®€ç« "
- âœ… æ˜¾ç¤º"è¯¾è¡¨ç®¡ç†" â† æ–°å¢
- âœ… æ˜¾ç¤º"ä¸ªäººè®¾ç½®"

---

**æµ‹è¯•4ï¼šä¼šåŠ¡å®¢æœæƒé™åŠŸèƒ½**

1. ä¼šåŠ¡å®¢æœè¿›å…¥"è¯¾è¡¨ç®¡ç†"é¡µé¢
2. ç‚¹å‡»"ä¸Šä¼ è¯¾è¡¨" âœ…
3. ä¸Šä¼ æˆåŠŸåï¼ŒæŸ¥çœ‹åˆ—è¡¨
4. è‡ªå·±ä¸Šä¼ çš„è¯¾è¡¨æ˜¾ç¤º"ç¼–è¾‘"å’Œ"åˆ é™¤"æŒ‰é’® âœ…
5. å…¶ä»–äººä¸Šä¼ çš„è¯¾è¡¨ä¸æ˜¾ç¤º"ç¼–è¾‘"å’Œ"åˆ é™¤"æŒ‰é’® âœ…

## ä¿®å¤å¯¹æ¯”

### ä¿®å¤å‰ âŒ

```
æ•°æ®åº“ menu_features è¡¨:
- prospectus_management âœ…
- schedule_management âŒ ç¼ºå¤±
- announcement_management âŒ ç¼ºå¤±

ä¼šåŠ¡å®¢æœé»˜è®¤èœå•:
- dashboard
- training_management  
- prospectus_management
- profile_settings
ï¼ˆç¼ºå°‘ schedule_managementï¼‰

ç»“æœ:
âŒ ç®¡ç†å‘˜è®¾ç½®æƒé™æ—¶æŠ¥ FOREIGN_KEY_VIOLATION é”™è¯¯
âŒ ä¼šåŠ¡å®¢æœçœ‹ä¸åˆ°"è¯¾è¡¨ç®¡ç†"èœå•
```

---

### ä¿®å¤å âœ…

```
æ•°æ®åº“ menu_features è¡¨:
- prospectus_management âœ…
- schedule_management âœ… å·²æ·»åŠ 
- announcement_management âœ… å·²æ·»åŠ 

ä¼šåŠ¡å®¢æœé»˜è®¤èœå•:
- dashboard
- training_management
- prospectus_management  
- schedule_management â† æ–°å¢
- profile_settings

ç»“æœ:
âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸è®¾ç½®æƒé™
âœ… ä¼šåŠ¡å®¢æœå¯ä»¥çœ‹åˆ°"è¯¾è¡¨ç®¡ç†"èœå•
âœ… ä¼šåŠ¡å®¢æœå¯ä»¥ä¸Šä¼ ã€ç¼–è¾‘ã€åˆ é™¤è‡ªå·±çš„è¯¾è¡¨
```

## ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

### å¼€å‘æµç¨‹ä¸å®Œå–„

1. **å‰ç«¯å…ˆè¡Œ**ï¼šåœ¨ `menuFeatures.ts` ä¸­æ·»åŠ äº†æ–°èœå•å®šä¹‰
2. **æ•°æ®åº“æ»å**ï¼šå¿˜è®°åŒæ­¥æ›´æ–°æ•°æ®åº“çš„ `menu_features` è¡¨
3. **æ²¡æœ‰éªŒè¯**ï¼šæ²¡æœ‰æ£€æŸ¥ä»£ç ä¸æ•°æ®åº“æ˜¯å¦ä¸€è‡´

### ç³»ç»Ÿè®¾è®¡é—®é¢˜

**åŒé‡å®šä¹‰å¯¼è‡´ä¸ä¸€è‡´**ï¼š

```
å‰ç«¯å®šä¹‰ï¼ˆmenuFeatures.tsï¼‰
  âš ï¸ å¯èƒ½ä¸ä¸€è‡´
æ•°æ®åº“è®°å½•ï¼ˆmenu_features è¡¨ï¼‰
```

ç†æƒ³æƒ…å†µåº”è¯¥æ˜¯ï¼š
- **å•ä¸€æ•°æ®æº**ï¼šè¦ä¹ˆä»æ•°æ®åº“è¯»å–ï¼Œè¦ä¹ˆå‰ç«¯å®šä¹‰åè‡ªåŠ¨åŒæ­¥
- **å¯åŠ¨æ£€æŸ¥**ï¼šåº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ä¸€è‡´æ€§
- **è¿ç§»è„šæœ¬**ï¼šä»»ä½•æ–°èœå•éƒ½åº”ä¼´éšæ•°æ®åº“è¿ç§»è„šæœ¬

## é˜²æ­¢å†æ¬¡å‘ç”Ÿ

### å»ºè®®1ï¼šå¼€å‘æµç¨‹è§„èŒƒ

**æ·»åŠ æ–°èœå•åŠŸèƒ½çš„æ ‡å‡†æµç¨‹**ï¼š

```
1. åœ¨ menuFeatures.ts ä¸­å®šä¹‰èœå•
   â†“
2. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
   â”œâ”€ INSERT INTO menu_features (...)
   â””â”€ ä¸ºç›¸å…³è§’è‰²åˆ†é…èœå•æƒé™
   â†“
3. æ‰§è¡Œè¿ç§»è„šæœ¬
   â†“
4. éªŒè¯å‰ç«¯å’Œæ•°æ®åº“ä¸€è‡´æ€§
   â†“
5. æµ‹è¯•æƒé™è®¾ç½®åŠŸèƒ½
```

---

### å»ºè®®2ï¼šæ·»åŠ å¯åŠ¨æ£€æŸ¥

**åœ¨åº”ç”¨å¯åŠ¨æ—¶éªŒè¯ä¸€è‡´æ€§**ï¼š

```typescript
// ä¼ªä»£ç 
async function validateMenuFeatures() {
  const frontendFeatures = MENU_FEATURES.map(f => f.id);
  const dbFeatures = await supabase
    .from('menu_features')
    .select('id');
  
  const missing = frontendFeatures.filter(
    f => !dbFeatures.includes(f)
  );
  
  if (missing.length > 0) {
    console.error('ç¼ºå¤±çš„èœå•åŠŸèƒ½:', missing);
    // å‘é€å‘Šè­¦æˆ–è‡ªåŠ¨åˆ›å»º
  }
}
```

---

### å»ºè®®3ï¼šè‡ªåŠ¨åŒ–è¿ç§»

**åœ¨éƒ¨ç½²æ—¶è‡ªåŠ¨åŒæ­¥**ï¼š

```sql
-- å¯ä»¥åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œè‡ªåŠ¨å°†å‰ç«¯å®šä¹‰çš„èœå•åŒæ­¥åˆ°æ•°æ®åº“
CREATE OR REPLACE FUNCTION sync_menu_features(
  feature_id TEXT,
  feature_name TEXT,
  feature_path TEXT,
  ...
) RETURNS VOID AS $$
BEGIN
  INSERT INTO menu_features (id, name, path, ...)
  VALUES (feature_id, feature_name, feature_path, ...)
  ON CONFLICT (id) DO UPDATE SET
    name = EXCLUDED.name,
    path = EXCLUDED.path,
    ...;
END;
$$ LANGUAGE plpgsql;
```

---

### å»ºè®®4ï¼šæ–‡æ¡£åŒ–

**åœ¨ README ä¸­æ˜ç¡®è¯´æ˜**ï¼š

```markdown
## æ·»åŠ æ–°èœå•åŠŸèƒ½

1. ä¿®æ”¹ `src/constants/menuFeatures.ts`
2. åˆ›å»ºè¿ç§»è„šæœ¬ `supabase-migrations/add-xxx-menu.sql`
3. æ‰§è¡Œè¿ç§»è„šæœ¬
4. æµ‹è¯•æƒé™è®¾ç½®
5. æäº¤ä»£ç å’Œè¿ç§»è„šæœ¬
```

## ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`src/constants/menuFeatures.ts`**
   - ä¸ºä¼šåŠ¡å®¢æœæ·»åŠ  `schedule_management`

2. **`src/constants/permissions.ts`**
   - ä¼šåŠ¡å®¢æœæƒé™å·²åœ¨ä¹‹å‰æ·»åŠ ï¼ˆä¸éœ€è¦æ”¹åŠ¨ï¼‰

3. **`supabase-migrations/add-schedule-management-menu.sql`**
   - æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆæ–°å»ºï¼‰

### ç›¸å…³æ–‡æ¡£

1. **`docs/ä¼šåŠ¡å®¢æœç®€ç« è¯¾è¡¨æƒé™æ–¹æ¡ˆ.md`**
   - å®Œæ•´çš„æƒé™æ–¹æ¡ˆè¯´æ˜

2. **`docs/å®æ–½å®Œæˆ-ä¼šåŠ¡å®¢æœç®€ç« è¯¾è¡¨æƒé™.md`**
   - æƒé™å®æ–½ç»†èŠ‚

3. **`docs/ä¿®å¤-ä¼šåŠ¡å®¢æœæƒé™è®¾ç½®å¤±è´¥.md`**
   - æœ¬æ–‡æ¡£ï¼ˆé—®é¢˜ä¿®å¤è¯´æ˜ï¼‰

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„

**menu_features è¡¨**:
```sql
CREATE TABLE public.menu_features (
  id TEXT PRIMARY KEY,           -- èœå•åŠŸèƒ½ID
  name TEXT NOT NULL,            -- æ˜¾ç¤ºåç§°
  path TEXT NOT NULL,            -- è·¯ç”±è·¯å¾„
  icon TEXT,                     -- å›¾æ ‡
  description TEXT,              -- æè¿°
  required_permissions TEXT[],   -- æ‰€éœ€æƒé™
  display_order INTEGER,         -- æ˜¾ç¤ºé¡ºåº
  created_at TIMESTAMPTZ
);
```

**user_menu_access è¡¨**:
```sql
CREATE TABLE public.user_menu_access (
  user_id UUID REFERENCES user_profiles(id),
  menu_feature_id TEXT REFERENCES menu_features(id),  -- â† å¤–é”®
  enabled BOOLEAN,
  created_at TIMESTAMPTZ,
  PRIMARY KEY (user_id, menu_feature_id)
);
```

### å¤–é”®çº¦æŸ

```sql
menu_feature_id TEXT REFERENCES menu_features(id)
```

**ä½œç”¨**:
- ç¡®ä¿ `user_menu_access.menu_feature_id` å¿…é¡»åœ¨ `menu_features.id` ä¸­å­˜åœ¨
- é˜²æ­¢å¼•ç”¨ä¸å­˜åœ¨çš„èœå•åŠŸèƒ½
- **å‰¯ä½œç”¨**ï¼šå¦‚æœèœå•åŠŸèƒ½ä¸å­˜åœ¨ï¼Œæ’å…¥ä¼šå¤±è´¥

## æ€»ç»“

### é—®é¢˜

âŒ æ•°æ®åº“ç¼ºå°‘ `schedule_management` å’Œ `announcement_management` è®°å½•  
âŒ ç®¡ç†å‘˜è®¾ç½®ä¼šåŠ¡å®¢æœæƒé™æ—¶è§¦å‘å¤–é”®çº¦æŸé”™è¯¯

### ä¿®å¤

âœ… æ‰§è¡ŒSQLè¿ç§»è„šæœ¬æ·»åŠ ç¼ºå¤±çš„èœå•åŠŸèƒ½è®°å½•  
âœ… æ›´æ–°å‰ç«¯é…ç½®ï¼Œä¸ºä¼šåŠ¡å®¢æœæ·»åŠ  `schedule_management` åˆ°é»˜è®¤èœå•  
âœ… è‡ªåŠ¨ä¸ºç°æœ‰ä¼šåŠ¡å®¢æœç”¨æˆ·åˆ†é…è¯¾è¡¨ç®¡ç†èœå•æƒé™

### å½±å“

âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸è®¾ç½®ä¼šåŠ¡å®¢æœæƒé™  
âœ… ä¼šåŠ¡å®¢æœå¯ä»¥è®¿é—®"è¯¾è¡¨ç®¡ç†"é¡µé¢  
âœ… ä¼šåŠ¡å®¢æœå¯ä»¥ä¸Šä¼ ã€ç¼–è¾‘ã€åˆ é™¤è‡ªå·±çš„è¯¾è¡¨  
âœ… ç³»ç»Ÿæƒé™è®¾ç½®åŠŸèƒ½æ¢å¤æ­£å¸¸

### é¢„é˜²

- ğŸ“‹ å»ºç«‹æ·»åŠ æ–°èœå•çš„æ ‡å‡†æµç¨‹
- ğŸ” æ·»åŠ åº”ç”¨å¯åŠ¨æ—¶çš„ä¸€è‡´æ€§æ£€æŸ¥
- ğŸ¤– è€ƒè™‘è‡ªåŠ¨åŒ–è¿ç§»æœºåˆ¶
- ğŸ“š å®Œå–„å¼€å‘æ–‡æ¡£

## ç‰ˆæœ¬å†å²

- **v1.0** (2025-11-16): é—®é¢˜åˆ†æå’Œä¿®å¤æ–¹æ¡ˆ
- **v1.1** (2025-11-16): å®Œå–„SQLè¿ç§»è„šæœ¬
- **v1.2** (2025-11-16): æ·»åŠ éªŒè¯æ­¥éª¤å’Œé¢„é˜²æªæ–½
