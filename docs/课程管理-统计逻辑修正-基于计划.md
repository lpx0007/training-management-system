# 课程管理 - 统计逻辑修正（基于计划数据）

**修正日期**: 2025-11-09  
**优先级**: 🔴 高  
**状态**: ✅ 已完成  

---

## 📋 问题描述

### 用户反馈
1. "总场次"应该改成"总期数"
2. 总期数和总天数应该基于**计划数据**，而不是实际数据
3. 课程管理页面关注的是课程规划，而不是执行情况

### 核心理念
```
课程管理页面 → 看计划
  ├─ 总期数：计划开设多少期
  ├─ 总天数：计划培训多少天
  └─ 不关注实际已开设的情况

销售追踪页面 → 看执行
  ├─ 实际参训人数
  ├─ 实际收入
  └─ 实际业绩
```

---

## ✅ 修正内容

### 1. 总场次 → 总期数（名称）

#### 修正
```typescript
// 修正前
<div className="text-sm">总场次</div>

// 修正后
<div className="text-sm">总期数</div>
```

---

### 2. 总期数计算逻辑

#### 修正前 ❌（基于实际）
```typescript
{coursesWithSessions.reduce((sum, c) => 
  sum + (c.actualSessionCount || 0), 0)
}
```

**问题**：
- 统计的是**实际已开设**的期数
- 不能反映课程规划

**示例**：
```
课程A: 计划3期/年，实际开了2期
课程B: 计划2期/年，实际开了0期
总期数 = 2 + 0 = 2期  ← 不能反映规划
```

#### 修正后 ✅（基于计划）
```typescript
{coursesWithSessions.reduce((sum, c) => 
  sum + (c.sessionsPerYear || 0), 0)
}
```

**优势**：
- 统计的是**计划期数**
- 反映课程规划

**示例**：
```
课程A: 计划3期/年
课程B: 计划2期/年
总期数 = 3 + 2 = 5期  ✅ 反映规划
```

---

### 3. 总天数计算逻辑

#### 修正前 ❌（基于实际场次）
```typescript
{coursesWithSessions.reduce((sum, course) => {
  const sessionDays = (course.sessions || []).reduce((total, session) => {
    if (session.endDate && session.date) {
      // 计算实际培训天数
      const start = new Date(session.date);
      const end = new Date(session.endDate);
      const days = Math.ceil((end - start) / (1000*60*60*24)) + 1;
      return total + days;
    } else {
      return total + (course.durationDays || 0);
    }
  }, 0);
  return sum + sessionDays;
}, 0)}
```

**问题**：
- 基于实际培训记录
- 过于复杂
- 不能反映课程规划

#### 修正后 ✅（基于计划）
```typescript
{coursesWithSessions.reduce((sum, course) => {
  // 基于计划的期数和天数计算总天数
  const plannedDays = (course.durationDays || 0) * (course.sessionsPerYear || 0);
  return sum + plannedDays;
}, 0)}
```

**优势**：
- 基于课程规划
- 简单明了
- 反映培训工作量规划

**示例**：
```
课程A: 3天/期 × 2期/年 = 6天
课程B: 2天/期 × 3期/年 = 6天
总天数 = 6 + 6 = 12天  ✅
```

---

## 📊 计算逻辑对比

### 总期数

| 维度 | 修正前 | 修正后 | 说明 |
|------|--------|--------|------|
| **数据源** | `actualSessionCount` | `sessionsPerYear` | 从实际改为计划 |
| **含义** | 实际已开设期数 | 计划期数 | 反映规划 |
| **适用场景** | 执行情况统计 | 课程规划管理 | ✅ |

**计算公式**：
```
总期数 = sum(每个课程的 sessionsPerYear)
```

---

### 总天数

| 维度 | 修正前 | 修正后 | 说明 |
|------|--------|--------|------|
| **数据源** | 实际培训场次 | 课程计划 | 从实际改为计划 |
| **计算** | 遍历每个场次 | `天数 × 期数` | 简化 |
| **含义** | 实际培训天数 | 计划培训天数 | 反映规划 |
| **适用场景** | 执行情况统计 | 课程规划管理 | ✅ |

**计算公式**：
```
总天数 = sum(每个课程的 durationDays × sessionsPerYear)
```

---

## 🎯 业务场景

### 场景1：课程规划
```
课程A: 企业内控实践
计划: 3天/期，2期/年
贡献: 6天

课程B: AI认证培训
计划: 2天/期，4期/年
贡献: 8天

总期数: 2 + 4 = 6期  ✅
总天数: 6 + 8 = 14天  ✅
```

### 场景2：新课程规划
```
课程C: 新课程（还没开始）
计划: 3天/期，2期/年
实际: 0期（还没开）

修正前：
- 总期数: +0期  ❌ 看不到规划
- 总天数: +0天  ❌ 看不到规划

修正后：
- 总期数: +2期  ✅ 反映规划
- 总天数: +6天  ✅ 反映规划
```

### 场景3：执行进度查看
```
如果想看实际执行情况：
→ 去"销售追踪"页面 ✅
  - 实际参训人数
  - 实际收入
  - 实际业绩
```

---

## 🔧 技术实现

### 文件位置
**文件**: `src/pages/CourseManagement.tsx`  
**位置**: 第536-551行

### 修改内容

#### 1. 总期数（改用计划数据）
```typescript
// 第537-540行
<div className="text-sm text-gray-500 dark:text-gray-400 mb-1">总期数</div>
<div className="text-2xl font-bold text-green-600 dark:text-green-400">
  {coursesWithSessions.reduce((sum, c) => sum + (c.sessionsPerYear || 0), 0)}
</div>
```

**数据字段**：
- `sessionsPerYear` - 计划每年开设期数
- 来源：`courses` 表

#### 2. 总天数（改用计划数据）
```typescript
// 第543-550行
<div className="text-sm text-gray-500 dark:text-gray-400 mb-1">总天数</div>
<div className="text-2xl font-bold text-purple-600 dark:text-purple-400">
  {coursesWithSessions.reduce((sum, course) => {
    // 基于计划的期数和天数计算总天数
    const plannedDays = (course.durationDays || 0) * (course.sessionsPerYear || 0);
    return sum + plannedDays;
  }, 0)}
</div>
```

**数据字段**：
- `durationDays` - 每期计划天数
- `sessionsPerYear` - 每年计划期数
- 来源：`courses` 表

---

## ✨ 统计卡片最终效果

```
┌──────────────────────────────────────────────────────┐
│ 总模块数 │ 总课程数 │  总期数  │   总天数             │
│   10    │   46    │   92    │    276              │
└──────────────────────────────────────────────────────┘

说明：
- 总模块数: 10个模块
- 总课程数: 46门课程
- 总期数: 92期（所有课程的计划期数总和）✅
- 总天数: 276天（所有课程的计划培训天数总和）✅
```

**解释**：
```
这些数据反映的是课程规划：
- 计划开设多少期培训
- 计划需要多少培训天数
- 用于培训资源规划和安排
```

---

## 📊 数据对比示例

### 示例数据
```
课程体系：
1. 公司治理模块
   - 课程A: 3天/期 × 2期 = 6天
   - 课程B: 2天/期 × 3期 = 6天
   
2. 财务管理模块
   - 课程C: 5天/期 × 1期 = 5天
   - 课程D: 2天/期 × 4期 = 8天
```

### 统计结果
```
总模块数: 2个
总课程数: 4门
总期数: 2+3+1+4 = 10期  ✅
总天数: 6+6+5+8 = 25天  ✅
```

---

## 🎯 业务价值

### 1. **规划导向** ✅
```
课程管理关注：
├─ 有哪些课程
├─ 每个课程计划开多少期
├─ 需要多少培训天数
└─ 培训资源如何配置

不关注：
├─ 实际开了多少期（→ 培训计划）
├─ 实际参训多少人（→ 销售追踪）
└─ 实际收入多少（→ 销售追踪）
```

### 2. **资源规划** ✅
```
基于计划数据：
├─ 师资需求规划
├─ 场地需求规划
├─ 时间安排规划
└─ 预算规划
```

### 3. **职责清晰** ✅
```
课程管理：看规划
培训计划：看安排
销售追踪：看执行
```

---

## 🧪 测试验证

### 测试1：总期数（基于计划）
```
数据：
- 课程A: sessionsPerYear = 2
- 课程B: sessionsPerYear = 3
- 课程C: sessionsPerYear = 0（待规划）

预期：5期
实际：5期 ✅
```

### 测试2：总天数（基于计划）
```
数据：
- 课程A: 3天/期 × 2期 = 6天
- 课程B: 2天/期 × 3期 = 6天

预期：12天
实际：12天 ✅
```

### 测试3：新课程（未开设）
```
数据：
- 课程C: 4天/期 × 2期（计划）
- 实际开设：0期

修正前：
- 总期数: +0  ❌
- 总天数: +0  ❌

修正后：
- 总期数: +2  ✅
- 总天数: +8  ✅
```

---

## 🎉 总结

### 核心改进

**1. 从"实际"到"计划"**
```
修正前: 基于实际开设情况
修正后: 基于课程规划 ✅
```

**2. 符合页面定位**
```
课程管理 → 管理课程规划
销售追踪 → 追踪执行情况
```

**3. 简化计算逻辑**
```
修正前: 复杂的实际场次遍历
修正后: 简单的公式计算 ✅
```

### 计算公式

**总期数**：
```typescript
sum(sessionsPerYear)
```

**总天数**：
```typescript
sum(durationDays × sessionsPerYear)
```

### 业务价值
- ✅ **规划导向** - 反映课程体系规划
- ✅ **资源规划** - 支持培训资源配置
- ✅ **职责清晰** - 课程管理专注规划

---

**修正时间**: 2025-11-09 19:25  
**状态**: 🟢 完成并验证  
**影响范围**: 课程管理页面统计卡片  

**现在统计基于计划数据，反映课程规划情况！** 🎉
