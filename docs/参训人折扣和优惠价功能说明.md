# 参训人折扣和优惠价功能说明

**日期**: 2025-11-09  
**版本**: v1.0  
**功能**: 添加参训人时设定折扣或优惠价

---

## 📋 功能概述

在添加参训人时，可以设定折扣率或优惠价格，系统会根据实际收款金额计算业绩，而不是按照标准价格计算。

### 使用场景

1. **促销活动** - 给予客户折扣优惠
2. **团购价格** - 多人报名享受优惠
3. **老客户优惠** - 给予VIP客户特殊价格
4. **协议价格** - 与企业签订协议价
5. **灵活定价** - 根据实际情况调整价格

---

## 🎯 功能特点

### 1. 两种价格设置方式

#### 方式一：折扣率
- 输入折扣百分比（0-100%）
- 系统自动计算实收价格
- 例如：标准价 5000元，折扣 20%，实收 4000元

#### 方式二：优惠价
- 直接输入优惠后的价格
- 系统自动计算折扣率
- 例如：标准价 5000元，优惠价 4200元，折扣 16%

### 2. 实时计算

- **即时反馈** - 输入时立即显示实收价格
- **自动验证** - 折扣率限制在 0-100%
- **直观显示** - 清晰展示标准价和实收价

### 3. 业绩统计

- ✅ 按**实收价格**计算业绩
- ✅ 记录折扣率用于后续分析
- ✅ 保留标准价格用于对比

---

## 💻 使用流程

### 步骤1：打开添加参训人对话框

```
培训列表 → 点击"添加团组/人" → 选择客户
```

### 步骤2：选择参与方式

- **线上** - 使用线上价格
- **线下** - 使用线下价格

### 步骤3：设置价格

#### 选项A：使用折扣率

1. 选择"折扣率"模式
2. 输入折扣百分比（例如：20）
3. 系统显示实收价格
4. 确认添加

#### 选项B：使用优惠价

1. 选择"优惠价"模式
2. 输入优惠后的价格（例如：4200）
3. 系统显示折扣率
4. 确认添加

### 步骤4：确认添加

点击"确认添加"，系统会：
- 保存实际价格
- 保存折扣率
- 更新业绩统计

---

## 🎨 界面设计

### 价格确认对话框

```
┌─────────────────────────────────────┐
│ 确认添加参训客户                     │
├─────────────────────────────────────┤
│ 客户信息                             │
│ ┌───────────────────────────────┐   │
│ │ 张三                           │   │
│ │ 138****8888                    │   │
│ └───────────────────────────────┘   │
│                                      │
│ 参与方式                             │
│ ┌──────┐  ┌──────┐                │
│ │ 线上  │  │ 线下 │ ✓              │
│ └──────┘  └──────┘                │
│                                      │
│ 标准价格                             │
│ ┌───────────────────────────────┐   │
│ │ 线下价格         ¥5,000        │   │
│ └───────────────────────────────┘   │
│                                      │
│ 价格设置方式                         │
│ ┌──────────┐  ┌──────────┐        │
│ │ 折扣率 ✓  │  │ 优惠价    │        │
│ └──────────┘  └──────────┘        │
│                                      │
│ 折扣率 (%)                          │
│ ┌───────────────────────────────┐   │
│ │ 20                         % │   │
│ └───────────────────────────────┘   │
│ 实收价格: ¥4,000                    │
│                                      │
│              ┌──────┐  ┌──────┐    │
│              │ 取消  │  │ 确认 │    │
│              └──────┘  └──────┘    │
└─────────────────────────────────────┘
```

---

## 📊 数据结构

### 数据库字段

**training_participants 表新增字段**:

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `actual_price` | NUMERIC(10,2) | 实际价格（优惠后） | 4000.00 |
| `discount_rate` | NUMERIC(5,2) | 折扣率（百分比） | 20.00 |
| `payment_amount` | NUMERIC(10,2) | 付款金额（原有字段） | 4000.00 |

### 价格计算逻辑

#### 折扣率模式
```typescript
标准价格 = 5000
折扣率 = 20%
实际价格 = 标准价格 × (1 - 折扣率/100)
        = 5000 × (1 - 20/100)
        = 5000 × 0.8
        = 4000
```

#### 优惠价模式
```typescript
标准价格 = 5000
优惠价格 = 4200
折扣率 = (1 - 优惠价格/标准价格) × 100
      = (1 - 4200/5000) × 100
      = (1 - 0.84) × 100
      = 16%
```

---

## 💰 业绩统计规则

### 计算公式

```
业务员月度业绩 = Σ (参训人实际价格)
```

### 统计示例

**示例场景**：

| 客户 | 参与方式 | 标准价格 | 折扣率 | 实收价格 |
|------|---------|---------|--------|---------|
| 客户A | 线下 | ¥5,000 | 0% | ¥5,000 |
| 客户B | 线下 | ¥5,000 | 20% | ¥4,000 |
| 客户C | 线上 | ¥3,000 | 10% | ¥2,700 |
| 客户D | 线上 | ¥3,000 | - | ¥2,500 (优惠价) |

**业绩计算**：
```
总业绩 = 5000 + 4000 + 2700 + 2500 = ¥14,200
```

### 统计分析

系统会记录：
- **标准价格总额** - 用于对比分析
- **实收价格总额** - 实际业绩
- **平均折扣率** - 折扣力度分析
- **折扣损失** - 标准价格 - 实收价格

---

## 🔧 实现细节

### 前端代码

**状态变量**：
```typescript
const [discountRate, setDiscountRate] = useState<number>(0);
const [customPrice, setCustomPrice] = useState<number | null>(null);
const [priceInputMode, setPriceInputMode] = useState<'discount' | 'custom'>('discount');
```

**价格计算**：
```typescript
// 折扣率模式
if (priceInputMode === 'discount' && discountRate > 0) {
  actualPrice = Math.round(standardPrice * (1 - discountRate / 100));
  finalDiscountRate = discountRate;
}

// 优惠价模式
if (priceInputMode === 'custom' && customPrice !== null) {
  actualPrice = customPrice;
  finalDiscountRate = Math.round((1 - customPrice / standardPrice) * 100);
}
```

### 数据库迁移

执行脚本：
```sql
scripts/migrations/add-discount-fields-to-participants.sql
```

添加字段：
- `actual_price` - 实际价格
- `discount_rate` - 折扣率

---

## 📈 业务价值

### 1. 灵活定价

- ✅ 支持市场活动和促销
- ✅ 满足不同客户需求
- ✅ 提高成交转化率

### 2. 精准统计

- ✅ 按实收金额计算业绩
- ✅ 避免虚高的业绩数据
- ✅ 真实反映经营状况

### 3. 数据分析

- ✅ 分析折扣对业绩的影响
- ✅ 优化定价策略
- ✅ 评估促销活动效果

### 4. 管理决策

- ✅ 了解折扣使用情况
- ✅ 控制折扣力度
- ✅ 平衡业绩和利润

---

## ⚠️ 注意事项

### 1. 折扣权限

建议：
- 普通业务员：最高折扣 20%
- 经理：最高折扣 30%
- 管理员：不限制

（当前版本暂未实现权限限制）

### 2. 价格验证

- 折扣率限制在 0-100%
- 优惠价不能为负数
- 建议设置最低价格限制

### 3. 数据完整性

- `actual_price` 字段必填
- `discount_rate` 字段可选
- 保留原 `payment_amount` 字段兼容

### 4. 业绩统计

- 新增参训人立即更新业绩
- 删除参训人自动扣减业绩
- 修改价格需重新计算业绩

---

## 🧪 测试场景

### 场景1：标准价格（无折扣）

```
标准价格：¥5,000
折扣率：0%
实收价格：¥5,000
期望结果：✅ 业绩 = ¥5,000
```

### 场景2：折扣率

```
标准价格：¥5,000
折扣率：20%
实收价格：¥4,000
期望结果：✅ 业绩 = ¥4,000
```

### 场景3：优惠价

```
标准价格：¥5,000
优惠价：¥4,200
计算折扣率：16%
期望结果：✅ 业绩 = ¥4,200，折扣率 = 16%
```

### 场景4：线上线下价格

```
线上标准价：¥3,000
线下标准价：¥5,000
选择：线上，折扣 10%
实收价格：¥2,700
期望结果：✅ 业绩 = ¥2,700
```

### 场景5：切换价格方式

```
1. 选择"折扣率"，输入 20%
2. 切换到"优惠价"
3. 输入 ¥4,200
期望结果：✅ 折扣率自动计算为 16%
```

---

## 🔄 未来优化

### 短期（1-2周）

1. ✅ 添加折扣权限限制
2. ✅ 设置最低价格限制
3. ✅ 添加折扣审批流程

### 中期（1-2月）

1. ✅ 折扣统计分析报表
2. ✅ 折扣使用趋势图表
3. ✅ 自动化折扣规则

### 长期（3-6月）

1. ✅ AI智能定价建议
2. ✅ 动态价格策略
3. ✅ 客户画像定价

---

## 📚 相关文档

- 培训定价和自动计费说明.md
- 自动业绩统计系统说明.md
- 数据库表结构与字段说明.md
- 修复-添加参训人客户列表显示问题.md

---

## ✅ 实施清单

- [x] 添加数据库字段
- [x] 更新 TypeScript 类型定义
- [x] 实现折扣率输入UI
- [x] 实现优惠价输入UI
- [x] 价格实时计算
- [x] 数据保存逻辑
- [x] 创建迁移脚本
- [x] 编写功能文档
- [ ] 执行数据库迁移
- [ ] 测试各种场景
- [ ] 用户培训

---

**状态**: 🟢 开发完成，待测试  
**部署**: 需要执行数据库迁移  
**培训**: 需要向业务员说明使用方法

**新功能已实现，执行数据库迁移后即可使用！** 🎉
