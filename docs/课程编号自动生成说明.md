# 课程编号自动生成说明

**日期**: 2025-11-08  
**版本**: v1.2  
**功能**: 课程编号自动生成 + 移除均价字段

---

## 📋 变更概述

### 1. 课程编号自动生成 ⭐

**变更前**：
- 用户需要手动输入课程编号
- 可能出现重复或格式不统一

**变更后**：
- ✅ 系统自动生成唯一编号
- ✅ 格式统一：`C-0001`, `C-0002`, `C-0003`...
- ✅ 基于数据库ID生成，确保唯一性
- ✅ 编辑模式下显示但不可修改

### 2. 移除均价字段

**原因**: 均价是内部测算用的字段，不需要用户输入

**变更**：
- ❌ 表单中移除"均价"输入框
- ✅ 数据库保留字段（用于内部计算）
- ✅ 不影响现有数据

---

## 🔧 技术实现

### 前端变更

#### CourseFormModal.tsx
```typescript
// 1. 移除表单状态中的 average_price
const [formData, setFormData] = useState({
  module: '',
  name: '',
  code: '',  // 保留字段但不显示输入框
  duration_days: 0,
  sessions_per_year: 0,
  standard_fee: 0,
  online_price: null,
  offline_price: null,
  // average_price: null,  // 已移除
  description: '',
  notes: '',
  status: 'active'
});

// 2. 课程编号仅在编辑模式下显示（只读）
{mode === 'edit' && (
  <div>
    <label>课程编号</label>
    <input
      value={formData.code}
      disabled
      readOnly
      className="bg-gray-50 text-gray-500 cursor-not-allowed"
    />
    <p className="text-xs text-gray-500">
      编号由系统自动生成，不可修改
    </p>
  </div>
)}

// 3. 提交时不包含 average_price 和 code（添加模式）
const submitData = {
  ...formData,
  description: formData.description.trim() || null,
  notes: formData.notes.trim() || null,
  online_price: formData.online_price || null,
  offline_price: formData.offline_price || null
  // 不包含 average_price
};

// 添加模式不传code，由后端自动生成
if (mode === 'edit') {
  submitData.code = formData.code;
}
```

### 后端变更

#### courseService.ts - createCourse()
```typescript
async createCourse(courseData) {
  // 1. 准备数据（不包含code和average_price）
  const dbData = {
    module: courseData.module,
    name: courseData.name,
    duration_days: courseData.duration_days,
    sessions_per_year: courseData.sessions_per_year,
    standard_fee: courseData.standard_fee,
    online_price: courseData.online_price || null,
    offline_price: courseData.offline_price || null,
    description: courseData.description || null,
    notes: courseData.notes || null,
    status: courseData.status || 'active'
  };
  
  // 2. 移除code字段
  delete dbData.code;
  
  // 3. 插入课程（不含code）
  const { data, error } = await supabase
    .from('courses')
    .insert(dbData)
    .select()
    .single();
  
  if (error) throw error;
  
  // 4. 生成唯一编号：C-0001, C-0002...
  const courseId = data.id;
  const generatedCode = `C-${courseId.toString().padStart(4, '0')}`;
  
  // 5. 更新课程编号
  const { data: updatedData, error: updateError } = await supabase
    .from('courses')
    .update({ code: generatedCode })
    .eq('id', courseId)
    .select()
    .single();
  
  return updatedData;
}
```

---

## 📊 编号格式说明

### 格式规则
```
C-0001  → 第1个课程
C-0002  → 第2个课程
C-0010  → 第10个课程
C-0099  → 第99个课程
C-0100  → 第100个课程
C-1000  → 第1000个课程
```

### 特点
- ✅ **前缀**: 固定为 `C-`（Course）
- ✅ **编号**: 4位数字，不足补0
- ✅ **唯一性**: 基于数据库自增ID
- ✅ **可读性**: 格式统一，易于识别
- ✅ **扩展性**: 支持最多9999个课程

### 示例
| 课程ID | 生成编号 | 课程名称 |
|--------|----------|----------|
| 1 | C-0001 | 财务报表分析 |
| 25 | C-0025 | 成本管理 |
| 150 | C-0150 | 税务筹划 |
| 2500 | C-2500 | 战略管理 |

---

## 🎯 用户体验变化

### 添加课程时

**原流程**：
1. 选择模块
2. 输入课程名称
3. **手动输入课程编号** ❌
4. 输入天数、期数
5. 输入价格信息
6. 保存

**新流程**：
1. 选择模块
2. 输入课程名称
3. ~~输入课程编号~~ **系统自动生成** ✅
4. 输入天数、期数
5. 输入价格信息
6. 保存

### 编辑课程时

- ✅ 编号字段显示为灰色只读状态
- ✅ 鼠标悬停显示禁止符号
- ✅ 提示文字："编号由系统自动生成，不可修改"

### 表单简化

**移除字段**：
- ❌ 课程编号输入框（添加模式）
- ❌ 均价输入框

**保留字段**：
- ✅ 课程模块（必填）
- ✅ 课程名称（必填）
- ✅ 每期天数（必填）
- ✅ 全年期数（必填）
- ✅ 标准费用（必填）
- ✅ 线上价格（选填）
- ✅ 线下价格（选填）
- ✅ 课程描述（选填）
- ✅ 备注（选填）
- ✅ 状态

---

## 🧪 测试场景

### 测试1: 添加新课程

**步骤**：
1. 点击"添加课程"按钮
2. 观察表单字段

**预期结果**：
- ✅ 不显示"课程编号"输入框
- ✅ 不显示"均价"输入框
- ✅ 其他字段正常显示

**操作**：
3. 填写必填字段
4. 点击保存

**预期结果**：
- ✅ 保存成功
- ✅ 自动生成编号（如：C-0047）
- ✅ 课程列表中显示新课程及编号

**SQL验证**：
```sql
SELECT id, code, name, average_price 
FROM courses 
ORDER BY id DESC 
LIMIT 1;
```

### 测试2: 编辑现有课程

**步骤**：
1. 点击任意课程的"编辑"按钮
2. 观察"课程编号"字段

**预期结果**：
- ✅ 显示编号字段（只读）
- ✅ 背景为灰色
- ✅ 鼠标显示禁止符号
- ✅ 提示文字正确显示

**操作**：
3. 尝试修改编号（应无法修改）
4. 修改其他字段
5. 点击保存

**预期结果**：
- ✅ 编号不变
- ✅ 其他字段更新成功

### 测试3: 编号唯一性

**步骤**：
1. 添加3个新课程
2. 查看生成的编号

**预期结果**：
- ✅ 编号连续（如：C-0047, C-0048, C-0049）
- ✅ 无重复
- ✅ 格式统一

**SQL验证**：
```sql
-- 检查是否有重复编号
SELECT code, COUNT(*) 
FROM courses 
WHERE code LIKE 'C-%'
GROUP BY code 
HAVING COUNT(*) > 1;

-- 应返回0行，表示无重复
```

### 测试4: 现有数据兼容性

**步骤**：
1. 查询旧数据（导入的46个课程）
2. 编辑任意旧课程

**预期结果**：
- ✅ 旧编号保持不变
- ✅ 可以正常编辑其他字段
- ✅ 保存后编号不变

**SQL验证**：
```sql
-- 查看不同编号格式
SELECT 
  CASE 
    WHEN code LIKE 'C-%' THEN '新格式'
    ELSE '旧格式'
  END as format,
  COUNT(*) 
FROM courses 
GROUP BY format;
```

---

## 📝 数据库影响

### courses表结构
```sql
CREATE TABLE courses (
  id SERIAL PRIMARY KEY,
  module VARCHAR(100) NOT NULL,
  name VARCHAR(255) NOT NULL,
  code VARCHAR(50) UNIQUE,  -- 保留字段，自动生成
  duration_days INTEGER NOT NULL,
  sessions_per_year INTEGER NOT NULL,
  standard_fee DECIMAL(10, 2),
  online_price DECIMAL(10, 2),
  offline_price DECIMAL(10, 2),
  average_price DECIMAL(10, 2),  -- 保留但不在表单中显示
  description TEXT,
  notes TEXT,
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 影响分析

#### 无影响
- ✅ 现有数据完整保留
- ✅ 数据库结构不变
- ✅ 旧编号继续有效
- ✅ 导入的46个课程正常

#### 变化点
- 🔄 新课程使用新格式编号（C-XXXX）
- 🔄 average_price字段保留但不再从表单输入
- 🔄 前端验证逻辑简化

---

## 🎨 UI变化对比

### 添加课程表单

**旧版本**（11个字段）：
```
[课程模块 *]
[课程名称 *]
[课程编号 *]  ← 需要手动输入
[每期天数 *] [全年期数 *]
[标准费用 *]
[线上价格] [线下价格]
[均价]  ← 需要手动输入
[课程描述]
[备注]
[状态]
```

**新版本**（9个字段）：
```
[课程模块 *]
[课程名称 *]
              ← 课程编号自动生成
[每期天数 *] [全年期数 *]
[标准费用 *]
[线上价格] [线下价格]
              ← 均价已移除
[课程描述]
[备注]
[状态]
```

### 编辑课程表单

**新版本**（10个字段）：
```
[课程模块 *]
[课程名称 *]
[课程编号] 🔒 只读 - 系统自动生成
[每期天数 *] [全年期数 *]
[标准费用 *]
[线上价格] [线下价格]
              ← 均价已移除
[课程描述]
[备注]
[状态]
```

---

## 💡 优势和好处

### 1. 操作简化
- ✅ 减少2个输入字段
- ✅ 表单更简洁
- ✅ 填写更快捷

### 2. 数据质量
- ✅ 消除编号重复风险
- ✅ 格式完全统一
- ✅ 避免输入错误

### 3. 维护便利
- ✅ 编号规则集中管理
- ✅ 易于调整格式
- ✅ 自动化减少人工

### 4. 扩展性
- ✅ 支持前缀自定义（未来）
- ✅ 支持编号规则变更
- ✅ 支持模块前缀（如需要）

---

## 🚀 未来优化建议

### 可选增强功能

#### 1. 编号前缀自定义
```
管理会计 → MA-0001
公司金融 → CF-0001
税务管理 → TM-0001
```

#### 2. 按模块独立编号
```
管理会计：MA-0001, MA-0002...
公司金融：CF-0001, CF-0002...
```

#### 3. 年份前缀
```
2025年课程：2025-C-0001
2026年课程：2026-C-0001
```

#### 4. 编号查询优化
- 支持按编号快速搜索
- 编号历史记录
- 编号统计分析

---

## 📞 支持信息

### 常见问题

**Q: 旧课程的编号会被改变吗？**  
A: 不会。旧编号保持不变，只有新添加的课程使用新格式。

**Q: 如果需要自定义编号怎么办？**  
A: 当前版本不支持。如有需要，请联系管理员。

**Q: 均价数据还在数据库中吗？**  
A: 是的，数据保留，只是表单中不再显示。

**Q: 可以批量修改编号吗？**  
A: 不建议。编号是系统自动生成的唯一标识。

**Q: 编号达到9999后怎么办？**  
A: 系统会自动支持更多位数（C-10000, C-10001...）

---

**文档版本**: v1.2  
**最后更新**: 2025-11-08  
**维护人员**: 开发团队  
**状态**: ✅ 已实施并测试
