# 培训删除和恢复功能完整说明

**最后更新**: 2025-11-09  
**状态**: ✅ 已完成并部署到生产数据库  
**整合位置**: 审计日志页面 (`/audit-logs`)

---

## 📊 功能总览

本系统提供了**两种删除方式**和**对应的恢复机制**，满足不同的删除需求：

### 删除方式对比

| 特性 | 临时删除（软删除）| 彻底删除（硬删除+备份）|
|------|------------------|---------------------|
| **数据位置** | 主表（标记） | 备份表 |
| **业绩影响** | 不影响 ✅ | 清除统计 |
| **可见性** | 管理员可见 ✅ | 仅在备份表 |
| **恢复难度** | 一键恢复 ✅ | 需数据库操作 |
| **推荐场景** | 日常删除 ✅ | 测试数据清理 |

---

## 1️⃣ 临时删除（软删除）- 推荐方式 ⭐

### 工作原理

```
1. 点击删除按钮
2. 选择"临时删除（可恢复）"
3. 输入删除原因（可选）
4. 确认
         ↓
5. 设置 deleted_at = NOW()
6. 记录删除人和原因
7. **培训和参训记录保持不变**
8. **业绩数据完全保留**
         ↓
9. 普通用户看不到
10. 管理员可见（在回收站）
11. 可一键恢复
```

### 数据位置

**表**: `training_sessions`（主表）  
**查询条件**: `deleted_at IS NOT NULL`

**查询 SQL**:
```sql
-- 查看所有临时删除的培训
SELECT 
  id,
  name,
  date,
  end_date,
  participants,
  deleted_at,
  deleted_by_name,
  delete_reason
FROM training_sessions
WHERE deleted_at IS NOT NULL
ORDER BY deleted_at DESC;
```

### 恢复方法

#### 方式 A：通过管理界面（推荐）✅

1. **访问**: 导航至 "已删除的培训" 页面
2. **Tab**: 选择 "临时删除（可恢复）"
3. **找到培训**: 浏览或搜索要恢复的培训
4. **点击恢复**: 点击绿色 "恢复" 按钮
5. **确认**: 确认恢复操作
6. **完成**: 培训重新出现在列表中

**页面路径**: `/deleted-trainings`

#### 方式 B：通过数据库 SQL

```sql
-- 恢复 ID=2 的培训
UPDATE training_sessions 
SET deleted_at = NULL,
    deleted_by = NULL,
    deleted_by_name = NULL,
    delete_reason = NULL
WHERE id = 2
RETURNING id, name;
```

**恢复结果**:
- ✅ 培训重新出现在列表中
- ✅ 所有参训记录保留
- ✅ 业绩数据完整
- ✅ 历史数据不受影响

### 永久删除（从回收站）

在回收站中，您也可以选择**永久删除**临时删除的培训：

1. 在"临时删除（可恢复）"Tab 中
2. 点击红色"永久删除"按钮
3. 确认后将执行**彻底删除+备份**
4. 数据移至备份表

---

## 2️⃣ 彻底删除（硬删除 + 自动备份）

### 工作原理

```
1. 点击删除按钮
2. 选择"彻底删除（不可恢复）"
3. 输入删除原因（可选）
4. 确认
         ↓
5. **备份培训到 training_sessions_backup**
6. **备份参训记录到 training_participants_backup**
7. 删除主表的参训记录
8. 删除主表的培训记录
         ↓
9. 主表数据完全清除
10. 备份表保留完整副本
11. 业绩统计不再包含
12. 需要时可从备份恢复
```

### 备份数据位置

#### 培训场次备份表

**表名**: `training_sessions_backup`

**字段说明**:
```sql
backup_id         BIGSERIAL PRIMARY KEY  -- 备份记录ID
original_id       INTEGER                -- 原始培训ID
deleted_by        UUID                   -- 删除人ID
deleted_by_name   TEXT                   -- 删除人姓名
deleted_at        TIMESTAMP              -- 删除时间
delete_reason     TEXT                   -- 删除原因
can_restore       BOOLEAN                -- 是否可恢复

-- 原始培训数据（30个字段）
id, name, date, end_date, participants, capacity, revenue, ...
```

**查询 SQL**:
```sql
-- 查看所有备份的培训
SELECT 
  backup_id,
  original_id,
  name,
  date,
  end_date,
  participants,
  deleted_at,
  deleted_by_name,
  delete_reason,
  can_restore
FROM training_sessions_backup
WHERE can_restore = TRUE
ORDER BY deleted_at DESC;
```

**当前备份数据**:
```
backup_id: 1
original_id: 4
name: React 高级开发实战
date: 2025-11-05
end_date: 2025-11-07
participants: 0
deleted_at: 2025-11-09 14:15:46
deleted_by_name: 系统管理员
delete_reason: 管理员彻底删除
can_restore: true
```

#### 参训记录备份表

**表名**: `training_participants_backup`

**字段说明**:
```sql
backup_id           BIGSERIAL PRIMARY KEY  -- 备份记录ID
original_id         INTEGER                -- 原始参训记录ID
session_backup_id   BIGINT                 -- 关联的培训备份ID
deleted_by          UUID                   -- 删除人ID
deleted_at          TIMESTAMP              -- 删除时间

-- 原始参训数据（24个字段）
id, training_session_id, customer_id, name, phone, email, ...
payment_amount, actual_price, participation_mode, ...
```

**查询 SQL**:
```sql
-- 查看特定培训的所有参训记录备份
SELECT 
  bp.*,
  bs.name AS session_name
FROM training_participants_backup bp
JOIN training_sessions_backup bs ON bp.session_backup_id = bs.backup_id
WHERE bs.backup_id = 1
ORDER BY bp.backup_id;
```

### 查看备份汇总

**视图**: `v_backup_sessions_summary`

```sql
-- 查看备份汇总（包含参训人数和收入）
SELECT * FROM v_backup_sessions_summary;
```

**返回字段**:
- `backup_id` - 备份ID
- `original_id` - 原始培训ID
- `session_name` - 培训名称
- `session_date` - 培训日期
- `deleted_at` - 删除时间
- `deleted_by_name` - 删除人
- `delete_reason` - 删除原因
- `can_restore` - 是否可恢复
- `participants_count` - 参训人数
- `total_revenue` - 总收入

### 从备份恢复（高级操作）⚠️

**注意**: 从备份恢复需要谨慎操作，建议由数据库管理员执行。

```sql
-- ===== 恢复操作（3步） =====

-- Step 1: 恢复培训场次
INSERT INTO training_sessions 
  (id, course_id, course_name, session_number, name, date, end_date, 
   location, area, instructor, expert, salesperson_id, salesperson_name,
   training_mode, online_price, offline_price, participants, capacity, 
   revenue, status, description, created_at, updated_at)
SELECT 
  id, course_id, course_name, session_number, name, date, end_date,
  location, area, instructor, expert, salesperson_id, salesperson_name,
  training_mode, online_price, offline_price, participants, capacity,
  revenue, status, description, created_at, updated_at
FROM training_sessions_backup
WHERE backup_id = 1;

-- Step 2: 恢复参训记录
INSERT INTO training_participants
  (id, training_session_id, customer_id, name, phone, email, company, position,
   registration_date, payment_status, payment_amount, actual_price, 
   participation_mode, discount_rate, salesperson_name, notes, created_at, updated_at)
SELECT 
  id, training_session_id, customer_id, name, phone, email, company, position,
  registration_date, payment_status, payment_amount, actual_price,
  participation_mode, discount_rate, salesperson_name, notes, created_at, updated_at
FROM training_participants_backup
WHERE session_backup_id = 1;

-- Step 3: 标记为已恢复
UPDATE training_sessions_backup 
SET can_restore = FALSE 
WHERE backup_id = 1;
```

**验证恢复**:
```sql
-- 检查培训是否恢复
SELECT id, name, date FROM training_sessions WHERE id = 4;

-- 检查参训记录是否恢复
SELECT COUNT(*) FROM training_participants WHERE training_session_id = 4;
```

---

## 🎨 管理界面说明

### 审计日志页面 - 删除记录管理

**路径**: `/audit-logs`  
**权限**: 仅管理员可访问  
**文件**: `src/pages/AuditLogs.tsx`

#### 设计理念

将删除功能整合到审计日志页面，统一管理所有需要审计的关键操作：
- ✅ **简化菜单结构** - 不增加额外菜单项
- ✅ **符合业务逻辑** - 删除是需要审计的关键操作
- ✅ **统一管理** - 所有关键操作记录集中查看

#### 功能特性

**Tab 1: 关键操作**（预留）
- ⏳ 权限变更记录
- ⏳ 超权操作记录
- ⏳ 数据导出记录
- ⏳ 系统配置变更

**Tab 2: 已删除培训（可恢复）**
- ✅ 显示所有软删除的培训
- ✅ 显示删除时间、删除人、删除原因
- ✅ 一键恢复功能
- ✅ 永久删除功能（移至备份）
- ✅ 实时统计显示

**Tab 3: 备份数据**
- ✅ 显示所有彻底删除的培训备份
- ✅ 显示备份ID、原始ID
- ✅ 显示删除时间、删除人、删除原因
- ✅ 备份数据位置和恢复说明
- ✅ 数据库表引用提示

#### 使用步骤

1. **登录管理员账号**
2. **访问菜单**: 点击侧边栏中的"审计日志"
3. **选择 Tab**: 
   - "关键操作" - 查看系统关键操作日志（待开发）
   - "已删除培训（可恢复）" - 查看和恢复软删除的培训
   - "备份数据" - 查看彻底删除的备份数据
4. **恢复操作**:
   - 临时删除: 点击绿色"恢复"按钮即可
   - 彻底删除: 联系系统管理员通过数据库恢复
5. **永久删除**: 在已删除培训列表中点击红色"永久删除"按钮

---

## 🔐 权限说明

### RLS 策略

**备份表权限**（仅管理员）:
```sql
-- 只有 admin 可以查看备份数据
CREATE POLICY "Admin can view backup sessions"
ON training_sessions_backup
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM user_profiles
    WHERE user_profiles.id = auth.uid()
    AND user_profiles.role = 'admin'
  )
);

-- 只有 admin 可以插入备份数据
CREATE POLICY "Admin can insert backup sessions"
ON training_sessions_backup
FOR INSERT
WITH CHECK (
  EXISTS (
    SELECT 1 FROM user_profiles
    WHERE user_profiles.id = auth.uid()
    AND user_profiles.role = 'admin'
  )
);
```

### 功能权限

| 功能 | 管理员 | 业务员 | 专家 |
|------|-------|--------|------|
| **删除培训** | ✅ | ❌ | ❌ |
| **查看已删除** | ✅ | ❌ | ❌ |
| **恢复培训** | ✅ | ❌ | ❌ |
| **查看备份** | ✅ | ❌ | ❌ |

---

## 📊 数据库表结构

### 软删除字段（training_sessions 表）

```sql
-- 已添加的字段
deleted_at       TIMESTAMP NULL     -- 删除时间（NULL=未删除）
deleted_by       UUID NULL          -- 删除人ID
deleted_by_name  TEXT NULL          -- 删除人姓名
delete_reason    TEXT NULL          -- 删除原因

-- 索引
CREATE INDEX idx_training_sessions_deleted_at 
ON training_sessions(deleted_at);
```

### 备份表（training_sessions_backup）

```sql
-- 30 个字段
-- 主键: backup_id (自增)
-- 外键关系: 无（独立备份）
-- 索引: 4个（original_id, deleted_at, deleted_by, can_restore）
```

### 备份表（training_participants_backup）

```sql
-- 24 个字段
-- 主键: backup_id (自增)
-- 外键: session_backup_id -> training_sessions_backup(backup_id)
-- 索引: 4个（original_id, session_backup_id, deleted_at, salesperson_name）
```

---

## 🧪 测试场景

### 场景 1: 临时删除和恢复

```bash
# 1. 临时删除一个培训
DELETE: "微服务架构设计与实践"
  - 选择: 临时删除
  - 原因: 测试删除功能
  - 参训人: 1人

# 2. 验证数据
✅ 主列表看不到
✅ 回收站可见
✅ 参训记录保留
✅ 业绩不受影响

# 3. 恢复培训
RESTORE: 点击"恢复"按钮

# 4. 验证恢复
✅ 重新出现在列表
✅ 所有数据完整
✅ 业绩正常显示
```

### 场景 2: 彻底删除和备份

```bash
# 1. 彻底删除一个培训
DELETE: "React 高级开发实战"
  - 选择: 彻底删除
  - 原因: 测试数据清理
  - 参训人: 0人

# 2. 验证备份
✅ 主表数据已删除
✅ 备份表有记录
✅ backup_id = 1
✅ can_restore = true

# 3. 查看备份
SQL: SELECT * FROM v_backup_sessions_summary;
✅ 显示备份汇总
✅ 包含删除人和原因
```

---

## 💡 使用建议

### 何时使用临时删除？✅ 推荐

- ✅ 日常培训删除
- ✅ 误操作需要恢复的
- ✅ 可能重新启用的培训
- ✅ 需要保留业绩数据的
- ✅ 暂时隐藏但不确定的

### 何时使用彻底删除？⚠️ 谨慎

- ⚠️ 测试数据清理
- ⚠️ 重复创建的培训
- ⚠️ 数据错误需要清除
- ⚠️ 确定不再需要的培训
- ⚠️ 需要完全清除业绩记录的

### 最佳实践

1. **优先使用临时删除** ✅
   - 99% 的情况使用临时删除
   - 保护数据安全
   - 方便快速恢复

2. **定期清理回收站**
   - 每月检查临时删除的培训
   - 确认不需要的可永久删除
   - 释放存储空间

3. **备份数据管理**
   - 定期导出备份表
   - 保存到安全位置
   - 建立恢复流程

4. **权限控制**
   - 只允许管理员删除
   - 记录删除原因
   - 审计删除操作

---

## 🚀 快速参考

### SQL 快速查询

```sql
-- 1. 查看临时删除的培训
SELECT id, name, deleted_at, deleted_by_name, delete_reason
FROM training_sessions
WHERE deleted_at IS NOT NULL;

-- 2. 恢复临时删除的培训（ID=2）
UPDATE training_sessions 
SET deleted_at = NULL, deleted_by = NULL, 
    deleted_by_name = NULL, delete_reason = NULL
WHERE id = 2;

-- 3. 查看备份数据
SELECT * FROM v_backup_sessions_summary;

-- 4. 查看特定备份的详情
SELECT * FROM training_sessions_backup WHERE backup_id = 1;

-- 5. 查看备份的参训记录
SELECT * FROM training_participants_backup 
WHERE session_backup_id = 1;
```

### 页面快速访问

- **删除培训**: 培训管理 / 培训计划 → 点击🗑️图标
- **恢复培训**: 审计日志 → 已删除培训 Tab → 恢复按钮
- **查看备份**: 审计日志 → 备份数据 Tab
- **审计日志入口**: 侧边栏 → 审计日志菜单

---

## 📞 支持和帮助

### 常见问题

**Q: 误删了培训怎么办？**  
A: 如果使用的是临时删除，直接在"审计日志"页面的"已删除培训"Tab中点击"恢复"按钮即可。

**Q: 彻底删除的培训能恢复吗？**  
A: 可以，但需要通过数据库 SQL 操作从备份表恢复，建议联系技术人员。数据在"审计日志 → 备份数据"中可以查看。

**Q: 删除培训会影响业绩统计吗？**  
A: 临时删除不影响，彻底删除会清除业绩统计。

**Q: 备份数据会永久保存吗？**  
A: 是的，备份数据会一直保存在备份表中，除非手动删除。可以在"审计日志 → 备份数据"中查看所有备份。

**Q: 如何永久删除备份数据？**  
A: 需要直接操作数据库，删除 training_sessions_backup 和 training_participants_backup 表中的记录。

**Q: 为什么要整合到审计日志？**  
A: 删除操作是需要审计的关键操作，整合到审计日志页面可以统一管理，简化菜单结构，更符合业务逻辑。

---

**文档版本**: v1.0  
**创建日期**: 2025-11-09  
**最后更新**: 2025-11-09  
**维护人**: 系统管理员
