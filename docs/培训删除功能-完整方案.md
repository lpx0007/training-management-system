# 培训计划删除功能 - 双方案设计 v2.0

**日期**: 2025-11-09  
**优先级**: 🔴 高  

---

## 📋 用户需求

提供两种删除方式供管理员选择：

### 方案A：彻底删除 + 自动备份
- ✅ 彻底删除培训和所有参训记录
- ✅ 清除所有业绩数据
- ✅ **自动备份到数据库专用备份表**
- ✅ 需要时可从数据库恢复

### 方案B：软删除 + 管理员可见
- ✅ 只标记培训为已删除
- ✅ 保留所有参训记录和业绩
- ✅ **删除的记录在管理员界面可见**（标注"已删除"）
- ✅ 可随时一键恢复

---

## 🗄️ 数据库设计

### 备份表（方案A使用）

```sql
-- 培训场次备份表
CREATE TABLE training_sessions_backup (
  backup_id BIGSERIAL PRIMARY KEY,
  original_id INTEGER NOT NULL,
  
  -- 原始数据（所有字段）
  id INTEGER,
  name TEXT,
  date DATE,
  end_date DATE,
  participants INTEGER,
  revenue NUMERIC(10,2),
  -- ... 其他所有字段
  
  -- 备份元数据
  deleted_by UUID,
  deleted_by_name TEXT,
  deleted_at TIMESTAMP DEFAULT NOW(),
  delete_reason TEXT,
  can_restore BOOLEAN DEFAULT TRUE
);

-- 参训记录备份表
CREATE TABLE training_participants_backup (
  backup_id BIGSERIAL PRIMARY KEY,
  original_id INTEGER NOT NULL,
  session_backup_id BIGINT,
  
  -- 原始数据
  id INTEGER,
  name TEXT,
  payment_amount NUMERIC(10,2),
  salesperson_name TEXT,
  -- ... 其他所有字段
  
  -- 备份元数据
  deleted_by UUID,
  deleted_at TIMESTAMP DEFAULT NOW(),
  
  FOREIGN KEY (session_backup_id) 
    REFERENCES training_sessions_backup(backup_id)
);
```

### 软删除字段（方案B使用）

```sql
-- 修改 training_sessions 表
ALTER TABLE training_sessions 
ADD COLUMN deleted_at TIMESTAMP NULL,
ADD COLUMN deleted_by UUID NULL,
ADD COLUMN deleted_by_name TEXT NULL,
ADD COLUMN delete_reason TEXT NULL;
```

---

## 🎯 删除流程对比

### 方案A：彻底删除流程
```
1. 备份到 training_sessions_backup
2. 备份到 training_participants_backup
3. 删除 training_participants（所有记录）
4. 删除 training_sessions
5. 主表数据完全清除
6. 业绩统计不再包含
```

### 方案B：软删除流程
```
1. 设置 deleted_at = NOW()
2. 参训记录不变
3. 普通界面不显示
4. 管理员界面可见（标注"已删除"）
5. 业绩数据完全保留
6. 可一键恢复
```

---

## 🎨 UI设计

### 删除确认对话框

```
┌───────────────────────────────────────┐
│        删除培训场次                    │
├───────────────────────────────────────┤
│ 培训名称：AI认证培训班                 │
│ 参训人数：10人                        │
│ 业绩金额：¥50,000                     │
│                                       │
│ 请选择删除方式：                       │
│                                       │
│ ○ 彻底删除（不可恢复）⚠️              │
│   • 完全删除培训和参训记录             │
│   • 清除所有业绩数据                   │
│   • 自动备份到数据库                   │
│   • 需要时可从数据库恢复               │
│                                       │
│ ● 临时删除（可恢复）✅ 推荐           │
│   • 保留培训和参训记录                 │
│   • 业绩数据不受影响                   │
│   • 在管理员界面可见                   │
│   • 可随时一键恢复                     │
│                                       │
│ 删除原因：[文本框]                     │
│                                       │
│     [取消]        [确认删除]          │
└───────────────────────────────────────┘
```

### 管理员"已删除"界面

```
培训管理 > 已删除的培训（管理员专用）

┌─────────────────────────────────────────┐
│ [🔍 搜索] [筛选：全部/软删除/彻底删除]    │
├─────────────────────────────────────────┤
│ AI认证培训班          [已删除] 🔴        │
│ 2025-11-15 | 10人 | ¥50,000            │
│ 删除时间：2025-11-09 20:30              │
│ 删除人：张管理员                         │
│ 删除原因：培训取消                       │
│ [🔄 恢复] [📄 查看详情]                  │
├─────────────────────────────────────────┤
│ ...更多已删除记录                        │
└─────────────────────────────────────────┘
```

---

## 💻 技术实现要点

### 后端服务接口

```typescript
interface DeleteOptions {
  deleteType: 'hard' | 'soft';
  reason?: string;
  userId: string;
  userName: string;
}

// 彻底删除（含备份）
async hardDeleteWithBackup(sessionId, options): Promise<void>

// 软删除
async softDelete(sessionId, options): Promise<void>

// 恢复软删除
async restoreSoftDeleted(sessionId): Promise<void>

// 从备份恢复（彻底删除的）
async restoreFromBackup(backupId): Promise<void>

// 获取已删除列表（管理员）
async getDeletedSessions(): Promise<TrainingSessionFrontend[]>
```

### 关键实现

#### 方案A：备份+删除
```typescript
// 1. 备份培训场次
await supabase.from('training_sessions_backup').insert({
  ...session,
  original_id: session.id,
  deleted_by: userId,
  deleted_at: NOW()
});

// 2. 备份参训记录
await supabase.from('training_participants_backup').insert(
  participants.map(p => ({...p, session_backup_id}))
);

// 3. 删除原始数据
await supabase.from('training_participants').delete()
  .eq('training_session_id', sessionId);
await supabase.from('training_sessions').delete()
  .eq('id', sessionId);
```

#### 方案B：软删除
```typescript
// 标记删除
await supabase.from('training_sessions').update({
  deleted_at: NOW(),
  deleted_by: userId,
  delete_reason: reason
}).eq('id', sessionId);

// 恢复
await supabase.from('training_sessions').update({
  deleted_at: null,
  deleted_by: null
}).eq('id', sessionId);
```

---

## 🧪 测试用例

### 测试1：彻底删除
```
1. 选择"彻底删除"
2. 输入删除原因
3. 确认删除
验证：
- ✅ 备份表有记录
- ✅ 主表数据已删除
- ✅ 业绩统计已更新
- ✅ 列表中不显示
```

### 测试2：软删除
```
1. 选择"临时删除"
2. 确认删除
验证：
- ✅ deleted_at 已设置
- ✅ 参训记录保留
- ✅ 业绩数据不变
- ✅ 普通界面不显示
- ✅ 管理员界面可见
```

### 测试3：软删除恢复
```
1. 在管理员界面点击"恢复"
验证：
- ✅ deleted_at 清空
- ✅ 正常列表中显示
- ✅ 数据完整无损
```

### 测试4：彻底删除恢复
```
1. 在数据库查询备份表
2. 调用恢复接口
验证：
- ✅ 培训场次恢复
- ✅ 参训记录恢复
- ✅ 业绩数据恢复
```

---

## 📊 影响对比

| 功能 | 彻底删除 | 软删除 |
|------|----------|--------|
| **数据保留** | 备份表 | 主表（标记） |
| **业绩影响** | 清除 ✅ | 保留 ✅ |
| **可恢复性** | 数据库操作 | 一键恢复 ✅ |
| **管理员可见** | 需查备份表 | 界面可见 ✅ |
| **实施难度** | 高 | 低 ✅ |

---

## 🎯 推荐实施顺序

### Phase 1：软删除（1-2天）✅ 优先
1. 数据库添加deleted_at字段
2. 实现软删除逻辑
3. 实现恢复功能
4. 管理员"已删除"界面
5. 测试验证

### Phase 2：彻底删除（3-5天）
1. 创建备份表
2. 实现备份逻辑
3. 实现彻底删除
4. 实现从备份恢复
5. 测试验证

### Phase 3：UI集成（1天）
1. 删除方式选择对话框
2. 集成两种删除方式
3. 完整测试

---

## ⚠️ 注意事项

### 彻底删除警告
```
- 业绩数据将被清除
- 月度/年度报表受影响
- 需要完整的备份策略
- 恢复需要数据库权限
```

### 软删除优势
```
- 业绩数据安全
- 误删可快速恢复
- 审计追溯方便
- 实施简单快速
```

---

## 📝 文件清单

```
migrations/
  ├── add-soft-delete-fields.sql          # 软删除字段
  └── create-backup-tables.sql            # 备份表

src/lib/services/
  └── trainingSessionService.ts           # 删除服务

src/components/
  ├── DeleteSessionDialog.tsx             # 删除对话框
  └── DeletedSessionsView.tsx             # 已删除列表

src/pages/
  └── TrainingManagement.tsx              # 培训管理页
```

---

**推荐方案**：优先实施软删除，满足日常需求；彻底删除作为高级功能按需实施 ✅

**核心理念**：给管理员选择权，同时保护数据安全！
