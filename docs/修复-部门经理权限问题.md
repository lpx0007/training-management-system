# ä¿®å¤éƒ¨é—¨ç»ç†æƒé™é—®é¢˜

**ä¿®å¤æ—¥æœŸ**: 2025-11-11  
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  

## é—®é¢˜æè¿°

1. **æ‹›å•†ç®€ç« æ— æ³•åŠ è½½**
   - éƒ¨é—¨ç»ç†æ— æ³•æŸ¥çœ‹ã€ŠAIå®æˆ˜åŸ¹è®­ã€‹ç­‰è¯¾ç¨‹çš„æ‹›å•†ç®€ç« 
   - æ˜¾ç¤º"ç®€ç« ä¿¡æ¯åŠ è½½å¤±è´¥"

2. **å®¢æˆ·åˆ é™¤æƒé™ç¼ºå¤±**
   - éƒ¨é—¨ç»ç†åº”è¯¥èƒ½å¤Ÿç®¡ç†ä¸‹å±ä¸šåŠ¡å‘˜çš„å®¢æˆ·ï¼ŒåŒ…æ‹¬åˆ é™¤æ“ä½œ
   - ä½†é»˜è®¤æƒé™é…ç½®ä¸­æ²¡æœ‰åŒ…å« `customer_delete` æƒé™

## é—®é¢˜åŸå› 

### 1. æ‹›å•†ç®€ç« é—®é¢˜
æ•°æ®åº“ `prospectuses` è¡¨çš„ RLSï¼ˆè¡Œçº§å®‰å…¨ï¼‰ç­–ç•¥åªåŒ…å«ï¼š
- âœ… ç®¡ç†å‘˜ï¼ˆadminï¼‰çš„æŸ¥çœ‹ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æƒé™
- âœ… ä¸šåŠ¡å‘˜ï¼ˆsalespersonï¼‰çš„æŸ¥çœ‹æƒé™
- âŒ **ç¼ºå¤±**ï¼šéƒ¨é—¨ç»ç†ï¼ˆmanagerï¼‰çš„æŸ¥çœ‹æƒé™

### 2. å®¢æˆ·åˆ é™¤æƒé™
å‰ç«¯æƒé™é…ç½® `permissions.ts` ä¸­ï¼Œéƒ¨é—¨ç»ç†é»˜è®¤æƒé™åˆ—è¡¨æœªåŒ…å« `customer_delete`ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. æ•°æ®åº“å±‚é¢ä¿®å¤

#### æ·»åŠ  RLS ç­–ç•¥
```sql
CREATE POLICY "Managers can view all prospectuses" ON prospectuses
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM user_profiles
            WHERE user_profiles.id = auth.uid()
            AND user_profiles.role = 'manager'
        )
    );
```

#### æ·»åŠ å®¢æˆ·åˆ é™¤æƒé™
```sql
-- ä¸ºæ‰€æœ‰éƒ¨é—¨ç»ç†æ·»åŠ  customer_delete æƒé™
INSERT INTO user_permissions (user_id, permission_id)
SELECT 
    up.id as user_id,
    'customer_delete' as permission_id
FROM user_profiles up
WHERE up.role = 'manager'
    AND NOT EXISTS (
        SELECT 1 FROM user_permissions ump
        WHERE ump.user_id = up.id
        AND ump.permission_id = 'customer_delete'
    );
```

### 2. å‰ç«¯é…ç½®æ›´æ–°

ä¿®æ”¹ `src/constants/permissions.ts`ï¼Œåœ¨éƒ¨é—¨ç»ç†é»˜è®¤æƒé™ä¸­æ·»åŠ ï¼š
```typescript
manager: [
    // éƒ¨é—¨ç»ç†æƒé™ï¼ˆå®¢æˆ·ç®¡ç†ï¼‰
    'customer_view',
    'customer_view_all',
    'customer_add',
    'customer_edit',
    'customer_delete',      // âœ… æ–°å¢åˆ é™¤å®¢æˆ·æƒé™
    'customer_export',
    // ... å…¶ä»–æƒé™
]
```

## ä¿®å¤ç»“æœ

### æ•°æ®åº“éªŒè¯
```sql
-- éƒ¨é—¨ç»ç†æƒé™éªŒè¯ç»“æœ
å¼ ä¸‰: has_customer_delete=1, total_permissions=23 âœ…
æç»ç†: has_customer_delete=1, total_permissions=23 âœ…
ç‹ç»ç†: has_customer_delete=1, total_permissions=23 âœ…
å¼ ç»ç†: has_customer_delete=1, total_permissions=23 âœ…

-- æ‹›å•†ç®€ç«  RLS ç­–ç•¥
"Managers can view all prospectuses" - SELECT âœ…
```

## å½±å“èŒƒå›´

### å—ç›Šç”¨æˆ·
- æ‰€æœ‰éƒ¨é—¨ç»ç†è§’è‰²ç”¨æˆ·ï¼ˆ4äººï¼‰
- æœªæ¥åˆ›å»ºçš„éƒ¨é—¨ç»ç†ç”¨æˆ·

### åŠŸèƒ½æ”¹è¿›
1. âœ… éƒ¨é—¨ç»ç†å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ‹›å•†ç®€ç« 
2. âœ… éƒ¨é—¨ç»ç†å¯ä»¥åˆ é™¤ä¸‹å±ä¸šåŠ¡å‘˜çš„å®¢æˆ·
3. âœ… æƒé™ç®¡ç†é¡µé¢æ­£ç¡®æ˜¾ç¤ºéƒ¨é—¨ç»ç†æƒé™

## æµ‹è¯•å»ºè®®

1. **æ‹›å•†ç®€ç« æµ‹è¯•**
   - ä½¿ç”¨éƒ¨é—¨ç»ç†è´¦å·ç™»å½•
   - è¿›å…¥åŸ¹è®­ç®¡ç†é¡µé¢
   - æŸ¥çœ‹åŸ¹è®­è¯¦æƒ…ä¸­çš„æ‹›å•†ç®€ç« 
   - ç¡®è®¤å¯ä»¥æ­£å¸¸æ˜¾ç¤ºç®€ç« ä¿¡æ¯

2. **å®¢æˆ·åˆ é™¤æµ‹è¯•**
   - ä½¿ç”¨éƒ¨é—¨ç»ç†è´¦å·ç™»å½•
   - è¿›å…¥å®¢æˆ·ç®¡ç†é¡µé¢
   - å°è¯•åˆ é™¤ä¸‹å±ä¸šåŠ¡å‘˜çš„å®¢æˆ·
   - ç¡®è®¤åˆ é™¤æ“ä½œæˆåŠŸ

## ç›¸å…³æ–‡ä»¶

- `scripts/migrations/fix-manager-permissions.sql` - æ•°æ®åº“ä¿®å¤è„šæœ¬
- `src/constants/permissions.ts` - å‰ç«¯æƒé™é…ç½®
- `src/pages/TrainingPerformance.tsx` - åŸ¹è®­ç®¡ç†é¡µé¢ï¼ˆæ˜¾ç¤ºæ‹›å•†ç®€ç« ï¼‰
- `src/pages/CustomerManagement.tsx` - å®¢æˆ·ç®¡ç†é¡µé¢ï¼ˆåˆ é™¤å®¢æˆ·ï¼‰

## åç»­å»ºè®®

1. **å®šæœŸæƒé™å®¡è®¡**
   - å»ºè®®æ¯æœˆæ£€æŸ¥å„è§’è‰²æƒé™é…ç½®
   - ç¡®ä¿æ•°æ®åº“å’Œå‰ç«¯æƒé™ä¸€è‡´

2. **å®Œå–„æƒé™æµ‹è¯•**
   - æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–æƒé™åŠŸèƒ½
   - ç‰¹åˆ«æ˜¯æ–°è§’è‰²çš„æƒé™é…ç½®

3. **æƒé™æ–‡æ¡£**
   - ç»´æŠ¤æƒé™çŸ©é˜µæ–‡æ¡£
   - æ˜ç¡®å„è§’è‰²çš„æƒé™èŒƒå›´
