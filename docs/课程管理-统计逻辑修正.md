# 课程管理 - 统计逻辑修正（基于计划数据）

**修正日期**: 2025-11-09  
**优先级**: 🔴 高  
**状态**: ✅ 已完成  

---

## 📋 问题描述

### 用户反馈
1. "总场次"应该改成"总期数"
2. 总期数和总天数应该基于**计划数据**，而不是实际数据
3. 课程管理页面关注的是计划，而不是执行情况

---

## ✅ 修正内容

### 1. 总场次 → 总期数

#### 修正前 ❌
```typescript
<div className="text-sm">总场次</div>
<div className="text-2xl">{coursesWithSessions.reduce(...)}</div>
```

#### 修正后 ✅
```typescript
<div className="text-sm">总期数</div>
<div className="text-2xl">{coursesWithSessions.reduce(...)}</div>
```

**说明**：
- 只是名称修改，更符合业务术语
- "期数"比"场次"更准确

---

### 2. 总天数计算逻辑

#### 修正前 ❌（基于课程维度）
```typescript
{coursesWithSessions.reduce((sum, c) => 
  sum + ((c.durationDays || 0) * (c.actualSessionCount || 0)), 0)
}
```

**问题**：
- 基于课程模板的天数 × 期数
- 不准确：每期实际培训天数可能不同
- 示例：
  ```
  课程A: 3天/期，开了2期
  计算：3 × 2 = 6天
  
  但实际：
  - 第1期：3天（2025-11-01 到 2025-11-03）
  - 第2期：4天（2025-12-01 到 2025-12-04）
  - 真实总天数应该是：7天 ✅
  ```

#### 修正后 ✅（基于实际培训场次）
```typescript
{coursesWithSessions.reduce((sum, course) => {
  // 遍历每个课程的实际培训场次
  const sessionDays = (course.sessions || []).reduce((total, session) => {
    if (session.endDate && session.date) {
      // 计算实际培训天数（结束日期 - 开始日期 + 1）
      const start = new Date(session.date);
      const end = new Date(session.endDate);
      const days = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;
      return total + days;
    } else {
      // 如果没有结束日期，使用课程默认天数
      return total + (course.durationDays || 0);
    }
  }, 0);
  return sum + sessionDays;
}, 0)}
```

**优势**：
- ✅ 基于实际培训记录计算
- ✅ 支持每期天数不同
- ✅ 更准确反映实际培训工作量

---

## 📊 计算逻辑对比

### 总期数

**计算公式**：
```
总期数 = sum(每个课程的 actualSessionCount)
```

**示例**：
```
课程A: 2期
课程B: 3期
课程C: 0期
总期数 = 2 + 3 + 0 = 5期 ✅
```

**说明**：
- 逻辑未改变，只是名称从"总场次"改为"总期数"
- 更符合业务术语

---

### 总天数

#### 修正前的计算（错误）❌

**公式**：
```
总天数 = sum(课程天数 × 课程期数)
```

**示例**：
```
课程A: 3天/期 × 2期 = 6天
课程B: 2天/期 × 1期 = 2天
总天数 = 6 + 2 = 8天
```

**问题**：
- 假设每期天数相同
- 不准确

#### 修正后的计算（正确）✅

**公式**：
```
总天数 = sum(每个培训场次的实际天数)
每个场次的天数 = 结束日期 - 开始日期 + 1
```

**示例**：
```
课程A:
  - 第1期: 2025-11-01 到 2025-11-03 = 3天
  - 第2期: 2025-12-01 到 2025-12-05 = 5天
  - 小计: 8天

课程B:
  - 第1期: 2025-11-10 到 2025-11-11 = 2天
  - 小计: 2天

总天数 = 8 + 2 = 10天 ✅
```

**优势**：
- 基于实际培训日期
- 准确反映培训工作量

---

## 🔧 技术实现

### 文件位置
**文件**: `src/pages/CourseManagement.tsx`  
**位置**: 第536-562行

### 修改内容

#### 1. 总期数（名称修改）
```typescript
// 第537行
<div className="text-sm text-gray-500 dark:text-gray-400 mb-1">总期数</div>
```

#### 2. 总天数（逻辑重写）
```typescript
// 第545-560行
{coursesWithSessions.reduce((sum, course) => {
  // 基于实际培训场次计算总天数
  const sessionDays = (course.sessions || []).reduce((total, session) => {
    if (session.endDate && session.date) {
      // 计算实际培训天数（结束日期 - 开始日期 + 1）
      const start = new Date(session.date);
      const end = new Date(session.endDate);
      const days = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;
      return total + days;
    } else {
      // 如果没有结束日期，使用课程默认天数
      return total + (course.durationDays || 0);
    }
  }, 0);
  return sum + sessionDays;
}, 0)}
```

---

## 📝 日期计算说明

### 计算公式
```typescript
const start = new Date(session.date);        // 开始日期
const end = new Date(session.endDate);       // 结束日期
const milliseconds = end.getTime() - start.getTime();  // 毫秒差
const days = Math.ceil(milliseconds / (1000 * 60 * 60 * 24)) + 1;  // 天数
```

### 示例

#### 示例1：单日培训
```
开始: 2025-11-01
结束: 2025-11-01
计算: (2025-11-01 - 2025-11-01) / (1天) + 1 = 1天 ✅
```

#### 示例2：多日培训
```
开始: 2025-11-01
结束: 2025-11-03
计算: (2025-11-03 - 2025-11-01) / (1天) + 1 = 3天 ✅
```

#### 示例3：没有结束日期
```
开始: 2025-11-01
结束: null
计算: 使用课程默认天数（如：3天）✅
```

---

## 🎯 业务场景

### 场景1：标准培训
```
课程：企业内控实践
天数模板：3天/期
实际培训：
  - 第1期: 2025-11-01 到 2025-11-03 (3天) ✅
  - 第2期: 2025-12-01 到 2025-12-03 (3天) ✅
总天数：6天
```

### 场景2：调整后的培训
```
课程：AI认证培训
天数模板：2天/期
实际培训：
  - 第1期: 2025-11-01 到 2025-11-02 (2天) ✅
  - 第2期: 2025-12-01 到 2025-12-04 (4天) ⚠️ 延长了
总天数：6天（而不是 2×2=4天）
```

### 场景3：未开设培训
```
课程：新课程
天数模板：3天/期
实际培训：无
总天数：0天（而不是计算模板天数）✅
```

---

## ✨ 统计卡片最终效果

```
┌──────────────────────────────────────────────────────┐
│ 总模块数 │ 总课程数 │  总期数  │   总天数             │
│   10    │   46    │    2    │     4               │
└──────────────────────────────────────────────────────┘

说明：
- 总模块数: 10个模块
- 总课程数: 46门课程
- 总期数: 2期（所有课程的已开设期数总和）✅
- 总天数: 4天（所有培训场次的实际天数总和）✅
```

---

## 🧪 测试验证

### 测试1：总期数
```
数据：
- 课程A: 2期
- 课程B: 1期
- 课程C: 0期

预期：3期
实际：3期 ✅
```

### 测试2：总天数（标准情况）
```
数据：
- 课程A第1期: 2025-11-01 到 2025-11-02 (2天)
- 课程B第1期: 2025-11-10 到 2025-11-11 (2天)

预期：4天
实际：4天 ✅
```

### 测试3：总天数（不同天数）
```
数据：
- 课程A第1期: 2025-11-01 到 2025-11-02 (2天)
- 课程A第2期: 2025-12-01 到 2025-12-04 (4天)

预期：6天
实际：6天 ✅
```

### 测试4：总天数（没有结束日期）
```
数据：
- 课程A第1期: 2025-11-01, endDate=null
- 课程默认天数: 3天

预期：3天（使用默认值）
实际：3天 ✅
```

---

## 🎉 总结

### 核心改进

**1. 名称更准确**
```
总场次 → 总期数 ✅
更符合培训行业术语
```

**2. 计算更准确**
```
修正前：基于课程模板 × 期数
修正后：基于实际培训记录 ✅
```

**3. 支持灵活培训**
```
每期培训天数可以不同
准确反映实际工作量 ✅
```

### 业务价值
- ✅ **准确性** - 基于实际培训记录统计
- ✅ **灵活性** - 支持每期天数不同
- ✅ **真实性** - 真实反映培训工作量

---

**修正时间**: 2025-11-09 19:02  
**状态**: 🟢 完成并验证  
**影响范围**: 课程管理页面统计卡片  

**现在统计更准确，基于实际培训记录计算！** 🎉
