# 部门经理配置与RLS策略激活指南

## 一、team_members表的作用

`team_members`表是部门经理权限系统的核心，用于建立经理与业务员的上下级关系：

```sql
CREATE TABLE team_members (
  manager_id UUID,      -- 经理的用户ID
  member_id UUID,       -- 业务员的用户ID  
  department_id INT,    -- 所属部门ID
  status VARCHAR        -- 关系状态(active/inactive)
)
```

## 二、管理员如何配置部门经理

### 方式1：通过权限管理页面（推荐）✨

1. **进入权限管理页面**
   - 管理员登录后，进入"权限管理"页面
   - 找到要提升的业务员

2. **点击"角色"按钮**
   - 每个用户行都有"角色"按钮（紫色图标）
   - 点击打开角色编辑模态框

3. **配置为部门经理**
   ```
   用户角色：选择"部门经理"
   所属部门：选择对应部门（如"销售一部"）
   ```

4. **自动配置效果**
   - ✅ 用户role改为'manager'
   - ✅ 更新departments表的manager_id
   - ✅ 自动创建team_members关系
   - ✅ 该部门所有业务员自动分配给新经理
   - ✅ RLS策略立即生效

### 方式2：通过SQL脚本（技术人员）

```sql
-- 1. 更新用户角色为经理
UPDATE user_profiles 
SET role = 'manager', department_id = 1
WHERE id = '用户UUID';

-- 2. 更新部门的经理
UPDATE departments 
SET manager_id = '用户UUID'
WHERE id = 1;

-- 3. 建立团队关系
INSERT INTO team_members (manager_id, member_id, department_id, status)
SELECT 
  '经理UUID',
  id as member_id,
  1 as department_id,
  'active'
FROM user_profiles
WHERE department_id = 1 AND role = 'salesperson';
```

## 三、RLS策略自动激活机制

### 激活条件
当team_members表中存在有效关系时，RLS策略自动生效：

```sql
-- 经理查看本部门客户的RLS策略
EXISTS (
  SELECT 1 FROM team_members tm
  WHERE tm.manager_id = auth.uid()
  AND tm.member_id = customers.salesperson_id
  AND tm.status = 'active'
)
```

### 权限范围
配置为部门经理后，自动获得：

| 权限类型 | 范围 | 说明 |
|---------|------|------|
| **查看客户** | 本部门所有 | 包括所有下属业务员的客户 |
| **编辑客户** | 本部门所有 | 可以修改和重新分配 |
| **添加客户** | 可分配给下属 | 新客户可分配给任何下属 |
| **导出数据** | 本部门范围 | 只能导出本部门数据 |
| **培训参与者** | 本部门客户 | 管理本部门客户的培训 |

## 四、实际操作示例

### 场景：将张三提升为销售一部经理

1. **管理员操作步骤**
   ```
   权限管理 → 找到张三 → 点击"角色" → 
   选择"部门经理" → 选择"销售一部" → 保存
   ```

2. **系统自动执行**
   - 张三的role变为'manager'
   - 销售一部的manager_id设为张三ID
   - 销售一部所有业务员成为张三的下属
   - 创建team_members记录

3. **立即生效的权限**
   - 张三可以看到销售一部所有客户
   - 张三可以管理下属业务员
   - 张三可以查看部门业绩统计
   - 张三可以批量分配客户

## 五、验证配置是否成功

### 1. 数据库验证
```sql
-- 检查用户角色
SELECT * FROM user_profiles WHERE id = '张三ID';

-- 检查部门经理
SELECT * FROM departments WHERE manager_id = '张三ID';

-- 检查团队关系
SELECT * FROM team_members WHERE manager_id = '张三ID';
```

### 2. 功能验证
- 登录张三账号
- 进入客户管理页面
- 应该能看到整个部门的客户（不只是自己的）
- 尝试编辑其他业务员的客户（应该成功）

## 六、常见问题

### Q: 业务员直接改角色为manager可以吗？
**A:** 不行！仅改角色不够，必须同时：
1. 配置team_members关系
2. 更新departments表
否则RLS策略不会生效

### Q: 一个部门可以有多个经理吗？
**A:** 可以！多个经理都能管理同一部门：
- departments表只记录主管(manager_id)
- team_members表可以有多个manager_id对应同一部门

### Q: 降级经理会怎样？
**A:** 系统会自动：
1. 删除team_members中的管理关系
2. 清除departments表的manager_id
3. 失去查看其他人客户的权限

### Q: RLS策略是实时生效的吗？
**A:** 是的！数据库层面的RLS是实时的：
- 添加team_members记录 → 立即可以查看
- 删除team_members记录 → 立即失去权限

## 七、最佳实践

1. **使用UI配置**：通过权限管理页面配置，避免SQL错误
2. **先建部门**：确保部门存在后再分配经理
3. **批量操作**：新经理上任时，用自动分配功能
4. **权限审计**：定期检查team_members表的合理性
5. **文档记录**：记录每次角色变更的原因

## 八、技术细节

### RLS策略执行顺序
1. 先检查是否是管理员（最高权限）
2. 再检查team_members（部门经理）
3. 最后检查salesperson_id（业务员本人）

### 性能优化
- team_members表已建立索引
- RLS使用EXISTS子查询，性能良好
- 建议定期清理inactive状态的记录

## 九、总结

**核心要点**：
- ✅ team_members表是部门经理权限的关键
- ✅ 管理员可通过UI轻松配置部门经理
- ✅ 配置后RLS策略立即自动生效
- ✅ 无需手动修改任何RLS策略代码
