# 权限系统完整规则说明（第二部分）

**文档版本**: v1.0  
**最后更新**: 2025-11-07

---

## 权限分配规则

### 1. 管理员（Admin）

**规则**：拥有所有权限，无需配置

```typescript
// 代码实现
if (user?.role === 'admin') {
  return true; // 直接通过所有权限检查
}
```

**权限清单**：
- ✅ 所有50个细分权限
- ✅ 所有12个功能面板
- ✅ 无数据范围限制

**特殊说明**：
- 管理员的权限**不可被撤销**
- 在权限管理UI中可以隐藏管理员的编辑选项
- 代码中允许使用 `user?.role === 'admin'` 快速判断

---

### 2. 部门经理（Manager）

**默认权限**（14个）：

**客户管理**：
- ✅ customer_view
- ✅ customer_view_all
- ✅ customer_add
- ✅ customer_edit
- ✅ customer_export

**培训管理**：
- ✅ training_view
- ✅ training_view_stats
- ✅ training_export

**业务员管理**：
- ✅ salesperson_view
- ✅ salesperson_add
- ✅ salesperson_edit
- ✅ salesperson_view_performance

**数据管理**：
- ✅ performance_export
- ✅ data_view_history

**可选权限**（需手动授权）：
- ⚠️ performance_view_all_departments（查看所有部门业绩）

**数据范围控制**：
```typescript
// 默认：只能看本部门数据
if (userRole === 'manager' && !permissions.includes('performance_view_all_departments')) {
  data = data.filter(item => item.departmentId === userDepartmentId);
}

// 授权后：可以看所有部门数据
if (permissions.includes('performance_view_all_departments')) {
  // 不过滤，显示全部
}
```

**使用场景**：
1. **默认场景**（本部门）：
   - 进入销售追踪页面 → 只显示本部门业绩
   - 导出业绩数据 → 只包含本部门业务员
   - 查看业务员列表 → 只显示本部门业务员

2. **授权场景**（所有部门）：
   - 进入销售追踪页面 → 显示所有部门业绩
   - 导出业绩数据 → 包含所有部门业务员
   - 查看业务员列表 → 显示所有业务员

---

### 3. 业务员（Salesperson）

**默认权限**（11个）：

**客户管理**：
- ✅ customer_view（仅自己的）
- ✅ customer_add
- ✅ customer_edit（仅自己的）
- ✅ customer_import
- ✅ customer_export（仅自己的）

**培训管理**：
- ✅ training_view
- ✅ training_add_participant

**其他**：
- ✅ expert_view
- ✅ prospectus_view
- ✅ prospectus_download
- ✅ data_download_template

**数据范围控制**：
```typescript
// 业务员只能操作自己的数据
if (userRole === 'salesperson') {
  query = query.eq('salesperson_id', userId);
}
```

**可扩展权限示例**：
- customer_view_all（查看所有客户）
- customer_delete（删除客户）
- training_export（导出培训数据）
- salesperson_view_performance（查看业绩统计）

---

### 4. 专家（Expert）

**默认权限**（4个）：
- ✅ training_view
- ✅ expert_view
- ✅ expert_profile_edit（编辑自己的资料）
- ✅ prospectus_view

**数据范围控制**：
```typescript
// 专家只能查看与自己相关的培训
if (userRole === 'expert') {
  query = query.eq('expert_id', userId);
}
```

**可扩展权限示例**：
- expert_view_feedback（查看专家反馈）
- prospectus_download（下载简章）

---

## 权限生效验证

### ✅ 验证清单1：功能面板显示

**测试方法**：以不同角色登录，检查导航栏显示的菜单项

| 角色 | 应显示数量 | 具体面板 |
|------|----------|---------|
| Admin | 12个 | 全部 |
| Manager | 6个 | dashboard, customer, training, salesperson, data, profile |
| Salesperson | 6个 | dashboard, customer, training, expert, prospectus, profile |
| Expert | 5个 | dashboard, training, expert, prospectus, profile |

---

### ✅ 验证清单2：按钮权限控制

**客户管理页面**：

| 操作 | Admin | Manager | Salesperson | Expert |
|------|-------|---------|------------|--------|
| 查看列表 | ✅ 全部 | ✅ 全部 | ✅ 仅自己 | ❌ |
| 添加按钮 | ✅ | ✅ | ✅ | ❌ |
| 编辑按钮 | ✅ | ✅ | ✅ 自己的 | ❌ |
| 删除按钮 | ✅ | ❌ | ❌ | ❌ |
| 导入按钮 | ✅ | ❌ | ✅ | ❌ |
| 导出按钮 | ✅ | ✅ | ✅ 自己的 | ❌ |

**培训管理页面**：

| 操作 | Admin | Manager | Salesperson | Expert |
|------|-------|---------|------------|--------|
| 查看列表 | ✅ | ✅ | ✅ | ✅ |
| 创建按钮 | ✅ | ❌ | ❌ | ❌ |
| 编辑按钮 | ✅ | ❌ | ❌ | ❌ |
| 删除按钮 | ✅ | ❌ | ❌ | ❌ |
| 添加参与者 | ✅ | ❌ | ✅ | ❌ |
| 查看统计 | ✅ | ✅ | ❌ | ❌ |

**数据管理页面**：

| 操作 | Admin | Manager | Salesperson | Expert |
|------|-------|---------|------------|--------|
| 导入客户 | ✅ | ❌ | ✅ | ❌ |
| 导出客户 | ✅ | ✅ | ✅ | ❌ |
| 导入培训 | ✅ | ❌ | ❌ | ❌ |
| 导出培训 | ✅ | ✅ | ❌ | ❌ |
| 导出业绩 | ✅ 全部 | ✅ 本部门 | ❌ | ❌ |

---

### ✅ 验证清单3：数据范围控制

**测试场景1：业务员数据范围**

1. 创建2个业务员账号（A和B）
2. A创建客户"客户1"，B创建客户"客户2"
3. 以A登录，进入客户管理
4. **期望结果**：只能看到"客户1"

**测试场景2：经理数据范围（默认）**

1. 创建2个部门（部门1和部门2）
2. 部门1有经理M1和业务员S1
3. 部门2有业务员S2
4. S1和S2分别创建业绩数据
5. 以M1登录（无跨部门权限），进入销售追踪
6. **期望结果**：只能看到S1的业绩

**测试场景3：经理数据范围（授权后）**

1. 管理员为M1授予 `performance_view_all_departments` 权限
2. M1重新登录或刷新权限
3. 进入销售追踪页面
4. **期望结果**：可以看到S1和S2的业绩

**测试SQL**：
```sql
-- 验证权限是否正确分配
SELECT 
  up.name AS user_name,
  up.role,
  p.id AS permission_id,
  p.name AS permission_name
FROM user_profiles up
LEFT JOIN user_permissions uper ON up.id = uper.user_id
LEFT JOIN permissions p ON uper.permission_id = p.id
WHERE up.id = '[用户ID]'
ORDER BY p.id;
```

---

## 常见问题排查

### 问题1：权限分配后不生效

**症状**：
- 在权限管理页面分配了权限
- 用户刷新页面后，功能仍然不可用

**排查步骤**：

```sql
-- 步骤1：检查权限是否写入数据库
SELECT * FROM user_permissions 
WHERE user_id = '[用户ID]' 
AND permission_id = '[权限ID]';

-- 步骤2：检查permissions表中权限是否存在
SELECT * FROM permissions 
WHERE id = '[权限ID]';

-- 步骤3：检查功能面板映射
SELECT * FROM user_menu_access 
WHERE user_id = '[用户ID]';
```

**解决方案**：
1. ✅ 用户重新登录（刷新权限缓存）
2. ✅ 检查前端 `featurePermissionMapping.ts` 是否包含该权限
3. ✅ 清除浏览器缓存
4. ✅ 检查前端代码是否有硬编码的角色判断

---

### 问题2：某些按钮对所有角色都不可用

**症状**：
- 包括管理员在内，所有人都无法使用某个功能
- 按钮显示但点击无效或根本不显示

**可能原因**：

1. **权限ID拼写错误**
```typescript
// 错误示例
const canDelete = permissions.includes('customer_delet'); // 少了e
```

2. **featurePermissionMapping缺少映射**
```typescript
// 检查 src/constants/featurePermissionMapping.ts
{
  featureId: 'customer_management',
  permissions: [
    'customer_view',
    'customer_add',
    // 缺少 'customer_delete' ❌
  ]
}
```

3. **前端组件未使用权限系统**
```typescript
// 错误示例：硬编码角色判断
{user?.role === 'manager' && <DeleteButton />} // ❌

// 正确示例：使用权限判断
{permissions.includes('customer_delete') && <DeleteButton />} // ✅
```

**解决方案**：
1. 检查权限ID拼写（与 `permissions.ts` 对照）
2. 更新 `featurePermissionMapping.ts`
3. 重构前端组件，使用权限系统而非角色判断

---

### 问题3：经理看不到本部门的数据

**症状**：
- 经理登录后，销售追踪页面显示空数据
- 或只能看到自己的业绩

**排查步骤**：

```sql
-- 步骤1：检查经理的部门ID
SELECT id, name, role, department_id 
FROM user_profiles 
WHERE id = '[经理ID]';

-- 步骤2：检查部门下的业务员
SELECT id, name, role, department_id 
FROM user_profiles 
WHERE department_id = '[部门ID]';

-- 步骤3：检查业绩数据的部门ID
SELECT 
  sp.name,
  sp.department_id,
  mp.month,
  mp.personal_revenue
FROM monthly_performance mp
JOIN user_profiles sp ON mp.user_id = sp.id
WHERE sp.department_id = '[部门ID]';
```

**可能原因**：
1. 经理的 `department_id` 未设置
2. 业务员的 `department_id` 与经理不匹配
3. 前端未正确传递 `userDepartmentId` 参数

**解决方案**：
```sql
-- 方案1：设置经理的部门ID
UPDATE user_profiles 
SET department_id = [正确的部门ID] 
WHERE id = '[经理ID]';

-- 方案2：设置业务员的部门ID
UPDATE user_profiles 
SET department_id = [正确的部门ID] 
WHERE id IN ('[业务员ID1]', '[业务员ID2]');
```

---

### 问题4：数据导出包含不应该看到的数据

**症状**：
- 经理导出业绩数据时，包含了其他部门的数据
- 业务员导出客户时，包含了其他业务员的客户

**排查步骤**：

```typescript
// 检查 dataManagementService.ts 中的 exportData 方法
console.log('User Role:', userRole);
console.log('User Department ID:', userDepartmentId);
console.log('Permissions:', permissions);
```

**可能原因**：
1. `exportData` 方法未正确传递用户信息
2. `performanceService.ts` 的数据过滤逻辑未生效
3. 管理员兼容逻辑覆盖了其他角色

**解决方案**：
```typescript
// 确保正确传递参数
const data = await dataManagementService.exportData(
  exportConfig,
  user?.id,      // ✅ 用户ID
  user?.role,    // ✅ 用户角色
  permissions    // ✅ 用户权限列表
);
```

---

## 维护指南

### 新增权限

当需要新增权限时，按以下步骤操作：

#### 步骤1：定义权限

在 `src/constants/permissions.ts` 中添加：

```typescript
export const PERMISSION_CATEGORIES: Record<string, PermissionCategory> = {
  // ... 其他分类
  CUSTOMER: {
    id: 'customer',
    name: '客户管理',
    permissions: [
      // ... 现有权限
      { 
        id: 'customer_export_advanced',  // 新权限ID
        name: '高级导出客户',            // 权限名称
        description: '导出客户完整数据包含敏感信息'  // 权限描述
      },
    ]
  }
};
```

#### 步骤2：添加到功能面板映射

在 `src/constants/featurePermissionMapping.ts` 中添加：

```typescript
export const FEATURE_PERMISSION_MAPPINGS: FeaturePermissionMapping[] = [
  {
    featureId: 'customer_management',
    permissions: [
      // ... 现有权限
      'customer_export_advanced',  // ⭐ 新增
    ],
    description: '客户管理页面的所有操作权限'
  },
];
```

#### 步骤3：添加到数据库

```sql
INSERT INTO permissions (id, name, description, category)
VALUES (
  'customer_export_advanced',
  '高级导出客户',
  '导出客户完整数据包含敏感信息',
  '客户管理'
);
```

#### 步骤4：在前端组件中使用

```typescript
// 在组件中检查权限
const { permissions } = useContext(AuthContext);
const canExportAdvanced = permissions.includes('customer_export_advanced');

// 条件渲染按钮
{canExportAdvanced && (
  <button onClick={handleAdvancedExport}>
    高级导出
  </button>
)}
```

#### 步骤5：更新默认权限（可选）

如果需要为某个角色默认分配此权限：

```typescript
export const ROLE_DEFAULT_PERMISSIONS: Record<UserRole, string[]> = {
  admin: getAllPermissions().map(p => p.id),  // 管理员自动拥有
  manager: [
    // ... 现有权限
    'customer_export_advanced',  // 为经理默认分配
  ],
};
```

---

### 删除权限

⚠️ **警告：删除权限需要谨慎，可能影响现有用户**

#### 步骤1：检查权限使用情况

```sql
-- 查看有多少用户拥有此权限
SELECT COUNT(DISTINCT user_id) 
FROM user_permissions 
WHERE permission_id = 'customer_export_advanced';

-- 查看具体是哪些用户
SELECT up.name, up.role, up.email
FROM user_permissions uper
JOIN user_profiles up ON uper.user_id = up.id
WHERE uper.permission_id = 'customer_export_advanced';
```

#### 步骤2：从前端代码中移除

1. 从 `permissions.ts` 中删除权限定义
2. 从 `featurePermissionMapping.ts` 中删除映射
3. 从组件中移除权限检查代码
4. 从默认权限中移除

#### 步骤3：从数据库中删除

```sql
-- 先删除所有用户的此权限
DELETE FROM user_permissions 
WHERE permission_id = 'customer_export_advanced';

-- 再删除权限定义
DELETE FROM permissions 
WHERE id = 'customer_export_advanced';
```

---

### 修改权限名称或描述

```sql
-- 仅修改显示名称和描述，不影响功能
UPDATE permissions 
SET 
  name = '新的权限名称',
  description = '新的权限描述'
WHERE id = 'customer_export_advanced';
```

同时更新前端 `permissions.ts` 中的对应字段。

---

## 附录

### 相关文件清单

| 文件路径 | 说明 |
|---------|------|
| `src/constants/permissions.ts` | 权限定义和分类 |
| `src/constants/menuFeatures.ts` | 功能面板定义 |
| `src/constants/featurePermissionMapping.ts` | 功能面板与权限映射 |
| `src/hooks/useDataManagementPermissions.ts` | 数据管理权限Hook |
| `src/pages/PermissionManagement.tsx` | 权限管理页面 |
| `src/lib/services/performanceService.ts` | 业绩数据服务（含数据范围过滤） |
| `src/lib/services/dataManagementService.ts` | 数据管理服务（含导出过滤） |
| `scripts/add-performance-export-permissions.sql` | 业绩导出权限SQL |

### 数据库表

| 表名 | 说明 |
|------|------|
| `permissions` | 权限定义表 |
| `user_permissions` | 用户权限关联表 |
| `user_menu_access` | 用户功能面板访问表 |
| `user_profiles` | 用户资料表（含角色和部门） |
| `departments` | 部门表 |

---

**文档结束**
