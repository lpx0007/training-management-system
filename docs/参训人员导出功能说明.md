# 参训人员导出功能说明

**功能版本**: v1.0  
**实施日期**: 2025-11-13  
**状态**: ✅ 已完成  

## 🎯 功能概述

在培训计划页面的培训详情模态框右上角，新增"参训人员导出"按钮，支持导出培训场次的参训人员详细信息，包含课程基本情况和参训人员明细。

## 🔐 权限设计

### 默认权限分配

| 角色 | 权限 | 导出范围 |
|------|------|----------|
| **管理员** | ✅ 有权限 | 所有参训人员 |
| **部门经理** | ✅ 有权限 | 本部门业务员的客户 |
| **业务员** | ❌ 无权限 | - |
| **专家** | ❌ 无权限 | - |

### 权限配置

**权限ID**: `training_export_participants`  
**权限名称**: 导出参训人员  
**权限描述**: 导出培训场次的参训人员名单（含详细信息）  

**管理员可以通过权限管理页面将此权限分配给其他用户**

## 📋 导出内容

### 客户详细信息

| 字段 | 描述 | 数据来源 |
|------|------|----------|
| 序号 | 自动编号 | 系统生成 |
| 客户姓名 | 客户姓名 | customers.name |
| 手机号 | 联系电话 | customers.phone |
| 邮箱 | 电子邮箱 | customers.email |
| 所在地区 | 客户地区 | customers.location |
| 公司名称 | 所属公司 | customers.company |
| 职位 | 客户职位 | customers.position |
| **部门** | 客户部门 | customers.department |
| **性别** | 客户性别 | customers.gender |
| **住宿需求** | 住宿需求备注 | customers.accommodation_requirements |
| 客户标签 | 客户分类标签 | customers.tags |
| 跟进状态 | 客户跟进状态 | customers.follow_up_status |
| 负责业务员 | 客户归属业务员 | customers.salesperson_name |
| 报名日期 | 培训报名日期 | training_participants.registration_date |
| 付款状态 | 缴费状态 | training_participants.payment_status |
| 参与方式 | 线上/线下参与 | training_participants.participation_mode |
| 标准价格 | 原价 | training_participants.payment_amount |
| 实付价格 | 优惠后价格 | training_participants.actual_price |
| 折扣率 | 折扣百分比 | training_participants.discount_rate |

## 🎨 界面设计

### 按钮位置
- **位置**: 培训详情模态框右上角
- **样式**: 绿色按钮 + 下载图标
- **文本**: "参训人员导出"
- **权限保护**: 使用 `PermissionGuard` 组件

### 按钮代码
```tsx
<PermissionGuard permission="training_export_participants">
  {selectedSession.participantsList && selectedSession.participantsList.length > 0 && (
    <button
      onClick={handleExportParticipantDetails}
      className="px-3 py-1.5 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm transition-colors flex items-center gap-2"
      title="导出参训人员详细信息"
    >
      <Download size={14} />
      参训人员导出
    </button>
  )}
</PermissionGuard>
```

## 🏗️ 技术实现

### 主要文件

| 文件 | 修改内容 |
|------|----------|
| `src/constants/permissions.ts` | 添加新权限定义 |
| `src/constants/featurePermissionMapping.ts` | 权限映射配置 |
| `src/pages/TrainingPerformance.tsx` | 导出函数和UI |

### 核心函数

```typescript
const handleExportParticipantDetails = async () => {
  // 1. 权限检查和数据验证
  if (!selectedSession?.participantsList?.length) {
    toast.error('没有参训人员数据可导出');
    return;
  }

  // 2. 部门经理权限过滤
  let participantsToExport = selectedSession.participantsList;
  if (user?.role === 'manager' && user?.department) {
    // 获取本部门业务员列表并过滤
    const allUsers = await supabaseService.getAllUsersWithPermissions();
    const departmentSalespersons = allUsers
      .filter(u => u.role === 'salesperson' && u.department === user.department)
      .map(u => u.name);
    
    participantsToExport = participantsToExport.filter(participant => 
      participant.salespersonName && departmentSalespersons.includes(participant.salespersonName)
    );
  }

  // 3. 组织导出数据
  const courseInfo = [...];  // 课程基本信息
  const headers = [...];     // 表头
  const participantData = [...]; // 参训人员数据

  // 4. 生成Excel文件
  const ws = XLSX.utils.aoa_to_sheet([...courseInfo, headers, ...participantData]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '参训人员名单');
  
  // 5. 下载文件
  const fileName = `${selectedSession.name}_参训人员名单_${new Date().toLocaleDateString('zh-CN')}.xlsx`;
  XLSX.writeFile(wb, fileName);
};
```

## 🔍 权限过滤逻辑

### 管理员
- **权限**: 查看所有参训人员
- **逻辑**: 直接导出完整的 `participantsList`

### 部门经理
- **权限**: 仅查看本部门业务员的客户
- **逻辑**:
  1. 获取当前用户的部门信息
  2. 查询该部门下所有业务员列表
  3. 过滤参训人员，仅保留本部门业务员的客户
  4. 导出过滤后的名单

### 容错处理
- 如果获取部门业务员列表失败，输出警告并导出所有参训人员
- 避免因为网络或权限问题导致导出功能完全失效

## 📊 导出文件格式

### 文件名格式
```
{课程名称}_客户详细信息_{导出日期}.xlsx
```

**示例**: `企业数字化内控实践_客户详细信息_2025-11-13.xlsx`

### Excel结构
```
第1行: 表头
第2-N行: 客户数据
```

### 列宽设置
```typescript
const colWidths = [
  { wch: 6 },  // 序号
  { wch: 12 }, // 客户姓名
  { wch: 15 }, // 手机号
  { wch: 25 }, // 邮箱
  { wch: 10 }, // 所在地区
  { wch: 20 }, // 公司名称
  { wch: 12 }, // 职位
  { wch: 12 }, // 部门
  { wch: 6 },  // 性别
  { wch: 30 }, // 住宿需求
  { wch: 20 }, // 客户标签
  { wch: 10 }, // 跟进状态
  { wch: 12 }, // 负责业务员
  { wch: 12 }, // 报名日期
  { wch: 10 }, // 付款状态
  { wch: 10 }, // 参与方式
  { wch: 12 }, // 标准价格
  { wch: 12 }, // 实付价格
  { wch: 8 }   // 折扣率
];
```

## 🎛️ 权限管理

### 查看权限配置
1. 登录系统 → 权限管理
2. 找到"培训管理"权限类别
3. 查看"导出参训人员"权限

### 分配权限
1. 选择目标用户
2. 勾选"导出参训人员"权限
3. 保存配置

### 权限验证
系统使用 `PermissionGuard` 组件自动验证权限：
- 有权限：显示导出按钮
- 无权限：隐藏导出按钮

## 🧪 测试场景

### 基础功能测试
- ✅ 管理员导出：显示按钮，导出所有参训人员
- ✅ 部门经理导出：显示按钮，仅导出本部门客户
- ✅ 业务员：不显示按钮
- ✅ 专家：不显示按钮

### 权限分配测试
- ✅ 管理员给业务员分配权限后，业务员可导出
- ✅ 取消权限后，按钮立即隐藏

### 数据完整性测试
- ✅ 课程信息正确显示
- ✅ 参训人员信息完整
- ✅ 优惠价格和折扣正确计算
- ✅ 文件命名规范正确

### 边界情况测试
- ✅ 无参训人员时，按钮隐藏
- ✅ 部门经理无本部门客户时，导出空列表
- ✅ 网络异常时，容错处理正常

## 📱 用户使用流程

### 管理员使用
1. 登录系统 → 培训计划
2. 点击任意培训详情
3. 点击"参训人员导出"按钮
4. 文件自动下载到本地

### 部门经理使用
1. 登录系统 → 培训计划
2. 点击任意培训详情
3. 点击"参训人员导出"按钮
4. 下载本部门客户名单

### 权限申请流程
业务员如需导出权限：
1. 联系管理员
2. 管理员在权限管理中分配权限
3. 业务员刷新页面后可使用

## 🔧 维护说明

### 权限管理
- 新权限已自动包含在权限管理界面
- 管理员可随时分配/回收权限
- 权限变更实时生效

### 性能考虑
- 使用异步导入 XLSX 库，避免影响页面加载
- 部门经理权限过滤使用内存操作，性能良好
- 大量数据导出时有错误捕获和用户反馈

### 扩展建议
- 考虑添加导出格式选择（CSV/PDF）
- 支持自定义导出字段
- 添加导出历史记录
- 支持批量培训场次导出

## 📞 技术支持

如遇问题，请检查：
1. 用户是否有相应权限
2. 培训场次是否有参训人员
3. 浏览器是否支持文件下载
4. 网络连接是否正常

**相关文档**：
- 权限管理说明书
- 培训管理用户手册
- 系统管理员指南
