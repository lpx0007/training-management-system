# 修复 - 姓名同步问题

**问题日期**: 2025-11-16  
**修复版本**: v3.2  
**状态**: ✅ 已修复  

## 问题描述

**用户反馈**:
> 我登录会务客服张小美的账号，修改了名字，为什么课程列表中的名字没有一起变更？

**现象**:
- 用户在个人设置中修改了姓名（例如："会务客服-张小美" → "张小美"）
- `user_profiles` 表中的 `name` 字段已更新
- 但培训详情页中显示的会务客服姓名仍然是旧名字
- 培训列表中的负责人姓名也存在同样问题

## 根本原因

### 数据冗余设计

培训表（`training_sessions`）采用了**数据冗余**设计：

```sql
training_sessions 表:
├─ conference_service_id (UUID)    -- 会务客服用户ID
├─ conference_service_name (TEXT)  -- 会务客服姓名 ⚠️ 冗余字段
├─ salesperson_id (UUID)           -- 负责人用户ID
├─ salesperson_name (TEXT)         -- 负责人姓名 ⚠️ 冗余字段
├─ expert_id (INTEGER)             -- 专家ID
└─ expert_name (TEXT)              -- 专家姓名 ⚠️ 冗余字段
```

**冗余的原因**:
1. **性能优化**: 避免每次查询都JOIN `user_profiles` 表
2. **数据展示**: 直接显示姓名，无需关联查询
3. **历史保留**: 即使用户被删除，历史记录仍保留姓名

### 同步缺失

**问题**:
- 当用户修改姓名时，只更新 `user_profiles.name`
- **未同步更新** `training_sessions` 表中的冗余姓名字段
- 导致新旧数据不一致

**流程图**:
```
用户修改姓名
    ↓
user_profiles.name 已更新 ✅
    ↓
training_sessions.conference_service_name 未更新 ❌
    ↓
培训详情页显示旧姓名 ❌
```

## 解决方案

### 方案1: 数据库触发器（已实施） ✅

**核心思路**: 当用户姓名修改时，自动同步更新所有相关培训记录。

#### 实现步骤

**步骤1: 创建同步函数**

```sql
CREATE OR REPLACE FUNCTION sync_conference_service_name()
RETURNS TRIGGER AS $$
BEGIN
  -- 检查姓名是否变化
  IF OLD.name IS DISTINCT FROM NEW.name THEN
    -- 更新所有相关培训的会务客服姓名
    UPDATE training_sessions
    SET conference_service_name = NEW.name
    WHERE conference_service_id = NEW.id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**步骤2: 创建触发器**

```sql
CREATE TRIGGER sync_conference_service_name_trigger
  AFTER UPDATE OF name ON user_profiles
  FOR EACH ROW
  WHEN (OLD.name IS DISTINCT FROM NEW.name)
  EXECUTE FUNCTION sync_conference_service_name();
```

**步骤3: 修复现有数据**

```sql
-- 一次性修复所有不一致的数据
UPDATE training_sessions ts
SET conference_service_name = up.name
FROM user_profiles up
WHERE ts.conference_service_id = up.id
  AND ts.conference_service_name IS DISTINCT FROM up.name
  AND ts.conference_service_id IS NOT NULL;
```

#### 触发器列表

本次迁移创建了以下触发器：

| 触发器 | 表 | 触发条件 | 同步字段 |
|--------|-----|---------|---------|
| `sync_conference_service_name_trigger` | `user_profiles` | `name` 字段更新 | `training_sessions.conference_service_name` |
| `sync_salesperson_name_trigger` | `user_profiles` | `name` 字段更新 | `training_sessions.salesperson_name` |

#### 工作流程

```
用户修改姓名
    ↓
user_profiles.name 更新
    ↓
触发器自动执行
    ↓
training_sessions.conference_service_name 自动更新 ✅
training_sessions.salesperson_name 自动更新 ✅
    ↓
前端刷新后显示新姓名 ✅
```

### 方案2: 关联查询（备选方案）

**思路**: 不存储冗余姓名，每次都从 `user_profiles` 关联查询。

**优点**:
- ✅ 数据始终一致
- ✅ 无需同步逻辑
- ✅ 减少存储空间

**缺点**:
- ❌ 查询性能下降（每次都要JOIN）
- ❌ 用户删除后姓名丢失
- ❌ 历史数据不准确

**不推荐的原因**:
- 培训列表查询频繁，性能影响大
- 需要保留历史数据的准确性

### 方案3: 应用层同步（不推荐）

**思路**: 在前端或后端代码中，修改姓名时同步更新培训记录。

**缺点**:
- ❌ 容易遗漏（多个修改入口）
- ❌ 代码耦合度高
- ❌ 无法处理直接SQL修改

## 验证步骤

### 验证1: 修改会务客服姓名

**操作**:
1. 登录会务客服账号（如 2956734001@qq.com）
2. 进入个人设置
3. 修改姓名（如："会务客服-张小美" → "张小美"）
4. 保存

**验证点**:
- ✅ 刷新培训列表页，会务客服列显示新姓名
- ✅ 打开培训详情页，"其他信息"中会务客服显示新姓名
- ✅ 数据库 `training_sessions` 表的 `conference_service_name` 已更新

**SQL验证**:
```sql
-- 查看会务客服负责的培训
SELECT 
  id, 
  name AS 培训名称,
  conference_service_id,
  conference_service_name AS 会务客服姓名
FROM training_sessions
WHERE conference_service_id = 'USER_ID';

-- 对比用户表中的姓名
SELECT 
  ts.name AS 培训名称,
  ts.conference_service_name AS 培训表姓名,
  up.name AS 用户表姓名,
  CASE 
    WHEN ts.conference_service_name = up.name THEN '✅ 一致'
    ELSE '❌ 不一致'
  END AS 状态
FROM training_sessions ts
INNER JOIN user_profiles up ON ts.conference_service_id = up.id
WHERE ts.conference_service_id IS NOT NULL;
```

### 验证2: 修改负责人姓名

**操作**:
1. 登录业务员账号
2. 修改姓名
3. 查看负责的培训

**验证点**:
- ✅ 培训列表中负责人列显示新姓名
- ✅ 培训详情中负责人显示新姓名

### 验证3: 触发器状态

**SQL查询**:
```sql
-- 查看已创建的触发器
SELECT 
  trigger_name AS 触发器名称,
  event_object_table AS 表名,
  action_timing AS 触发时机,
  event_manipulation AS 触发事件
FROM information_schema.triggers
WHERE trigger_schema = 'public'
  AND trigger_name LIKE '%sync%name%'
ORDER BY event_object_table, trigger_name;
```

**预期结果**:
```
触发器名称                              | 表名          | 触发时机 | 触发事件
----------------------------------------|--------------|---------|----------
sync_conference_service_name_trigger    | user_profiles| AFTER   | UPDATE
sync_salesperson_name_trigger           | user_profiles| AFTER   | UPDATE
```

## 测试案例

### 测试1: 单个培训同步

**前置条件**:
- 用户"张小美"负责1个培训"AI实战班"
- 当前姓名："会务客服-张小美"

**操作**:
```sql
-- 模拟修改姓名
UPDATE user_profiles
SET name = '张小美'
WHERE email = '2956734001@qq.com';
```

**预期结果**:
```sql
-- 培训表自动更新
SELECT conference_service_name 
FROM training_sessions 
WHERE conference_service_id = (
  SELECT id FROM user_profiles WHERE email = '2956734001@qq.com'
);
-- 结果: "张小美"
```

### 测试2: 多个培训批量同步

**前置条件**:
- 用户"李小芳"负责3个培训
- 当前姓名："会务客服-李小芳"

**操作**:
```sql
UPDATE user_profiles
SET name = '李小芳'
WHERE email = '2956734002@qq.com';
```

**预期结果**:
- 所有3个培训的 `conference_service_name` 都更新为"李小芳"

### 测试3: 频繁修改

**操作**:
```sql
-- 连续修改多次
UPDATE user_profiles SET name = '张小美A' WHERE email = '2956734001@qq.com';
UPDATE user_profiles SET name = '张小美B' WHERE email = '2956734001@qq.com';
UPDATE user_profiles SET name = '张小美C' WHERE email = '2956734001@qq.com';
```

**预期结果**:
- 每次修改都触发同步
- 最终培训表中的姓名为"张小美C"

### 测试4: 姓名未变化

**操作**:
```sql
-- 更新其他字段，姓名不变
UPDATE user_profiles 
SET phone = '13800138000'
WHERE email = '2956734001@qq.com';
```

**预期结果**:
- 触发器**不执行**（因为姓名未变化）
- 培训表不受影响
- 性能不受损

## 性能考虑

### 触发器性能

**影响**:
- 每次修改用户姓名时，需要更新该用户负责的所有培训
- 如果用户负责100个培训，会更新100条记录

**优化措施**:
1. **条件判断**: `WHEN (OLD.name IS DISTINCT FROM NEW.name)` - 只在姓名变化时执行
2. **索引支持**: `conference_service_id` 和 `salesperson_id` 已建立索引
3. **批量更新**: 一次性更新所有记录，不是逐条更新

**性能测试**:
```sql
-- 测试更新性能
EXPLAIN ANALYZE
UPDATE training_sessions
SET conference_service_name = '测试'
WHERE conference_service_id = 'USER_ID';
```

### 预期影响

**正常情况** (用户负责 < 50 个培训):
- 更新时间: < 100ms
- 对用户体验影响: 几乎无感知

**极端情况** (用户负责 > 500 个培训):
- 更新时间: 1-2秒
- 可能需要额外优化（后台异步处理）

## 技术文档

### 触发器详细说明

#### sync_conference_service_name_trigger

**作用**: 当用户姓名修改时，同步更新培训表中的会务客服姓名

**触发条件**:
- 表: `user_profiles`
- 事件: `UPDATE`
- 字段: `name`
- 时机: `AFTER`
- 条件: `OLD.name IS DISTINCT FROM NEW.name`

**执行逻辑**:
```sql
UPDATE training_sessions
SET conference_service_name = NEW.name
WHERE conference_service_id = NEW.id;
```

**影响范围**:
- 该用户作为会务客服负责的所有培训

#### sync_salesperson_name_trigger

**作用**: 当用户姓名修改时，同步更新培训表中的负责人姓名

**触发条件**:
- 表: `user_profiles`
- 事件: `UPDATE`
- 字段: `name`
- 时机: `AFTER`
- 条件: `OLD.name IS DISTINCT FROM NEW.name`

**执行逻辑**:
```sql
UPDATE training_sessions
SET salesperson_name = NEW.name
WHERE salesperson_id = NEW.id;
```

**影响范围**:
- 该用户作为负责人的所有培训

### 数据一致性保证

**机制**:
1. **触发器**: 自动同步，无需手动干预
2. **事务性**: UPDATE 和触发器在同一事务中，保证原子性
3. **条件检查**: 只在姓名真正变化时执行

**边界情况**:
- ✅ 姓名为 NULL → 有值: 触发同步
- ✅ 有值 → NULL: 触发同步
- ✅ "张三" → "张三": **不触发**（性能优化）
- ✅ "张三" → "李四": 触发同步

## 迁移文件

**文件**: `scripts/migrations/sync_conference_service_name_on_update.sql`

**执行时间**: 2025-11-16

**执行结果**: ✅ 成功

**影响**:
- ✅ 创建触发器函数（2个）
- ✅ 创建触发器（2个）
- ✅ 修复现有数据不一致问题
- ✅ 未来姓名修改自动同步

## 用户操作指南

### 修改姓名后的操作

**步骤**:
1. 修改个人姓名
2. 点击"保存"
3. **刷新浏览器页面** (Ctrl+F5 或 Cmd+Shift+R)
4. 查看培训列表/详情

**预期结果**:
- ✅ 所有培训中的姓名已更新
- ✅ 无需等待，立即生效
- ✅ 无需手动操作

### 常见问题

**Q: 我修改了姓名，但培训列表中还是旧名字？**

A: 请刷新浏览器页面（硬刷新：Ctrl+F5）。浏览器可能缓存了旧数据。

**Q: 触发器会影响性能吗？**

A: 正常情况下影响极小（< 100ms）。只有负责大量培训（> 500个）的用户可能会感知到延迟。

**Q: 历史培训的姓名会变吗？**

A: 是的。触发器会更新该用户负责的**所有培训**，包括历史培训。这是设计行为，确保数据一致性。

**Q: 如果我想保留历史姓名怎么办？**

A: 目前设计不支持。如有需求，可以：
1. 在修改前导出数据
2. 或者修改触发器逻辑，只更新未完成的培训

## 后续优化建议

### 短期优化

1. **审计日志**
   - 记录姓名修改历史
   - 显示修改时间和原因
   - 支持审计追踪

2. **用户提示**
   - 修改姓名时提示影响范围
   - 显示将要更新的培训数量
   - 确认后再执行

### 中期优化

1. **异步处理**
   - 大量培训时后台异步更新
   - 避免阻塞用户操作
   - 显示更新进度

2. **选择性同步**
   - 允许选择是否同步历史数据
   - 只更新未完成的培训
   - 保留历史培训的原始姓名

### 长期规划

1. **版本控制**
   - 培训数据支持版本控制
   - 保留每次修改的快照
   - 支持回滚到历史版本

2. **智能同步**
   - 根据业务规则决定是否同步
   - 敏感数据变更需要审批
   - 自动化数据一致性检查

## 总结

### 问题回顾

**原问题**: 修改会务客服姓名后，培训列表中的姓名未同步更新

**根本原因**: 数据冗余设计 + 缺少同步机制

### 解决方案

**实施方案**: 数据库触发器自动同步

**核心改进**:
- ✅ 自动同步姓名变更
- ✅ 修复现有数据不一致
- ✅ 支持会务客服和负责人
- ✅ 性能影响极小
- ✅ 无需手动干预

### 影响范围

**受益用户**:
- 会务客服
- 业务员
- 部门经理
- 所有修改姓名的用户

**系统改进**:
- 数据一致性提升
- 用户体验优化
- 维护成本降低

现在修改姓名后，所有相关培训的姓名会自动同步更新！🎉

## 版本历史

- **v1.0** (2025-11-15): 会务客服功能上线
- **v2.0** (2025-11-16): 培训增加会务客服字段
- **v3.1** (2025-11-16): 数据可见性限制
- **v3.2** (2025-11-16): 姓名同步问题修复 ⭐ 本次更新
