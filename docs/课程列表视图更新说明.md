# 课程列表视图更新说明

**更新日期**: 2025-11-08  
**版本**: v1.3.1

---

## 📋 更新内容

### 1. 数据库更新 ✅

**新增字段**：
```sql
ALTER TABLE courses 
ADD COLUMN project_manager_id UUID REFERENCES user_profiles(id) ON DELETE SET NULL;

CREATE INDEX idx_courses_project_manager ON courses(project_manager_id);
```

### 2. 列表视图列调整 ✅

#### 调整内容：

| 原列名 | 新列名 | 说明 |
|--------|--------|------|
| 编号 | ❌ 移除 | 不在列表中直接展示 |
| 天数 | **每期天数** | 更改列标题 |
| 场次 | **期数** | 更改列标题 |
| - | **项目负责人** ⭐ | 新增列 |

#### 最终列配置（从左到右）：

1. ☑️ **批量选择**（可选）
2. **模块**（可排序）
3. **课程名称**（可排序）
4. **每期天数**（可排序）
5. **期数**（可排序）- 显示：已有/计划
6. **项目负责人** ⭐ 新增
7. **标准费用**（可排序）
8. **状态**
9. **操作**

---

## 🔧 技术实现

### TypeScript类型更新

#### CourseDB接口：
```typescript
export interface CourseDB {
  // ... 其他字段
  project_manager_id?: string | null;
  // ...
}
```

#### Course接口：
```typescript
export interface Course {
  // ... 其他字段
  projectManagerId?: string;
  projectManagerName?: string;  // 用于显示
  // ...
}
```

### 数据加载优化

**关联查询user_profiles**：
```typescript
const { data: courses } = await supabase
  .from('courses')
  .select(`
    *,
    project_manager:user_profiles!project_manager_id(name)
  `)
  .order('module', { ascending: true })
  .order('name', { ascending: true });
```

### 显示逻辑

```typescript
// 项目负责人列
<td className="px-6 py-4 whitespace-nowrap">
  {course.projectManagerName || (
    <span className="text-gray-400">待分配</span>
  )}
</td>
```

---

## 📊 数据展示

### 每期天数列
```
显示：X天
示例：3天, 5天
```

### 期数列
```
显示：已有/计划
示例：2/4, 0/3
说明：已有场次/每年计划场次
```

### 项目负责人列
```
显示：负责人姓名 或 "待分配"
示例：张三, 李四, 待分配
```

---

## 🎨 UI效果

### 列表视图样式：
- ✅ 简洁紧凑
- ✅ 悬停高亮
- ✅ 响应式设计
- ✅ 排序图标指示
- ✅ 未分配负责人灰色显示

### 项目负责人显示：
- 已分配：黑色文字
- 待分配：灰色"待分配"文字

---

## 📝 相关文件修改

### 数据库层：
1. **Migration**: `add_project_manager_to_courses.sql`
   - 添加 `project_manager_id` 字段
   - 创建索引

### 类型定义层：
2. **src/lib/supabase/types.ts**
   - CourseDB接口添加 `project_manager_id`
   - Course接口添加 `projectManagerId` 和 `projectManagerName`
   - 更新 `dbToFrontendCourse` 转换函数

### 服务层：
3. **src/lib/services/courseService.ts**
   - `getCoursesWithSessions()` 添加关联查询
   - 映射 `projectManagerName` 字段

### UI层：
4. **src/components/CourseTable.tsx**
   - 移除编号列
   - 修改"天数"为"每期天数"
   - 修改"场次"为"期数"
   - 添加"项目负责人"列

---

## ✅ 测试检查

### 功能测试：
- [x] 列表视图正常显示
- [x] 每期天数显示正确
- [x] 期数显示格式正确（X/Y）
- [x] 项目负责人显示（有/无）
- [x] 编号列已移除
- [x] 排序功能正常
- [x] 批量选择功能正常

### 数据测试：
- [x] 有负责人的课程显示名称
- [x] 无负责人的课程显示"待分配"
- [x] 关联查询性能正常
- [x] 索引创建成功

---

## 🔄 后续功能

### 待实现：
1. **在课程表单中添加负责人选择器**
   - 下拉列表选择用户
   - 仅显示有权限的用户

2. **批量分配负责人**
   - 支持批量选择课程
   - 统一分配负责人

3. **负责人筛选**
   - 按负责人筛选课程
   - 查看负责人的所有课程

---

## 📖 使用说明

### 查看列表视图：
1. 进入课程管理页面
2. 点击列表视图图标
3. 查看完整列表（包含项目负责人）

### 排序：
- 点击列标题进行排序
- 支持：模块、名称、天数、期数、费用

### 项目负责人：
- 显示负责人姓名
- 暂未分配显示"待分配"
- 后续可在编辑课程时设置

---

## 🎯 关键变更

### 最重要的3个变更：
1. ✅ **移除编号列** - 简化界面
2. ✅ **添加项目负责人列** - 管理需求
3. ✅ **优化列名** - 更符合业务术语

### 术语统一：
- ❌ 天数 → ✅ 每期天数
- ❌ 场次 → ✅ 期数
- ✅ 新增：项目负责人

---

## 💡 注意事项

### 开发注意：
1. `project_manager_id` 允许为NULL（可选字段）
2. 关联查询使用左连接（支持无负责人的课程）
3. 显示逻辑优先使用 `projectManagerName`
4. 删除负责人时，课程的 `project_manager_id` 自动设为NULL

### 性能优化：
- ✅ 已创建索引 `idx_courses_project_manager`
- ✅ 使用关联查询减少请求次数
- ✅ 前端缓存课程数据

---

## 📊 数据统计

### 字段统计：
```
courses表：
- 原字段数：15
- 新字段数：16 (+1)
- 新增：project_manager_id

Course类型：
- 原字段数：13
- 新字段数：15 (+2)
- 新增：projectManagerId, projectManagerName
```

### 列表视图列统计：
```
原列数：8 (含编号)
新列数：8 (移除编号，新增负责人)
可排序列：5个
固定列：3个（状态、负责人、操作）
```

---

## 🚀 上线清单

### 部署前：
- [x] 数据库迁移脚本准备
- [x] TypeScript类型更新
- [x] 服务层更新
- [x] UI组件更新
- [x] 测试通过

### 部署时：
1. 执行数据库迁移
2. 重启前端服务
3. 刷新浏览器缓存
4. 验证功能

### 部署后：
- [ ] 验证列表视图显示
- [ ] 验证负责人显示
- [ ] 验证排序功能
- [ ] 收集用户反馈

---

**状态**: ✅ 开发完成  
**可用性**: ✅ 立即可用  
**文档状态**: ✅ 完整

**刷新浏览器即可查看新的列表视图！**
