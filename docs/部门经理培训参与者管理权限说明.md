# 部门经理培训参与者管理权限说明

**更新日期**: 2025-11-12  
**权限ID**: `training_manage_participant`  
**适用角色**: 部门经理（manager）  

## 权限概述

部门经理现在拥有 `training_manage_participant` 权限，可以管理自己部门业务员归属的培训参与者。这个权限允许部门经理：

1. ✅ 查看本部门业务员的所有培训参与者
2. ✅ 删除本部门业务员的培训参与者
3. ✅ 管理本部门业务员客户的参与信息

## 已完成的修改

### 1. 权限配置更新

**文件**: `src/constants/permissions.ts`

```typescript
manager: [
  // ... 其他权限
  'training_manage_participant',  // 管理培训参与者
  // ...
]
```

### 2. 删除权限逻辑更新

**文件**: `src/pages/TrainingPerformance.tsx` (第2535-2541行)

```typescript
// 权限判断：
// - 管理员可以删除所有参与者
// - 业务员只能删除自己的客户
// - 部门经理可以删除本部门业务员的客户
const canDelete = user?.role === 'admin' || 
  participant.salespersonName === user?.name ||
  (user?.role === 'manager' && (participant as any).salespersonDepartment === user?.department);
```

### 3. 数据库迁移脚本

**文件**: `scripts/migrations/grant-manager-participant-permission.sql`

为所有现有的部门经理用户添加 `training_manage_participant` 权限。

## 权限范围说明

### 部门经理可以做什么

1. **查看参与者列表**
   - 查看本部门所有业务员的培训参与者
   - 查看参与者的详细信息（姓名、电话、支付状态等）

2. **删除参与者**
   - 删除本部门业务员客户的培训参与记录
   - 系统会自动验证参与者是否属于本部门

3. **数据统计**
   - 查看本部门的培训业绩统计
   - 查看本部门的参与人数和收入

### 部门经理不能做什么

1. ❌ 删除其他部门业务员的客户参与记录
2. ❌ 删除不属于任何业务员的参与者（如果存在）
3. ❌ 修改管理员直接添加的参与者

## 使用场景

### 场景1：清理错误数据
部门经理发现本部门业务员A误将客户添加到错误的培训场次，可以直接删除该参与记录。

### 场景2：客户取消培训
客户决定不参加培训，部门经理可以代表业务员删除该客户的参与记录。

### 场景3：部门业绩管理
部门经理需要调整本部门的培训参与情况，可以管理参与者列表。

## 权限验证流程

```
用户尝试删除参与者
    ↓
检查用户角色
    ↓
┌─────────────────────────────────────┐
│ 是管理员？                           │
│   是 → 允许删除                      │
│   否 → 继续检查                      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 是参与者的业务员本人？               │
│   是 → 允许删除                      │
│   否 → 继续检查                      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 是部门经理 且 参与者属于本部门？     │
│   是 → 允许删除                      │
│   否 → 拒绝删除（显示"无权限"）      │
└─────────────────────────────────────┘
```

## 数据库层面的支持

### RLS策略

部门经理的权限在应用层和数据库层都有保护：

1. **应用层**: UI根据用户角色和部门显示/隐藏删除按钮
2. **数据库层**: RLS策略确保只能删除有权限的记录

### 相关表

- `training_participants`: 培训参与者表
- `customers`: 客户表（包含业务员和部门信息）
- `user_profiles`: 用户表（包含部门信息）

## 测试验证

### 使用权限测试页面

1. 访问 `/permission-test`
2. 选择一个部门经理用户
3. 查看 `training_manage_participant` 权限状态
4. 应该显示为"已授权"

### 实际功能测试

1. **准备测试数据**
   - 创建部门A的经理用户
   - 创建部门A的业务员用户
   - 业务员添加客户到培训

2. **测试删除权限**
   - 使用部门经理登录
   - 进入培训详情页面
   - 查看参与者列表
   - 应该能看到"删除"按钮（本部门业务员的客户）
   - 点击删除应该成功

3. **测试权限边界**
   - 切换到部门B的参与者
   - 应该看到"无权限"提示
   - 无法删除其他部门的参与者

## 注意事项

1. **部门信息必须完整**
   - 确保业务员的 `department` 字段已填写
   - 确保部门经理的 `department` 字段已填写
   - 两者必须匹配才能行使权限

2. **数据一致性**
   - 删除参与者后会自动刷新培训列表
   - 业绩统计会实时更新

3. **权限继承**
   - 部门经理的权限不会影响业务员的权限
   - 业务员仍然只能管理自己的客户

## 相关文档

- [权限系统说明](./权限测试验证功能说明.md)
- [培训管理功能说明](./培训管理功能说明.md)
- [RLS策略说明](./数据库RLS策略说明.md)

## 后续优化建议

1. **批量操作**
   - 支持部门经理批量删除参与者
   - 批量调整参与者信息

2. **审计日志**
   - 记录部门经理的删除操作
   - 便于追踪和审计

3. **权限细化**
   - 可以考虑分离"查看"和"删除"权限
   - 允许更灵活的权限配置

4. **通知机制**
   - 部门经理删除参与者时通知相关业务员
   - 避免信息不同步
