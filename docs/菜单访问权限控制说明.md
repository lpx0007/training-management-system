# 菜单访问权限控制说明

**创建日期**: 2025-11-12  
**功能类型**: 权限控制增强  
**数据库脚本**: `scripts/migrations/add-menu-access-table.sql`  

## 概述

菜单访问权限控制是权限系统的重要组成部分，它控制用户能看到哪些导航菜单项。结合具体的功能权限，实现细粒度的访问控制。

## 双层控制机制

### 1. 菜单访问权限（Menu Access）
- **作用**：控制用户是否能看到某个菜单项
- **存储位置**：`user_menu_access` 表
- **管理方式**：管理员可以为每个用户单独开启或关闭菜单访问

### 2. 功能权限（Permissions）
- **作用**：控制用户在菜单内能执行的具体操作
- **存储位置**：`user_permissions` 表
- **管理方式**：通过权限管理页面分配

## 菜单显示逻辑

```
菜单显示 = 菜单访问权限开启 AND 拥有所需权限之一
```

### 示例

以"客户管理"菜单为例：

1. **用户A**（业务员）
   - ✅ 有菜单访问权限
   - ✅ 有 `customer_view` 权限
   - **结果**：可以看到"客户管理"菜单

2. **用户B**（新用户）
   - ✅ 有菜单访问权限
   - ❌ 没有 `customer_view` 权限
   - **结果**：看不到"客户管理"菜单

3. **用户C**（受限用户）
   - ❌ 没有菜单访问权限
   - ✅ 有 `customer_view` 权限
   - **结果**：看不到"客户管理"菜单

## 数据库表结构

### user_menu_access 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | UUID | 用户ID |
| menu_feature_id | VARCHAR(100) | 菜单功能ID |
| enabled | BOOLEAN | 是否启用 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

## 默认配置

### 管理员（admin）
- 默认拥有所有菜单的访问权限

### 业务员（salesperson）
默认菜单：
- 仪表盘
- 课程管理
- 培训计划
- 客户管理
- 招商简章
- 个人设置

### 专家（expert）
默认菜单：
- 仪表盘
- 培训计划
- 专家管理
- 招商简章
- 个人设置

### 部门经理（manager）
默认菜单：
- 仪表盘
- 课程管理
- 培训计划
- 销售追踪
- 业务员管理
- 客户管理
- 专家管理
- 招商简章
- 海报生成
- 个人设置

## 应用迁移

### 1. 执行SQL脚本

```bash
# 使用Supabase CLI
supabase db reset
supabase db push

# 或直接在Supabase控制台执行
scripts/migrations/add-menu-access-table.sql
```

### 2. 验证安装

```sql
-- 检查表是否创建成功
SELECT COUNT(*) FROM user_menu_access;

-- 查看各角色的菜单权限
SELECT 
    up.name,
    up.role,
    COUNT(uma.menu_feature_id) as menu_count
FROM user_profiles up
LEFT JOIN user_menu_access uma ON up.id = uma.user_id
WHERE uma.enabled = true
GROUP BY up.id, up.name, up.role;
```

## 权限测试

使用权限测试页面验证菜单显示权限：

1. 访问 `/permission-test`
2. 选择要测试的用户
3. 切换到"菜单显示测试"选项卡
4. 查看各菜单的显示状态和原因

## 代码集成

### Sidebar组件
```typescript
// 过滤菜单项
const filteredMenuItems = MENU_FEATURES.filter(feature => {
  // 1. 检查菜单访问权限
  if (!canAccessMenu(feature.id)) {
    return false;
  }
  
  // 2. 检查功能权限
  if (feature.requiredPermissions.length > 0) {
    return hasAnyPermission(feature.requiredPermissions);
  }
  
  return true;
});
```

### AuthContext
```typescript
// 检查菜单访问权限
const canAccessMenu = (menuId: string) => {
  return userMenuAccess.has(menuId);
};
```

## 注意事项

1. **向后兼容**
   - 如果 `user_menu_access` 表不存在，系统会回退到仅使用权限控制
   - 测试页面会自动处理表不存在的情况

2. **性能考虑**
   - 菜单权限在用户登录时加载一次
   - 使用Set数据结构优化查找性能

3. **安全性**
   - RLS策略确保用户只能查看自己的菜单权限
   - 只有管理员可以修改菜单权限

## 常见问题

### Q: 为什么用户有权限但看不到菜单？
A: 检查以下几点：
1. 用户的菜单访问权限是否开启
2. 用户是否拥有菜单所需的权限之一
3. 数据库中是否有对应的记录

### Q: 如何为新用户设置默认菜单？
A: 
1. 在创建用户时，根据角色插入默认的菜单访问记录
2. 或使用批量设置功能为某个角色的所有用户设置菜单

### Q: 菜单权限和功能权限有什么区别？
A: 
- 菜单权限：控制是否显示菜单入口
- 功能权限：控制进入菜单后能执行的操作
- 两者结合实现完整的访问控制
