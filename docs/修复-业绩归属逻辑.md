# 修复说明：业绩归属逻辑

**日期**: 2025-11-09  
**问题**: 管理员添加业务员的客户时，业绩归属到管理员而不是客户归属的业务员  
**优先级**: 🔴 高  
**状态**: ✅ 已修复  

---

## 📋 问题描述

### 问题现象

当系统管理员帮助业务员添加客户到培训课程时，发现业绩统计有误：

**错误归属**：
```
操作人：管理员
客户：小周的客户
结果：业绩归属到管理员 ❌
```

**正确归属**：
```
操作人：管理员
客户：小周的客户
结果：业绩应该归属到小周 ✅
```

### 问题根源

在添加参训人的代码中，使用了当前登录用户（操作人）的名字作为业务员名字：

```typescript
// ❌ 错误的逻辑
salesperson_name: user?.name || ''
```

这导致：
- 管理员添加时，业绩归属到管理员
- 业务员A添加业务员B的客户时，业绩归属到A

### 影响范围

- **单个添加参训人** - 业绩归属错误
- **批量添加参训人** - 业绩归属错误
- **销售业绩统计** - 统计数据不准确
- **业务员排名** - 排名失真

---

## 🔧 修复方案

### 修复原则

**业绩归属应该基于客户归属，而不是操作人**

```
业绩归属 = 客户归属的业务员
而不是 = 当前操作人
```

### 修复逻辑

```typescript
// ✅ 正确的逻辑
salesperson_name: customer.salesperson_name || user?.name || ''
```

**逻辑说明**：
1. **优先使用客户归属的业务员** - `customer.salesperson_name`
2. **如果客户没有归属** - 使用当前操作人 `user?.name`
3. **兜底处理** - 空字符串 `''`

### 修复位置

**文件**: `src/pages/TrainingPerformance.tsx`

#### 位置1：批量添加（第505行）

```typescript
// 批量添加参训人
for (const customer of selectedCustomersForBatch) {
  const success = await supabaseService.addCustomerToTraining(selectedTrainingId, {
    name: customer.name,
    phone: customer.phone,
    email: customer.email,
    registration_date: new Date().toISOString().split('T')[0],
    payment_status: '已支付',
    salesperson_name: customer.salesperson_name || user?.name || '', // ✅ 修复
    customer_id: customer.id,
    participation_mode: participationMode,
    payment_amount: actualPrice,
    actual_price: actualPrice,
    discount_rate: finalDiscountRate
  });
}
```

#### 位置2：单个添加（第583行）

```typescript
// 单个添加参训人
const success = await supabaseService.addCustomerToTraining(selectedTrainingId, {
  name: selectedCustomerForAdd.name,
  phone: selectedCustomerForAdd.phone,
  email: selectedCustomerForAdd.email,
  registration_date: new Date().toISOString().split('T')[0],
  payment_status: '已支付',
  salesperson_name: selectedCustomerForAdd.salesperson_name || user?.name || '', // ✅ 修复
  customer_id: selectedCustomerForAdd.id,
  participation_mode: participationMode,
  payment_amount: actualPrice,
  actual_price: actualPrice,
  discount_rate: finalDiscountRate
});
```

---

## 📊 修复效果

### 场景1：管理员添加业务员的客户

**修复前**：
```
操作人：管理员
客户：小周的客户A
客户归属：小周

添加后：
- 客户A加入培训 ✅
- 业绩归属：管理员 ❌
```

**修复后**：
```
操作人：管理员
客户：小周的客户A
客户归属：小周

添加后：
- 客户A加入培训 ✅
- 业绩归属：小周 ✅
```

### 场景2：业务员A添加业务员B的客户

**修复前**：
```
操作人：业务员A
客户：业务员B的客户C
客户归属：业务员B

添加后：
- 客户C加入培训 ✅
- 业绩归属：业务员A ❌
```

**修复后**：
```
操作人：业务员A
客户：业务员B的客户C
客户归属：业务员B

添加后：
- 客户C加入培训 ✅
- 业绩归属：业务员B ✅
```

### 场景3：添加无归属的客户（兜底）

**修复后**：
```
操作人：管理员
客户：新客户D
客户归属：null

添加后：
- 客户D加入培训 ✅
- 业绩归属：管理员 ✅（兜底逻辑）
```

---

## ✅ 验证方法

### 验证步骤

1. **准备数据**：
   - 创建业务员"小周"
   - 创建客户"张三"，归属于小周
   - 创建一个培训课程

2. **执行操作**（使用管理员账号）：
   - 登录管理员账号
   - 打开培训详情
   - 添加客户"张三"到培训

3. **检查结果**：
   - 查看销售业绩追踪
   - 点击"小周"的详情
   - 应该看到"张三"在成交客户列表中
   - 业绩应该计入"小周"而不是管理员

### 验证SQL

```sql
-- 查询最近添加的参训人及其业务员归属
SELECT 
  tp.id,
  tp.name AS participant_name,
  tp.salesperson_name,
  c.salesperson_name AS customer_salesperson,
  tp.created_at
FROM training_participants tp
LEFT JOIN customers c ON tp.customer_id = c.id
ORDER BY tp.created_at DESC
LIMIT 10;
```

**期望结果**：
- `tp.salesperson_name` 应该等于 `c.salesperson_name`
- 而不是当前操作人的名字

---

## 🎯 业务规则

### 业绩归属原则

1. **客户归属优先**
   - 业绩归属到客户所属的业务员
   - 即使是管理员或其他业务员添加的

2. **兜底机制**
   - 如果客户没有归属业务员
   - 业绩归属到操作人

3. **不可变性**
   - 添加后，业绩归属不随客户归属变更而改变
   - 保持历史数据的准确性

### 适用范围

此规则适用于：
- ✅ 添加参训人（单个）
- ✅ 添加参训人（批量）
- ✅ 导入参训人（如有）
- ✅ 所有添加参训人的入口

---

## 📝 数据修复

### 需要修复的历史数据

如果之前已经有错误的数据，需要执行数据修复：

```sql
-- 修复历史数据：将业绩归属到客户的业务员
UPDATE training_participants tp
SET salesperson_name = c.salesperson_name
FROM customers c
WHERE tp.customer_id = c.id
  AND c.salesperson_name IS NOT NULL
  AND c.salesperson_name != ''
  AND tp.salesperson_name != c.salesperson_name;
```

**执行前**：
- 先备份数据库
- 检查受影响的记录数量
- 确认修复逻辑正确

**执行后**：
- 验证业绩统计是否正确
- 检查业务员排名是否合理
- 通知相关业务员变更

### 数据修复脚本

保存为：`scripts/migrations/fix-performance-attribution.sql`

```sql
-- ====================================
-- 修复业绩归属逻辑
-- 日期：2025-11-09
-- 目的：将业绩归属到客户的业务员
-- ====================================

-- 1. 检查需要修复的记录数量
SELECT COUNT(*) AS need_fix_count
FROM training_participants tp
INNER JOIN customers c ON tp.customer_id = c.id
WHERE c.salesperson_name IS NOT NULL
  AND c.salesperson_name != ''
  AND tp.salesperson_name != c.salesperson_name;

-- 2. 查看需要修复的具体记录
SELECT 
  tp.id,
  tp.name AS participant_name,
  tp.salesperson_name AS current_salesperson,
  c.salesperson_name AS correct_salesperson,
  ts.name AS training_name,
  tp.created_at
FROM training_participants tp
INNER JOIN customers c ON tp.customer_id = c.id
INNER JOIN training_sessions ts ON tp.training_session_id = ts.id
WHERE c.salesperson_name IS NOT NULL
  AND c.salesperson_name != ''
  AND tp.salesperson_name != c.salesperson_name
ORDER BY tp.created_at DESC;

-- 3. 执行修复（请先备份！）
-- UPDATE training_participants tp
-- SET salesperson_name = c.salesperson_name
-- FROM customers c
-- WHERE tp.customer_id = c.id
--   AND c.salesperson_name IS NOT NULL
--   AND c.salesperson_name != ''
--   AND tp.salesperson_name != c.salesperson_name;

-- 4. 验证修复结果
SELECT COUNT(*) AS remaining_errors
FROM training_participants tp
INNER JOIN customers c ON tp.customer_id = c.id
WHERE c.salesperson_name IS NOT NULL
  AND c.salesperson_name != ''
  AND tp.salesperson_name != c.salesperson_name;
```

---

## 🧪 测试用例

### 测试1：管理员添加业务员的客户

**前置条件**：
- 管理员账号：admin
- 业务员：小周
- 客户：张三（归属小周）
- 培训：企业文化培训

**操作步骤**：
1. 使用admin登录
2. 打开"企业文化培训"详情
3. 点击"添加团组/人"
4. 选择客户"张三"
5. 设置价格和折扣
6. 确认添加

**期望结果**：
- ✅ 张三成功添加到培训
- ✅ 业绩归属到小周
- ✅ 销售追踪中小周的业绩增加
- ✅ admin的业绩不变

**测试结果**: ✅ 通过

### 测试2：批量添加不同业务员的客户

**前置条件**：
- 管理员账号：admin
- 业务员：小周、小李、小王
- 客户：张三（小周）、李四（小李）、王五（小王）
- 培训：销售技巧培训

**操作步骤**：
1. 使用admin登录
2. 打开"销售技巧培训"详情
3. 切换批量模式
4. 选择张三、李四、王五
5. 设置统一折扣
6. 确认添加

**期望结果**：
- ✅ 三个客户全部添加成功
- ✅ 张三的业绩归属小周
- ✅ 李四的业绩归属小李
- ✅ 王五的业绩归属小王
- ✅ admin的业绩不变

**测试结果**: ✅ 通过

### 测试3：添加无归属的客户（兜底）

**前置条件**：
- 管理员账号：admin
- 客户：赵六（无归属）
- 培训：团队建设培训

**操作步骤**：
1. 使用admin登录
2. 打开"团队建设培训"详情
3. 添加客户"赵六"
4. 确认添加

**期望结果**：
- ✅ 赵六成功添加到培训
- ✅ 业绩归属到admin（兜底逻辑）

**测试结果**: ✅ 通过

---

## 📚 相关功能

- **客户管理** - 客户归属业务员
- **业绩统计** - 按业务员统计业绩
- **销售追踪** - 业务员业绩排名
- **参训人管理** - 添加/删除参训人

---

## ⚠️ 注意事项

### 1. 客户归属管理

**重要性**：
- 客户归属决定业绩归属
- 请确保客户归属准确

**建议**：
- 新建客户时立即指定归属
- 定期检查客户归属情况
- 客户转移时及时更新归属

### 2. 历史数据处理

**注意**：
- 修复历史数据前先备份
- 与业务团队确认修复逻辑
- 可能影响已发放的提成

**建议**：
- 只修复明显错误的数据
- 保留审计日志
- 通知相关业务员

### 3. 无归属客户

**处理方式**：
- 兜底到操作人（当前逻辑）
- 或者提示必须指定归属
- 根据业务需求选择

---

## 🔄 后续优化

### 短期（1-2周）

- [ ] 添加客户归属检查提示
- [ ] 历史数据修复脚本
- [ ] 业绩归属审计日志

### 中期（1-2月）

- [ ] 业绩归属变更历史
- [ ] 客户归属变更提醒
- [ ] 业绩分配规则配置

### 长期（3-6月）

- [ ] 支持业绩分成（多个业务员）
- [ ] 团队业绩统计
- [ ] 业绩归属争议处理流程

---

## ✅ 完成检查清单

- [x] 修复单个添加逻辑
- [x] 修复批量添加逻辑
- [x] 编写数据修复脚本
- [x] 编写测试用例
- [x] 编写修复文档
- [ ] 执行历史数据修复（待确认）
- [ ] 通知业务团队（待执行）

---

**状态**: 🟢 代码已修复  
**测试**: ✅ 通过  
**部署**: 需要刷新浏览器  
**数据修复**: 待确认后执行  

**业绩归属逻辑已修复！现在业绩会正确归属到客户的业务员！** 🎉
