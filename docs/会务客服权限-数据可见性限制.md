# 会务客服权限 - 数据可见性限制

**更新日期**: 2025-11-16  
**版本**: v3.1  
**状态**: ✅ 已完成  

## 需求概述

会务客服的默认权限应该只能看到和自己相关的培训课程，即只能看到分配给自己负责的培训。

## 权限模型

### 角色数据可见性对比

| 角色 | 数据可见范围 | 过滤条件 |
|------|-------------|---------|
| **管理员** | 所有培训 | 无限制 |
| **业务员** | 自己客户参与的培训 | `participants.salesperson_id = user.id` |
| **专家** | 自己授课的培训 | `expert_id = user.id` |
| **部门经理** | 本部门业务员的培训 | `department_id = user.department` |
| **会务客服** ⭐ | 分配给自己的培训 | `conference_service_id = user.id` |

### 会务客服权限详解

**可见数据**:
- ✅ 仅显示 `conference_service_id` 等于当前用户ID的培训
- ✅ 只能看到自己负责的培训详情
- ✅ 只能修改自己负责培训的参训人信息

**不可见数据**:
- ❌ 其他会务客服负责的培训
- ❌ 未分配会务客服的培训
- ❌ 全局培训列表（管理员视图）

## 技术实现

### 数据过滤逻辑

**文件**: `src/pages/TrainingPerformance.tsx` (第103-109行)

```typescript
// 如果是会务客服，过滤出分配给自己的培训
if (isConferenceService && user?.id) {
  trainingSessions = trainingSessions.filter(session => 
    session.conferenceServiceId === user.id
  );
  console.log('🎯 会务客服过滤后的培训:', trainingSessions);
}
```

**过滤条件**:
- 检查当前用户角色是否为 `conference_service`
- 检查用户ID是否存在
- 过滤出 `conferenceServiceId` 等于当前用户ID的培训

### 完整数据加载流程

```typescript
// 1. 获取用户信息
const isAdmin = user?.role === 'admin';
const isExpert = user?.role === 'expert';
const isConferenceService = user?.role === 'conference_service';

// 2. 确定查询参数
const salespersonName = (isAdmin || isExpert || isConferenceService) 
  ? undefined 
  : user?.name;

// 3. 获取培训数据
let trainingSessions = await supabaseService.getTrainingSessions(salespersonName);

// 4. 专家过滤
if (isExpert && user?.name) {
  trainingSessions = trainingSessions.filter(session => 
    session.expert === user.name
  );
}

// 5. 会务客服过滤 ⭐ 新增
if (isConferenceService && user?.id) {
  trainingSessions = trainingSessions.filter(session => 
    session.conferenceServiceId === user.id
  );
}
```

### 数据流程图

```
用户登录
   ↓
判断角色
   ↓
┌─────────────────┐
│   管理员？       │ → 是 → 显示所有培训
└─────────────────┘
   ↓ 否
┌─────────────────┐
│   专家？         │ → 是 → 过滤：expert_id = user.id
└─────────────────┘
   ↓ 否
┌─────────────────┐
│   会务客服？ ⭐  │ → 是 → 过滤：conference_service_id = user.id
└─────────────────┘
   ↓ 否
┌─────────────────┐
│   业务员         │ → 过滤：自己客户参与的培训
└─────────────────┘
```

## 使用场景

### 场景1: 会务客服查看培训列表

**操作**:
1. 会务客服登录系统
2. 进入"培训计划"页面
3. 查看培训列表

**结果**:
- ✅ 只显示分配给自己的培训
- ❌ 不显示其他会务客服负责的培训
- ❌ 不显示未分配会务客服的培训

**示例**:
```
会务客服: 李小芳 (ID: abc-123)

培训列表:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ AI技术培训班 (conference_service_id: abc-123)
✅ 企业数字化培训 (conference_service_id: abc-123)
❌ React高级开发 (conference_service_id: def-456) - 张小美负责
❌ Python进阶 (conference_service_id: null) - 未分配
```

### 场景2: 管理员分配会务客服

**操作**:
1. 管理员编辑培训
2. 在"会务客服"下拉框选择"李小芳"
3. 保存

**结果**:
- ✅ 李小芳可以看到这个培训
- ✅ 其他会务客服看不到这个培训
- ✅ 李小芳可以修改该培训的参训人信息

### 场景3: 会务客服查看培训详情

**操作**:
1. 会务客服点击培训名称
2. 查看详情页

**可访问的功能**:
- ✅ 查看培训基本信息
- ✅ 查看参训人列表
- ✅ 修改参训人信息
- ✅ 导出参训人明细
- ✅ 下载招商简章和课表
- ✅ 查看客户信息

**不可访问的功能**:
- ❌ 编辑培训基本信息（只有管理员可以）
- ❌ 删除培训（只有管理员可以）
- ❌ 添加/删除参训人（只有管理员和业务员可以）

### 场景4: 未分配会务客服的培训

**情况**: 培训的 `conference_service_id` 为 `null`

**结果**:
- ✅ 管理员可以看到
- ❌ 所有会务客服都看不到
- ✅ 业务员和专家根据自己的权限决定

## 权限对比表

### 培训管理权限

| 功能 | 管理员 | 业务员 | 专家 | 部门经理 | 会务客服 |
|------|-------|-------|------|---------|---------|
| 查看所有培训 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 查看自己相关的培训 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 添加培训 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 编辑培训信息 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 删除培训 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 分配会务客服 | ✅ | ❌ | ❌ | ❌ | ❌ |

### 参训人管理权限

| 功能 | 管理员 | 业务员 | 专家 | 部门经理 | 会务客服 |
|------|-------|-------|------|---------|---------|
| 查看参训人列表 | ✅ | ✅ 自己的 | ✅ | ✅ | ✅ 自己负责培训的 |
| 添加参训人 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 修改参训人信息 | ✅ | ✅ 自己的 | ❌ | ❌ | ✅ 自己负责培训的 |
| 删除参训人 | ✅ | ✅ 自己的 | ❌ | ❌ | ❌ |
| 导出参训人明细 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 查看客户信息 | ✅ | ✅ | ❌ | ✅ | ✅ |

## 安全考虑

### 数据隔离

**前端过滤**:
```typescript
// 客户端过滤，防止显示未授权数据
if (isConferenceService && user?.id) {
  trainingSessions = trainingSessions.filter(session => 
    session.conferenceServiceId === user.id
  );
}
```

**优点**:
- 快速响应，不需要额外的服务器请求
- 减少网络传输

**注意**:
- 前端过滤不能替代后端权限验证
- 敏感操作（修改、删除）必须在后端验证权限

### 后端权限验证

**建议**: 在API层添加Row Level Security (RLS)策略

```sql
-- 会务客服只能查看自己负责的培训
CREATE POLICY "Conference service can view assigned trainings"
ON training_sessions
FOR SELECT
USING (
  CASE 
    WHEN auth.jwt() ->> 'role' = 'conference_service'
    THEN conference_service_id = auth.uid()
    ELSE true
  END
);
```

**优势**:
- 数据库层面的安全保障
- 即使前端被绕过，后端仍然安全
- 防止API直接访问

## 测试验证

### 测试账号

**会务客服1**:
```
邮箱: 2956734001@qq.com
密码: Test123456!
姓名: 会务客服-张小美
```

**会务客服2**:
```
邮箱: 2956734002@qq.com
密码: Test123456!
姓名: 会务客服-李小芳
```

### 测试步骤

#### 测试1: 基本数据过滤

**步骤**:
1. 管理员创建3个培训
   - 培训A: 分配给"张小美"
   - 培训B: 分配给"李小芳"
   - 培训C: 未分配会务客服

2. 登录"张小美"账号
3. 查看培训列表

**预期结果**:
- ✅ 只显示培训A
- ❌ 不显示培训B
- ❌ 不显示培训C

#### 测试2: 切换账号

**步骤**:
1. 退出"张小美"账号
2. 登录"李小芳"账号
3. 查看培训列表

**预期结果**:
- ❌ 不显示培训A
- ✅ 只显示培训B
- ❌ 不显示培训C

#### 测试3: 修改分配

**步骤**:
1. 管理员将培训A的会务客服从"张小美"改为"李小芳"
2. "张小美"刷新页面
3. "李小芳"刷新页面

**预期结果**:
- "张小美": ❌ 不再显示培训A
- "李小芳": ✅ 新增显示培训A

#### 测试4: 清空分配

**步骤**:
1. 管理员将培训B的会务客服设为"未分配"
2. "李小芳"刷新页面

**预期结果**:
- "李小芳": ❌ 不再显示培训B

#### 测试5: 参训人管理

**步骤**:
1. "张小美"查看自己负责的培训A
2. 点击参训人"修改"按钮
3. 修改参训人信息并保存

**预期结果**:
- ✅ 修改成功
- ✅ 审计日志记录修改操作

#### 测试6: 跨权限访问

**步骤**:
1. "张小美"尝试直接访问培训B的URL
2. 查看是否能看到培训B的详情

**预期结果**:
- ❌ 无法访问（需要后端RLS支持）
- ✅ 前端应该隐藏该培训

## 用户体验优化

### 空状态提示

当会务客服没有分配任何培训时：

```
┌─────────────────────────────────────┐
│   📋 暂无分配的培训                  │
│                                      │
│   您还没有负责任何培训课程           │
│   请联系管理员为您分配培训           │
└─────────────────────────────────────┘
```

### 权限提示

当会务客服尝试访问未授权功能时：

```
⚠️ 权限不足
您只能管理分配给自己的培训课程
如需查看其他培训，请联系管理员
```

## 文件修改清单

### 前端文件

1. ✅ **`src/pages/TrainingPerformance.tsx`** (第80-109行)
   - 添加会务客服角色判断
   - 添加会务客服数据过滤逻辑
   - 添加调试日志

### 数据库（建议）

2. 🔜 **RLS策略** (待实现)
   - 添加培训表的RLS策略
   - 限制会务客服只能查询自己负责的培训
   - 限制会务客服只能修改自己负责培训的参训人

## 后续优化建议

### 短期优化

1. **数据库RLS策略**
   - 添加Row Level Security策略
   - 确保后端数据安全
   - 防止API绕过

2. **错误处理**
   - 友好的空状态提示
   - 清晰的权限错误提示
   - 帮助文档链接

3. **性能优化**
   - 只查询会务客服相关的培训（后端过滤）
   - 减少前端过滤的数据量
   - 提升加载速度

### 中期优化

1. **工作台视图**
   - 会务客服专属工作台
   - 待处理事项提醒
   - 快速操作入口

2. **批量操作**
   - 批量查看多个培训
   - 批量导出参训人
   - 批量下载资料

3. **数据统计**
   - 显示负责的培训数量
   - 显示参训人总数
   - 显示待办事项

### 长期规划

1. **智能推荐**
   - 根据工作量自动分配培训
   - 智能提醒待处理事项
   - 个性化工作建议

2. **移动端支持**
   - 移动端查看培训
   - 移动端修改参训人
   - 实时消息推送

## 总结

本次更新实现了会务客服的数据可见性限制：

**核心改进**:
- ✅ 会务客服只能看到分配给自己的培训
- ✅ 数据隔离，保护其他会务客服的数据
- ✅ 与专家、业务员的权限模型保持一致

**安全保障**:
- ✅ 前端数据过滤
- 🔜 后端RLS策略（建议实现）
- ✅ 清晰的权限边界

**用户体验**:
- ✅ 清晰的数据范围
- ✅ 减少信息干扰
- ✅ 聚焦于自己的工作

会务客服现在拥有明确且安全的数据访问权限！🎯

## 版本历史

- **v1.0** (2025-11-15): 会务客服角色创建
- **v2.0** (2025-11-15): 会务客服权限扩展
- **v3.0** (2025-11-16): 培训增加会务客服字段
- **v3.1** (2025-11-16): 数据可见性限制 ⭐ 本次更新
