# 部门经理权限完整配置

**更新日期**: 2025-11-12  
**角色**: 部门经理（manager）  

## 权限清单

部门经理拥有以下权限，可以管理本部门的业务和数据：

### 客户管理权限 (6个)

| 权限ID | 权限名称 | 说明 |
|--------|---------|------|
| `customer_view` | 查看客户 | 查看客户基本信息 |
| `customer_view_all` | 查看所有客户 | 可以查看本部门所有业务员的客户 |
| `customer_add` | 添加客户 | 添加新客户到系统 |
| `customer_edit` | 编辑客户 | 编辑客户信息 |
| `customer_delete` | 删除客户 | 删除客户记录 |
| `customer_export` | 导出客户 | 导出客户数据 |

### 培训管理权限 (4个)

| 权限ID | 权限名称 | 说明 |
|--------|---------|------|
| `training_view` | 查看培训 | 查看培训场次信息 |
| `training_manage_participant` | 管理培训参与者 | **新增** 管理本部门业务员的培训参与者 |
| `training_view_stats` | 查看培训统计 | 查看培训统计数据 |
| `training_export` | 导出培训 | 导出培训数据 |

### 业务员管理权限 (4个)

| 权限ID | 权限名称 | 说明 |
|--------|---------|------|
| `salesperson_view` | 查看业务员 | 查看业务员信息 |
| `salesperson_add` | 添加业务员 | 添加新业务员 |
| `salesperson_edit` | 编辑业务员 | 编辑业务员信息 |
| `salesperson_view_performance` | 查看业务员绩效 | 查看本部门业务员绩效 |

### 招商简章权限 (2个)

| 权限ID | 权限名称 | 说明 |
|--------|---------|------|
| `prospectus_view` | 查看简章 | 查看招商简章 |
| `prospectus_download` | 下载简章 | 下载招商简章文件 |

### 数据管理权限 (2个)

| 权限ID | 权限名称 | 说明 |
|--------|---------|------|
| `performance_export` | 导出业绩 | 导出业绩数据 |
| `data_view_history` | 查看数据历史 | 查看数据操作历史 |

**总计**: 18个权限

## 本次更新内容

### ✅ 新增权限

**`training_manage_participant` - 管理培训参与者**

- **用途**: 允许部门经理管理本部门业务员的培训参与者
- **范围**: 仅限本部门业务员的客户
- **操作**: 查看、删除参与者记录

### 📝 修改文件

1. **权限配置文件**
   - `src/constants/permissions.ts` (第188行)
   - 在部门经理默认权限中添加 `training_manage_participant`

2. **培训管理页面**
   - `src/pages/TrainingPerformance.tsx` (第2535-2541行)
   - 更新删除参与者的权限判断逻辑
   - 允许部门经理删除本部门业务员的客户参与记录

3. **数据库迁移脚本**
   - `scripts/migrations/grant-manager-participant-permission.sql`
   - 为现有部门经理用户授予新权限

## 权限使用场景

### 场景1: 客户管理
部门经理可以：
- 查看本部门所有业务员的客户
- 添加、编辑、删除客户
- 导出客户数据用于分析

### 场景2: 培训管理
部门经理可以：
- 查看所有培训场次
- 查看本部门业务员的培训参与者
- **删除本部门业务员的客户参与记录**（新增）
- 查看培训统计和业绩

### 场景3: 业务员管理
部门经理可以：
- 查看本部门业务员信息
- 添加、编辑业务员
- 查看业务员绩效数据

### 场景4: 数据分析
部门经理可以：
- 导出业绩数据
- 查看数据操作历史
- 分析部门业绩趋势

## 权限边界

### 部门经理可以做的

✅ 管理本部门的所有客户  
✅ 查看本部门的所有培训数据  
✅ 删除本部门业务员的培训参与者  
✅ 管理本部门的业务员  
✅ 查看和下载招商简章  
✅ 导出本部门的业绩数据  

### 部门经理不能做的

❌ 查看其他部门的客户（除非有特殊权限）  
❌ 删除其他部门业务员的培训参与者  
❌ 添加或编辑培训场次（需要管理员权限）  
❌ 删除培训场次  
❌ 上传或删除招商简章  
❌ 查看所有部门的业绩（需要 `performance_view_all_departments` 权限）  
❌ 管理系统权限  
❌ 查看审计日志  

## 数据隔离机制

### 部门级别隔离

部门经理的权限受到部门字段的限制：

```typescript
// 示例：删除培训参与者的权限判断
const canDelete = user?.role === 'admin' || 
  participant.salespersonName === user?.name ||
  (user?.role === 'manager' && participant.salespersonDepartment === user?.department);
```

### 数据库RLS策略

数据库层面也有相应的RLS策略保护：

- 客户数据：通过 `salesperson_id` 和部门关联
- 培训参与者：通过 `customer_id` 关联到业务员
- 业务员数据：通过 `department` 字段隔离

## 应用部署步骤

### 1. 执行数据库迁移

```sql
-- 为现有部门经理添加新权限
psql -d your_database -f scripts/migrations/grant-manager-participant-permission.sql
```

### 2. 验证权限配置

```sql
-- 检查部门经理的权限
SELECT 
    up.name,
    up.role,
    up.department,
    COUNT(uperm.permission_id) as total_permissions,
    BOOL_OR(uperm.permission_id = 'training_manage_participant') as has_manage_participant
FROM user_profiles up
LEFT JOIN user_permissions uperm ON up.id = uperm.user_id
WHERE up.role = 'manager'
GROUP BY up.id, up.name, up.role, up.department;
```

### 3. 测试功能

1. 使用部门经理账号登录
2. 进入培训管理页面
3. 查看培训详情
4. 尝试删除本部门业务员的参与者（应该成功）
5. 尝试删除其他部门业务员的参与者（应该显示"无权限"）

### 4. 使用权限测试页面

1. 访问 `/permission-test`
2. 选择部门经理用户
3. 查看 `training_manage_participant` 权限
4. 应该显示为"已授权"✅

## 常见问题

### Q1: 部门经理看不到删除按钮？

**可能原因**:
1. 用户的 `department` 字段未设置
2. 业务员的 `department` 字段未设置
3. 两者的部门不匹配

**解决方法**:
```sql
-- 检查部门信息
SELECT id, name, role, department FROM user_profiles WHERE role IN ('manager', 'salesperson');
```

### Q2: 删除操作失败？

**可能原因**:
1. 数据库RLS策略限制
2. 参与者记录的 `customer_id` 字段为空
3. 客户的 `salesperson_id` 字段为空

**解决方法**:
检查数据完整性，确保关联字段都已正确填写。

### Q3: 如何给部门经理更多权限？

**方法**:
1. 进入权限管理页面
2. 选择部门经理用户
3. 手动添加所需权限
4. 例如：`performance_view_all_departments` 可以查看所有部门业绩

## 相关文档

- [部门经理培训参与者管理权限说明](./部门经理培训参与者管理权限说明.md)
- [权限测试验证功能说明](./权限测试验证功能说明.md)
- [权限系统架构说明](./权限系统架构说明.md)

## 更新日志

### 2025-11-12
- ✅ 新增 `training_manage_participant` 权限
- ✅ 更新培训管理页面的删除权限逻辑
- ✅ 创建数据库迁移脚本
- ✅ 完善权限测试功能
