# 客户管理新增字段功能说明

**更新日期**: 2025-11-13  
**更新内容**: 客户管理增加3个新字段：部门、性别（必填）、住宿需求

## 📋 变更概述

在客户管理系统中新增3个客户信息字段，以便更全面地记录客户信息，方便后续培训安排和统计分析。

## 🗄️ 数据库变更

### 新增字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `department` | VARCHAR(100) | 否 | 客户所属部门 |
| `gender` | VARCHAR(10) | **是** | 客户性别（男/女） |
| `accommodation_requirements` | TEXT | 否 | 客户住宿需求备注 |

### 迁移脚本

```sql
-- 添加部门字段
ALTER TABLE customers 
ADD COLUMN IF NOT EXISTS department VARCHAR(100);

-- 添加性别字段（必填）
ALTER TABLE customers 
ADD COLUMN IF NOT EXISTS gender VARCHAR(10) NOT NULL DEFAULT '';

-- 添加住宿需求字段
ALTER TABLE customers 
ADD COLUMN IF NOT EXISTS accommodation_requirements TEXT;
```

**迁移文件位置**: `scripts/migrations/add-customer-fields.sql`

## 💻 代码变更

### 1. TypeScript类型定义 (`src/lib/supabase/types.ts`)

```typescript
export interface Customer {
  // ...existing fields...
  department: string | null;              // 部门
  gender: string;                         // 性别（必填）
  accommodation_requirements: string | null; // 住宿需求
}
```

### 2. 添加客户表单 (`src/pages/CustomerManagement.tsx`)

**新增输入字段**：
- ✅ 部门输入框（文本）
- ✅ 性别选择框（下拉，男/女，必填）
- ✅ 住宿需求输入框（多行文本）

**字段位置**: 在职位字段之后，负责业务员之前

### 3. 客户详情显示 (`src/pages/CustomerManagement.tsx`)

在客户详情模态框中显示新字段：
- 📌 部门：使用 Users 图标
- 👤 性别：使用 UserCircle 图标
- 🏠 住宿需求：单独显示在灰色背景块中

### 4. 导入模板 (`src/components/CustomerImportModal.tsx`)

**模板字段顺序**：
```
客户姓名 | 手机号 | 邮箱 | 公司名称 | 职位 | 地区 | 
部门 | 性别 | 住宿需求 | 负责业务员 | 客户状态
```

**示例数据**：
```javascript
{
  '客户姓名': '张三',
  '手机号': '13021622000',
  '邮箱': 'zhangsan@example.com',
  '公司名称': '大风歌',
  '职位': '经理',
  '地区': '江苏',
  '部门': '人力资源部',        // 新增
  '性别': '男',                // 新增（必填）
  '住宿需求': '无特殊要求',     // 新增
  '负责业务员': '张三',
  '客户状态': '潜在客户'
}
```

**导入验证**：
- ✅ 性别字段必填验证
- ✅ 字段映射对应

### 5. 导出功能 (`src/pages/CustomerManagement.tsx`)

导出Excel时包含所有字段：
```typescript
const exportData = filteredCustomers.map(customer => ({
  客户姓名: customer.name,
  手机号: customer.phone || '',
  邮箱: customer.email || '',
  公司名称: customer.company || '',
  职位: customer.position || '',
  地区: customer.location || '',
  部门: customer.department || '',              // 新增
  性别: customer.gender || '',                  // 新增
  住宿需求: customer.accommodation_requirements || '',  // 新增
  负责业务员: customer.salesperson_name || '',
  客户状态: customer.status || '潜在客户'
}));
```

## 🔄 数据迁移步骤

### 方式1：通过Supabase MCP工具

```javascript
// 1. 连接到Supabase项目
mcp0_get_project({ id: "your-project-id" })

// 2. 应用迁移
mcp0_apply_migration({
  project_id: "your-project-id",
  name: "add_customer_fields",
  query: "-- SQL内容见 scripts/migrations/add-customer-fields.sql --"
})

// 3. 验证迁移
mcp0_execute_sql({
  project_id: "your-project-id",
  query: `
    SELECT column_name, data_type, is_nullable 
    FROM information_schema.columns
    WHERE table_name = 'customers'
    AND column_name IN ('department', 'gender', 'accommodation_requirements');
  `
})
```

### 方式2：通过Supabase Dashboard

1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择项目
3. 进入 SQL Editor
4. 复制 `scripts/migrations/add-customer-fields.sql` 内容
5. 运行 SQL

## ✅ 功能特点

### 1. **性别字段必填验证**
- 表单提交时验证
- 导入Excel时验证
- 数据库层级约束

### 2. **导入导出一致性**
- ✅ 导入模板包含所有字段
- ✅ 导出数据包含所有字段
- ✅ 字段顺序和命名保持一致

### 3. **向后兼容**
- 现有数据自动兼容（性别默认为空字符串）
- 可选字段不影响现有流程
- 客户详情优雅降级显示

## 📊 使用场景

### 1. **部门统计**
- 按部门分析客户分布
- 部门维度的客户报表
- 跨部门客户协作

### 2. **性别统计**
- 性别比例分析
- 针对性培训安排
- 客户画像完善

### 3. **住宿安排**
- 培训住宿需求收集
- 提前准备住宿安排
- 特殊需求记录

## 🧪 测试建议

### 1. 添加客户测试
- ✅ 不填性别：应显示必填提示
- ✅ 填写所有字段：成功保存
- ✅ 只填必填字段：成功保存

### 2. 导入测试
- ✅ 使用新模板导入：验证字段正确映射
- ✅ 缺少性别字段：显示验证错误
- ✅ 部分字段为空：正常导入

### 3. 导出测试
- ✅ 导出现有客户：包含所有字段
- ✅ 字段顺序：与模板一致
- ✅ 空字段处理：显示为空字符串

### 4. 详情显示测试
- ✅ 有值字段：正常显示
- ✅ 空值字段：显示"未填写"
- ✅ 住宿需求：仅在有值时显示

## 📝 注意事项

1. **性别字段为必填**
   - 添加客户时必须选择
   - 导入数据时必须提供
   - 数据库约束已设置

2. **现有数据处理**
   - 迁移后现有客户性别为空字符串
   - 建议批量更新现有客户数据
   - 或在编辑时逐步完善

3. **导入模板更新**
   - 用户需下载新版模板
   - 旧模板仍可使用（新字段为空）
   - 建议通知用户更新模板

## 🔗 相关文件

- 数据库迁移：`scripts/migrations/add-customer-fields.sql`
- 类型定义：`src/lib/supabase/types.ts`
- 客户管理页面：`src/pages/CustomerManagement.tsx`
- 导入组件：`src/components/CustomerImportModal.tsx`

## 📞 支持

如有问题，请联系技术团队或查看相关代码文件的注释说明。
