# æƒé™ç³»ç»Ÿä¸‰å±‚æ¶æ„è¯¦è§£

> æœ€åæ›´æ–°ï¼š2025-11-07
> 
> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ç³»ç»Ÿçš„ä¸‰å±‚æƒé™æ¶æ„ï¼šå‰ç«¯è·¯ç”±æƒé™ã€APIæƒé™ã€æ•°æ®åº“RLSæƒé™

## ğŸ—ï¸ æƒé™æ¶æ„æ€»è§ˆ

```
ç”¨æˆ·è¯·æ±‚
    â†“
[ç¬¬ä¸€å±‚] å‰ç«¯è·¯ç”±æƒé™ (React Router)
    â†“ é€šè¿‡
[ç¬¬äºŒå±‚] APIæƒé™æ£€æŸ¥ (Supabase Functions/API)
    â†“ é€šè¿‡
[ç¬¬ä¸‰å±‚] RLSè¡Œçº§å®‰å…¨ (PostgreSQL Policies)
    â†“ é€šè¿‡
è¿”å›æ•°æ®
```

## ğŸ¯ ç¬¬ä¸€å±‚ï¼šå‰ç«¯è·¯ç”±æƒé™

### ä½ç½®
- æ–‡ä»¶ï¼š`src/contexts/AuthContext.tsx`
- è·¯ç”±ï¼š`src/App.tsx` 
- å¸¸é‡ï¼š`src/constants/permissions.ts`

### æ§åˆ¶å†…å®¹
1. **é¡µé¢è®¿é—®**ï¼šç”¨æˆ·èƒ½å¦è®¿é—®æŸä¸ªé¡µé¢
2. **èœå•æ˜¾ç¤º**ï¼šå¯¼èˆªæ æ˜¾ç¤ºå“ªäº›èœå•é¡¹
3. **åŠŸèƒ½æŒ‰é’®**ï¼šé¡µé¢ä¸Šçš„æ“ä½œæŒ‰é’®æ˜¯å¦æ˜¾ç¤º

### æƒé™å®šä¹‰

#### åŠŸèƒ½æƒé™ (permissions)
```typescript
// src/constants/permissions.ts
export const PERMISSIONS = {
  // å®¢æˆ·ç®¡ç†æƒé™
  CUSTOMER_VIEW: 'customer_view',          // æŸ¥çœ‹å®¢æˆ·åˆ—è¡¨
  CUSTOMER_ADD: 'customer_add',            // æ–°å¢å®¢æˆ·
  CUSTOMER_EDIT: 'customer_edit',          // ç¼–è¾‘å®¢æˆ·
  CUSTOMER_DELETE: 'customer_delete',      // åˆ é™¤å®¢æˆ·
  CUSTOMER_EXPORT: 'customer_export',      // å¯¼å‡ºå®¢æˆ·
  CUSTOMER_IMPORT: 'customer_import',      // å¯¼å…¥å®¢æˆ·
  
  // åŸ¹è®­ç®¡ç†æƒé™
  TRAINING_VIEW: 'training_view',          // æŸ¥çœ‹åŸ¹è®­
  TRAINING_ADD: 'training_add',            // æ–°å¢åŸ¹è®­
  TRAINING_EDIT: 'training_edit',          // ç¼–è¾‘åŸ¹è®­
  TRAINING_DELETE: 'training_delete',      // åˆ é™¤åŸ¹è®­
  TRAINING_ADD_PARTICIPANT: 'training_add_participant', // æ·»åŠ å‚è®­äººå‘˜
  
  // ä¸“å®¶ç®¡ç†æƒé™
  EXPERT_VIEW: 'expert_view',              // æŸ¥çœ‹ä¸“å®¶
  EXPERT_ADD: 'expert_add',                // æ–°å¢ä¸“å®¶
  EXPERT_EDIT: 'expert_edit',              // ç¼–è¾‘ä¸“å®¶
  EXPERT_DELETE: 'expert_delete',          // åˆ é™¤ä¸“å®¶
  
  // ä¸šåŠ¡å‘˜ç®¡ç†æƒé™
  SALESPERSON_VIEW: 'salesperson_view',    // æŸ¥çœ‹ä¸šåŠ¡å‘˜
  SALESPERSON_ADD: 'salesperson_add',      // æ–°å¢ä¸šåŠ¡å‘˜
  SALESPERSON_EDIT: 'salesperson_edit',    // ç¼–è¾‘ä¸šåŠ¡å‘˜
  SALESPERSON_DELETE: 'salesperson_delete',// åˆ é™¤ä¸šåŠ¡å‘˜
  
  // æ‹›å•†ç®€ç« æƒé™
  PROSPECTUS_VIEW: 'prospectus_view',      // æŸ¥çœ‹ç®€ç« 
  PROSPECTUS_DOWNLOAD: 'prospectus_download', // ä¸‹è½½ç®€ç« 
  PROSPECTUS_ADD: 'prospectus_add',        // æ–°å¢ç®€ç« 
  PROSPECTUS_EDIT: 'prospectus_edit',      // ç¼–è¾‘ç®€ç« 
  PROSPECTUS_DELETE: 'prospectus_delete',  // åˆ é™¤ç®€ç« 
  
  // æ•°æ®ç®¡ç†æƒé™
  DATA_EXPORT: 'data_export',              // å¯¼å‡ºæ•°æ®
  DATA_IMPORT: 'data_import',              // å¯¼å…¥æ•°æ®
  DATA_DOWNLOAD_TEMPLATE: 'data_download_template', // ä¸‹è½½æ¨¡æ¿
  
  // ç³»ç»Ÿè®¾ç½®æƒé™
  SETTINGS_VIEW: 'settings_view',          // æŸ¥çœ‹è®¾ç½®
  SETTINGS_EDIT: 'settings_edit',          // ä¿®æ”¹è®¾ç½®
  USER_MANAGE: 'user_manage',              // ç”¨æˆ·ç®¡ç†
  ROLE_MANAGE: 'role_manage',              // è§’è‰²ç®¡ç†
  PERMISSION_MANAGE: 'permission_manage',  // æƒé™ç®¡ç†
};
```

#### èœå•åŠŸèƒ½æƒé™ (menu_features)
```typescript
export const MENU_FEATURES = {
  dashboard: 'dashboard',                   // ä»ªè¡¨ç›˜
  customer_management: 'customer_management', // å®¢æˆ·ç®¡ç†
  training_management: 'training_management', // åŸ¹è®­ç®¡ç†
  expert_management: 'expert_management',   // ä¸“å®¶ç®¡ç†
  salesperson_management: 'salesperson_management', // ä¸šåŠ¡å‘˜ç®¡ç†
  prospectus_management: 'prospectus_management', // æ‹›å•†ç®€ç« 
  data_management: 'data_management',       // æ•°æ®ç®¡ç†
  sales_tracking: 'sales_tracking',         // é”€å”®è¿½è¸ª
  training_performance: 'training_performance', // åŸ¹è®­ä¸šç»©
  announcements: 'announcements',           // å…¬å‘Šé€šçŸ¥
  profile_settings: 'profile_settings',     // ä¸ªäººè®¾ç½®
  system_settings: 'system_settings',       // ç³»ç»Ÿè®¾ç½®
};
```

### è§’è‰²é»˜è®¤æƒé™

#### Adminï¼ˆç®¡ç†å‘˜ï¼‰
```javascript
// æ‹¥æœ‰æ‰€æœ‰æƒé™
permissions: Object.values(PERMISSIONS),
menu_features: Object.values(MENU_FEATURES)
```

#### Managerï¼ˆä¸šåŠ¡ç»ç†ï¼‰
```javascript
permissions: [
  // æŸ¥çœ‹æƒé™
  PERMISSIONS.CUSTOMER_VIEW,
  PERMISSIONS.TRAINING_VIEW,
  PERMISSIONS.EXPERT_VIEW,
  PERMISSIONS.SALESPERSON_VIEW,
  PERMISSIONS.PROSPECTUS_VIEW,
  // ç®¡ç†æƒé™
  PERMISSIONS.CUSTOMER_ADD,
  PERMISSIONS.CUSTOMER_EDIT,
  PERMISSIONS.TRAINING_ADD,
  PERMISSIONS.TRAINING_EDIT,
  PERMISSIONS.TRAINING_ADD_PARTICIPANT,
  // æ•°æ®æƒé™
  PERMISSIONS.DATA_EXPORT,
  PERMISSIONS.PROSPECTUS_DOWNLOAD,
],
menu_features: [
  MENU_FEATURES.dashboard,
  MENU_FEATURES.customer_management,
  MENU_FEATURES.training_management,
  MENU_FEATURES.salesperson_management,
  MENU_FEATURES.sales_tracking,
  MENU_FEATURES.training_performance,
  MENU_FEATURES.profile_settings,
]
```

#### Salespersonï¼ˆä¸šåŠ¡å‘˜ï¼‰
```javascript
permissions: [
  PERMISSIONS.CUSTOMER_VIEW,
  PERMISSIONS.CUSTOMER_ADD,
  PERMISSIONS.CUSTOMER_EDIT,
  PERMISSIONS.CUSTOMER_EXPORT,
  PERMISSIONS.CUSTOMER_IMPORT,
  PERMISSIONS.TRAINING_VIEW,
  PERMISSIONS.TRAINING_ADD_PARTICIPANT,
  PERMISSIONS.EXPERT_VIEW,
  PERMISSIONS.PROSPECTUS_VIEW,
  PERMISSIONS.PROSPECTUS_DOWNLOAD,
  PERMISSIONS.DATA_DOWNLOAD_TEMPLATE,
],
menu_features: [
  MENU_FEATURES.dashboard,
  MENU_FEATURES.customer_management,
  MENU_FEATURES.training_management,
  MENU_FEATURES.data_management,
  MENU_FEATURES.profile_settings,
]
```

#### Expertï¼ˆä¸“å®¶ï¼‰
```javascript
permissions: [
  PERMISSIONS.TRAINING_VIEW,
  PERMISSIONS.EXPERT_VIEW,
  PERMISSIONS.PROSPECTUS_VIEW,
  PERMISSIONS.PROSPECTUS_DOWNLOAD,
],
menu_features: [
  MENU_FEATURES.dashboard,
  MENU_FEATURES.training_management,
  MENU_FEATURES.profile_settings,
]
```

### æƒé™æ£€æŸ¥æ–¹æ³•

```typescript
// æ£€æŸ¥å•ä¸ªæƒé™
const hasPermission = (permission: string): boolean => {
  return user?.permissions?.includes(permission) || false;
};

// æ£€æŸ¥å¤šä¸ªæƒé™ï¼ˆä»»ä¸€æ»¡è¶³ï¼‰
const hasAnyPermission = (permissions: string[]): boolean => {
  return permissions.some(p => hasPermission(p));
};

// æ£€æŸ¥èœå•è®¿é—®æƒé™
const hasMenuAccess = (menuFeature: string): boolean => {
  return user?.menuAccess?.includes(menuFeature) || false;
};
```

## ğŸ”’ ç¬¬äºŒå±‚ï¼šAPIæƒé™

### ä½ç½®
- Supabase Functions
- APIè·¯ç”±å¤„ç†
- æœåŠ¡å±‚å‡½æ•°

### æ§åˆ¶å†…å®¹
1. **APIè®¿é—®**ï¼šç”¨æˆ·èƒ½å¦è°ƒç”¨æŸä¸ªAPI
2. **æ•°æ®èŒƒå›´**ï¼šè¿”å›å“ªäº›æ•°æ®
3. **æ“ä½œé™åˆ¶**ï¼šå…è®¸çš„æ“ä½œç±»å‹

### å®ç°æ–¹å¼

```typescript
// src/lib/supabase/supabaseService.ts
async function checkApiPermission(userId: string, requiredPermission: string) {
  const { data } = await supabase
    .from('user_permissions')
    .select('permission_id')
    .eq('user_id', userId)
    .eq('permission_id', requiredPermission)
    .single();
  
  return !!data;
}

// ä½¿ç”¨ç¤ºä¾‹
async createCustomer(customerData: any) {
  const user = await getCurrentUser();
  
  // APIå±‚æƒé™æ£€æŸ¥
  if (!await checkApiPermission(user.id, 'customer_add')) {
    throw new Error('æ²¡æœ‰åˆ›å»ºå®¢æˆ·çš„æƒé™');
  }
  
  // ç»§ç»­æ‰§è¡Œåˆ›å»ºé€»è¾‘...
}
```

## ğŸ›¡ï¸ ç¬¬ä¸‰å±‚ï¼šRLSï¼ˆRow Level Securityï¼‰

### ä½ç½®
- PostgreSQLæ•°æ®åº“
- Supabase RLS Policies

### æ§åˆ¶å†…å®¹
1. **æ•°æ®è¡Œè®¿é—®**ï¼šç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›æ•°æ®è¡Œ
2. **æ•°æ®ä¿®æ”¹**ï¼šç”¨æˆ·èƒ½ä¿®æ”¹å“ªäº›æ•°æ®
3. **æ•°æ®åˆ é™¤**ï¼šç”¨æˆ·èƒ½åˆ é™¤å“ªäº›æ•°æ®

### RLSç­–ç•¥ç¤ºä¾‹

#### 1. å®¢æˆ·æ•°æ®è®¿é—®ç­–ç•¥
```sql
-- ä¸šåŠ¡å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±çš„å®¢æˆ·
CREATE POLICY "salesperson_own_customers" ON customers
FOR SELECT
USING (
  auth.uid() = salesperson_id 
  OR 
  EXISTS (
    SELECT 1 FROM user_profiles 
    WHERE id = auth.uid() 
    AND role IN ('admin', 'manager')
  )
);

-- ä¸šåŠ¡å‘˜åªèƒ½ä¿®æ”¹è‡ªå·±çš„å®¢æˆ·
CREATE POLICY "salesperson_update_own_customers" ON customers
FOR UPDATE
USING (auth.uid() = salesperson_id)
WITH CHECK (auth.uid() = salesperson_id);
```

#### 2. åŸ¹è®­å‚ä¸è€…æ•°æ®ç­–ç•¥
```sql
-- ä¸šåŠ¡å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±æˆäº¤çš„å‚è®­äººå‘˜
CREATE POLICY "salesperson_own_participants" ON training_participants
FOR SELECT
USING (
  salesperson_name = (
    SELECT name FROM user_profiles WHERE id = auth.uid()
  )
  OR
  EXISTS (
    SELECT 1 FROM user_profiles 
    WHERE id = auth.uid() 
    AND role IN ('admin', 'manager')
  )
);
```

#### 3. éƒ¨é—¨æ•°æ®éš”ç¦»
```sql
-- ç»ç†åªèƒ½çœ‹åˆ°æœ¬éƒ¨é—¨æ•°æ®
CREATE POLICY "manager_department_data" ON training_participants
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM user_profiles up1
    JOIN user_profiles up2 ON up2.name = training_participants.salesperson_name
    WHERE up1.id = auth.uid()
    AND up1.role = 'manager'
    AND up1.department_id = up2.department_id
  )
);
```

### RLSç­–ç•¥ç±»å‹

| ç­–ç•¥ç±»å‹ | SQLå‘½ä»¤ | è¯´æ˜ |
|---------|---------|------|
| SELECT | FOR SELECT | æ§åˆ¶æ•°æ®è¯»å– |
| INSERT | FOR INSERT | æ§åˆ¶æ•°æ®æ’å…¥ |
| UPDATE | FOR UPDATE | æ§åˆ¶æ•°æ®æ›´æ–° |
| DELETE | FOR DELETE | æ§åˆ¶æ•°æ®åˆ é™¤ |
| ALL | FOR ALL | æ§åˆ¶æ‰€æœ‰æ“ä½œ |

## ğŸ”„ æƒé™æµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šä¸šåŠ¡å‘˜æŸ¥çœ‹å®¢æˆ·åˆ—è¡¨

```mermaid
graph TD
    A[ä¸šåŠ¡å‘˜è®¿é—®/customers] --> B{å‰ç«¯è·¯ç”±æƒé™}
    B -->|æœ‰customer_viewæƒé™| C[æ˜¾ç¤ºé¡µé¢]
    B -->|æ— æƒé™| D[è·³è½¬åˆ°403]
    C --> E[è°ƒç”¨APIè·å–æ•°æ®]
    E --> F{APIæƒé™æ£€æŸ¥}
    F -->|é€šè¿‡| G[æŸ¥è¯¢æ•°æ®åº“]
    F -->|æ‹’ç»| H[è¿”å›401]
    G --> I{RLSç­–ç•¥}
    I -->|åªè¿”å›è¯¥ä¸šåŠ¡å‘˜çš„å®¢æˆ·| J[è¿”å›æ•°æ®]
    I -->|æ— æ•°æ®æƒé™| K[è¿”å›ç©ºæ•°ç»„]
```

### åœºæ™¯2ï¼šç®¡ç†å‘˜ä¿®æ”¹ç³»ç»Ÿè®¾ç½®

```mermaid
graph TD
    A[ç®¡ç†å‘˜è®¿é—®/settings] --> B{å‰ç«¯è·¯ç”±æƒé™}
    B -->|æœ‰settings_editæƒé™| C[æ˜¾ç¤ºè®¾ç½®é¡µé¢]
    C --> D[ä¿®æ”¹è®¾ç½®å¹¶æäº¤]
    D --> E{APIæƒé™æ£€æŸ¥}
    E -->|role=admin| F[æ›´æ–°æ•°æ®åº“]
    E -->|éadmin| G[è¿”å›403]
    F --> H{RLSç­–ç•¥}
    H -->|adminå¯ä¿®æ”¹æ‰€æœ‰| I[æ›´æ–°æˆåŠŸ]
```

## ğŸ“ æƒé™é…ç½®æœ€ä½³å®è·µ

### 1. æœ€å°æƒé™åŸåˆ™
- åªæˆäºˆå¿…è¦çš„æƒé™
- å®šæœŸå®¡æŸ¥æƒé™åˆ†é…
- åŠæ—¶å›æ”¶ä¸éœ€è¦çš„æƒé™

### 2. æƒé™ç»§æ‰¿
```
Admin > Manager > Salesperson > Expert
```

### 3. æƒé™ç»„åˆ
- æŸ¥çœ‹æƒé™æ˜¯å…¶ä»–æƒé™çš„å‰æ
- ç¼–è¾‘æƒé™åŒ…å«æŸ¥çœ‹æƒé™
- åˆ é™¤æƒé™éœ€è¦æœ€é«˜çº§åˆ«å®¡æ‰¹

### 4. æƒé™å®¡è®¡
```sql
-- æŸ¥çœ‹ç”¨æˆ·æƒé™å†å²
SELECT 
  up.name,
  up.role,
  p.permission_id,
  p.granted_at
FROM user_permissions p
JOIN user_profiles up ON p.user_id = up.id
WHERE up.id = 'ç”¨æˆ·ID'
ORDER BY p.granted_at DESC;
```

## ğŸš¨ å¸¸è§æƒé™é—®é¢˜

### é—®é¢˜1ï¼šæƒé™ä¸ç”Ÿæ•ˆ
**åŸå› **ï¼š
- å‰ç«¯ç¼“å­˜æœªæ›´æ–°
- æ•°æ®åº“æƒé™æœªåŒæ­¥
- RLSç­–ç•¥é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```javascript
// å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·æƒé™
await supabaseService.refreshUserPermissions();
```

### é—®é¢˜2ï¼šè¶Šæƒè®¿é—®
**åŸå› **ï¼š
- åªä¾èµ–å‰ç«¯æƒé™
- APIå±‚æœªæ ¡éªŒ
- RLSç­–ç•¥ç¼ºå¤±

**è§£å†³**ï¼š
- å®æ–½ä¸‰å±‚æƒé™æ£€æŸ¥
- æ·»åŠ å®¡è®¡æ—¥å¿—

### é—®é¢˜3ï¼šæƒé™å†²çª
**åŸå› **ï¼š
- è§’è‰²æƒé™é‡å 
- è‡ªå®šä¹‰æƒé™ä¸é»˜è®¤æƒé™å†²çª

**è§£å†³**ï¼š
```sql
-- æ£€æŸ¥æƒé™å†²çª
SELECT 
  user_id,
  array_agg(DISTINCT permission_id) as permissions
FROM user_permissions
GROUP BY user_id
HAVING count(DISTINCT permission_id) != count(permission_id);
```

## ğŸ”§ æƒé™è°ƒè¯•å·¥å…·

### 1. æƒé™æ£€æŸ¥å‡½æ•°
```typescript
// src/utils/permissionDebug.ts
export function debugPermissions(user: User) {
  console.group('ğŸ” ç”¨æˆ·æƒé™è°ƒè¯•');
  console.log('ç”¨æˆ·ID:', user.id);
  console.log('è§’è‰²:', user.role);
  console.log('åŠŸèƒ½æƒé™:', user.permissions);
  console.log('èœå•æƒé™:', user.menuAccess);
  console.log('éƒ¨é—¨:', user.department);
  console.groupEnd();
}
```

### 2. RLSç­–ç•¥æµ‹è¯•
```sql
-- æµ‹è¯•RLSç­–ç•¥
SET LOCAL "request.jwt.claims" = '{"sub": "ç”¨æˆ·UUID"}';
SELECT * FROM customers; -- åº”è¯¥åªè¿”å›è¯¥ç”¨æˆ·çš„æ•°æ®
```

### 3. æƒé™çŸ©é˜µæŠ¥è¡¨
```sql
-- ç”Ÿæˆæƒé™çŸ©é˜µ
SELECT 
  r.role_name,
  p.permission_name,
  CASE WHEN rp.role_id IS NOT NULL THEN 'âœ“' ELSE 'âœ—' END as has_permission
FROM 
  (VALUES ('admin'), ('manager'), ('salesperson'), ('expert')) r(role_name)
CROSS JOIN 
  (SELECT DISTINCT permission_id as permission_name FROM user_permissions) p
LEFT JOIN role_permissions rp 
  ON r.role_name = rp.role_id 
  AND p.permission_name = rp.permission_id
ORDER BY r.role_name, p.permission_name;
```

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [æ•°æ®åº“è¡¨ç»“æ„ä¸å­—æ®µè¯´æ˜](./æ•°æ®åº“è¡¨ç»“æ„ä¸å­—æ®µè¯´æ˜.md)
- [é»˜è®¤æƒé™é…ç½®](./ä¸šåŠ¡å‘˜é»˜è®¤æƒé™é…ç½®.md)
- [æƒé™å‡çº§æ–¹æ¡ˆ](./ä¸šåŠ¡ç»ç†è§’è‰²å‡çº§æ–¹æ¡ˆ.md)

## ğŸ”„ æ›´æ–°è®°å½•
- 2025-11-07ï¼šåˆå§‹ç‰ˆæœ¬ï¼Œè¯¦ç»†è¯´æ˜ä¸‰å±‚æƒé™æ¶æ„
