# 数据库表结构与字段完整说明

> 最后更新：2025-11-07
> 
> ⚠️ **重要提示**：本文档记录了所有数据库表的字段含义和使用场景，避免字段误用导致的数据统计错误。

## 📊 核心业务表

### 1. training_participants（培训参与者表）
> 记录每个参训人员的详细信息，是业绩统计的核心数据源

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | INTEGER | 主键，自增 | 🔴 高 | 唯一标识 |
| **training_session_id** | INTEGER | 培训场次ID | 🔴 高 | 关联到具体培训 |
| **customer_id** | UUID | 客户ID（可选） | 🟡 中 | 关联到客户表 |
| **name** | VARCHAR | 参训者姓名 | 🔴 高 | 显示用 |
| **phone** | VARCHAR | 联系电话 | 🔴 高 | 联系方式 |
| **email** | VARCHAR | 邮箱 | 🟢 低 | 备用联系 |
| **registration_date** | DATE | ⭐ **客户报名日期（成交时间）** | 🔴 高 | **业绩统计的时间维度** |
| **payment_status** | VARCHAR | 支付状态 | 🔴 高 | paid/pending/cancelled |
| **salesperson_name** | VARCHAR | ⭐ **实际成交业务员姓名** | 🔴 高 | **业绩归属的关键字段** |
| **payment_amount** | DECIMAL | 实际支付金额 | 🔴 高 | 业绩统计主要字段 |
| **actual_price** | DECIMAL | 实际价格 | 🔴 高 | 备用价格字段 |
| **participation_mode** | VARCHAR | 参训模式 | 🟡 中 | online/offline |
| **discount_rate** | DECIMAL | 折扣率 | 🟢 低 | 优惠统计 |
| **created_at** | TIMESTAMP | 记录创建时间 | 🟡 中 | 审计日志，不用于业绩统计 |

⚠️ **关键提醒**：
- `salesperson_name` 是实际成交的业务员，用于业绩统计
- `payment_amount` 是业绩金额，直接使用，不要用 `actual_price` 作为备选
- `registration_date` 用于月度/季度/年度的时间筛选（业绩算在成交时间）

### 2. training_sessions（培训场次表）
> 记录培训课程的基本信息

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | INTEGER | 主键 | 🔴 高 | 唯一标识 |
| **name** | VARCHAR | 培训名称 | 🔴 高 | 显示用 |
| **date** | DATE | 培训日期 | 🟡 中 | 日程安排 |
| **location** | VARCHAR | 培训地点 | 🟡 中 | 位置信息 |
| **instructor** | VARCHAR | 讲师 | 🟡 中 | 师资信息 |
| **salesperson_id** | UUID | ⚠️ **培训负责人ID** | 🟡 中 | **注意：不是成交业务员** |
| **training_mode** | VARCHAR | 培训模式 | 🟡 中 | online/offline/mixed |
| **online_price** | DECIMAL | 线上价格 | 🟡 中 | 定价策略 |
| **offline_price** | DECIMAL | 线下价格 | 🟡 中 | 定价策略 |
| **participants** | INTEGER | 参与人数 | 🟡 中 | 统计用 |
| **status** | VARCHAR | 状态 | 🟡 中 | pending/ongoing/completed |

⚠️ **重要区分**：
- `salesperson_id` 是培训的负责人/组织者，不是实际成交业务员
- 业绩统计应使用 `training_participants.salesperson_name`

### 3. user_profiles（用户档案表）
> 系统用户信息，包括业务员、管理员、专家等

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | UUID | 用户ID | 🔴 高 | Auth关联 |
| **name** | VARCHAR | 姓名 | 🔴 高 | 显示用 |
| **email** | VARCHAR | 邮箱 | 🔴 高 | 登录账号 |
| **phone** | VARCHAR | 电话 | 🟡 中 | 联系方式 |
| **role** | VARCHAR | 角色 | 🔴 高 | admin/salesperson/expert/manager |
| **department_id** | INTEGER | 部门ID | 🟡 中 | 组织架构 |
| **position** | VARCHAR | 职位 | 🟢 低 | 显示用 |
| **avatar** | VARCHAR | 头像URL | 🟢 低 | 界面显示 |
| **created_at** | TIMESTAMP | 创建时间 | 🟡 中 | 注册时间 |

### 4. customers（客户表）
> 客户基本信息

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | UUID | 客户ID | 🔴 高 | 唯一标识 |
| **name** | VARCHAR | 客户姓名 | 🔴 高 | 显示用 |
| **company** | VARCHAR | 公司名称 | 🟡 中 | 企业客户 |
| **phone** | VARCHAR | 联系电话 | 🔴 高 | 主要联系方式 |
| **email** | VARCHAR | 邮箱 | 🟡 中 | 备用联系 |
| **salesperson_id** | UUID | 负责业务员ID | 🔴 高 | 客户归属 |
| **status** | VARCHAR | 客户状态 | 🟡 中 | 跟进状态 |
| **created_at** | TIMESTAMP | 创建时间 | 🟡 中 | 时间统计 |

### 5. departments（部门表）
> 组织架构

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | INTEGER | 部门ID | 🔴 高 | 主键 |
| **name** | VARCHAR | 部门名称 | 🔴 高 | 显示用 |
| **code** | VARCHAR | 部门代码 | 🟡 中 | 内部编码 |
| **manager_id** | UUID | 部门经理ID | 🟡 中 | 管理关系 |
| **parent_id** | INTEGER | 上级部门ID | 🟢 低 | 层级关系 |

## 🔐 权限相关表

### 6. user_permissions（用户权限表）
> 用户与权限的关联

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **user_id** | UUID | 用户ID | 🔴 高 | 关联用户 |
| **permission_id** | VARCHAR | 权限ID | 🔴 高 | 权限标识 |
| **granted_at** | TIMESTAMP | 授权时间 | 🟢 低 | 审计用 |

### 7. user_menu_access（菜单访问权限表）
> 控制用户可访问的功能模块

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **user_id** | UUID | 用户ID | 🔴 高 | 关联用户 |
| **menu_feature_id** | VARCHAR | 菜单功能ID | 🔴 高 | 功能标识 |
| **enabled** | BOOLEAN | 是否启用 | 🔴 高 | 访问控制 |

## 🎯 业绩相关表

### 8. monthly_performance（月度业绩表）
> 预计算的月度业绩数据

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | INTEGER | 主键 | 🔴 高 | 唯一标识 |
| **user_id** | UUID | 用户ID | 🔴 高 | 业绩归属 |
| **year** | INTEGER | 年份 | 🔴 高 | 时间维度 |
| **month** | INTEGER | 月份 | 🔴 高 | 时间维度 |
| **revenue** | DECIMAL | 总收入 | 🔴 高 | 业绩数据 |
| **customer_count** | INTEGER | 客户数 | 🔴 高 | 业绩数据 |
| **personal_revenue** | DECIMAL | 个人业绩 | 🟡 中 | 区分来源 |
| **team_revenue** | DECIMAL | 团队业绩 | 🟡 中 | 经理使用 |

### 9. team_members（团队成员表）
> 经理与团队成员关系

| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **manager_id** | UUID | 经理ID | 🔴 高 | 管理关系 |
| **member_id** | UUID | 成员ID | 🔴 高 | 团队成员 |
| **department_id** | INTEGER | 部门ID | 🟡 中 | 组织归属 |
| **status** | VARCHAR | 状态 | 🟡 中 | active/inactive |

## 📝 其他业务表

### 10. experts（专家表）
| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | UUID | 专家ID | 🔴 高 | 唯一标识 |
| **name** | VARCHAR | 姓名 | 🔴 高 | 显示用 |
| **specialization** | VARCHAR | 专业领域 | 🟡 中 | 分类 |
| **bio** | TEXT | 简介 | 🟡 中 | 介绍 |

### 11. prospectuses（招商简章表）
| 字段名 | 类型 | 说明 | 重要性 | 使用场景 |
|-------|------|------|--------|----------|
| **id** | UUID | 简章ID | 🔴 高 | 唯一标识 |
| **title** | VARCHAR | 标题 | 🔴 高 | 显示用 |
| **content** | TEXT | 内容 | 🔴 高 | 详细信息 |
| **status** | VARCHAR | 状态 | 🟡 中 | published/draft |

## ⚠️ 常见错误与最佳实践

### ❌ 常见错误
1. **业绩统计错误**：使用 `training_sessions.salesperson_id` 而不是 `training_participants.salesperson_name`
2. **时间筛选错误**：使用错误的时间字段或时区处理不当
3. **权限字段混淆**：`permission_id` vs `permission_code`（不存在）
4. **菜单访问混淆**：`menu_feature_id` vs `menu_code`（不存在）

### ✅ 最佳实践
1. **业绩统计**：
   - 始终从 `training_participants` 表开始查询
   - 使用 `salesperson_name` 字段确定业绩归属
   - 直接使用 `payment_amount` 字段计算金额

2. **时间查询**：
   - 使用 `registration_date` 进行业绩时间范围筛选
   - 业绩算在成交时间（报名日期），不是培训发生时间

3. **关联查询**：
   - 避免过度嵌套的关联查询
   - 分步查询并使用 Map 关联数据

4. **权限检查**：
   - 前端路由权限
   - API层权限
   - RLS（行级安全）权限

## 📋 数据流向图

```
培训参与者(training_participants)
    ├── salesperson_name → 业务员业绩统计 ✅
    ├── payment_amount → 收入计算 ✅
    ├── registration_date → 业绩时间维度统计 ✅
    ├── training_session_id → 培训场次信息
    └── created_at → 记录创建时间（仅用于审计）

培训场次(training_sessions)
    ├── salesperson_id → 培训负责人 ⚠️（不是成交业务员）
    ├── name → 培训名称显示
    └── training_mode → 培训方式

用户档案(user_profiles)
    ├── name → 与 salesperson_name 匹配
    ├── role → 角色权限
    └── department_id → 部门归属
```

## 📊 业务员业绩统计最佳实践

### ✅ 正确的查询方法

**核心原则：使用 `training_participants` 表作为主表，按 `registration_date` 统计业绩**

#### 1️⃣ 统计某业务员某时间段的业绩

```sql
-- 示例：查询小周在2025年11月的业绩
SELECT 
  tp.salesperson_name as 业务员,
  COUNT(*) as 成交客户数,
  SUM(CAST(tp.payment_amount AS DECIMAL)) as 总业绩,
  array_agg(DISTINCT tp.name) as 客户名单
FROM training_participants tp
WHERE tp.salesperson_name = '小周'
  AND tp.registration_date >= '2025-11-01'
  AND tp.registration_date <= '2025-11-30'
GROUP BY tp.salesperson_name;
```

#### 2️⃣ 统计所有业务员的业绩排名

```sql
-- 示例：查询2025年11月所有业务员业绩排名
SELECT 
  tp.salesperson_name as 业务员,
  COUNT(*) as 成交客户数,
  SUM(CAST(tp.payment_amount AS DECIMAL)) as 总业绩
FROM training_participants tp
WHERE tp.registration_date >= '2025-11-01'
  AND tp.registration_date <= '2025-11-30'
GROUP BY tp.salesperson_name
ORDER BY 总业绩 DESC;
```

#### 3️⃣ 前端代码实现要点

```typescript
// 1. 按报名日期筛选参训数据
const { data: participantsData } = await supabase
  .from('training_participants')
  .select('*')
  .gte('registration_date', startDate)  // ✅ 使用 registration_date
  .lte('registration_date', endDate);

// 2. 提取业务员名称
const salespersonNames = [...new Set(
  participantsData?.map(p => p.salesperson_name).filter(Boolean)
)];

// 3. 查询业务员信息（分步查询，避免嵌套）
const { data: salespeople } = await supabase
  .from('user_profiles')
  .select('id, name, role, department_id')
  .in('name', salespersonNames);  // ✅ 用名称匹配

// 4. 按业务员汇总业绩
participantsData?.forEach(participant => {
  const revenue = Number(participant.payment_amount) || 0;  // ✅ 直接使用 payment_amount
  // ... 累加到对应业务员
});
```

### ⚠️ 常见错误

#### ❌ 错误1：使用 training_sessions.salesperson_id
```sql
-- ❌ 错误：这会导致业绩归属错误
SELECT 
  ts.salesperson_id,  -- 这是培训负责人，不是成交业务员
  COUNT(*)
FROM training_sessions ts
```

#### ❌ 错误2：使用 created_at 而非 registration_date
```sql
-- ❌ 错误：created_at 是记录创建时间，可能与报名时间不一致
WHERE tp.created_at >= '2025-11-01'  -- 应该用 registration_date
```

#### ❌ 错误3：使用 actual_price 作为备选
```typescript
// ❌ 错误：不要用 actual_price 作为备选
const revenue = participant.payment_amount || participant.actual_price;

// ✅ 正确：直接使用 payment_amount
const revenue = Number(participant.payment_amount) || 0;
```

### 📝 业绩统计时间维度说明

| 时间字段 | 业务含义 | 是否用于统计 |
|---------|---------|-------------|
| `registration_date` | 客户报名日期（成交时间） | ✅ **用于业绩统计** |
| `training_sessions.date` | 培训实际发生日期 | ❌ 不用于业绩统计 |
| `created_at` | 记录创建时间 | ❌ 不用于业绩统计 |

**统计逻辑**：业绩应该算在**成交时间**（报名日期），而不是培训发生时间或记录创建时间。

### 🎯 总结

1. **主表**：`training_participants`（参训人员表）
2. **业务员字段**：`salesperson_name`（业务员姓名）
3. **金额字段**：`payment_amount`（付款金额）
4. **时间字段**：`registration_date`（报名日期）
5. **匹配方式**：通过 `user_profiles.name` 匹配业务员信息

**记住**：培训场次表（training_sessions）的 salesperson_id 字段**不代表成交业务员**，仅表示培训的负责人或录入人。真实的成交业务员信息存储在 training_participants.salesperson_name 字段中。

## 📚 课程业绩明细统计最佳实践

### ✅ 正确的查询方法

**核心原则：从 `training_sessions` 关联 `training_participants`，按业务员分组统计每个课程的业绩**

#### 1️⃣ 查询单个课程的业务员业绩明细

```sql
-- 示例：查询"AI实战培训"各业务员的成交情况
SELECT 
  ts.name as 课程名称,
  tp.salesperson_name as 业务员,
  COUNT(tp.id) as 成交人数,
  SUM(CAST(tp.payment_amount AS DECIMAL)) as 业绩金额,
  ROUND(
    SUM(CAST(tp.payment_amount AS DECIMAL)) * 100.0 / 
    (SELECT SUM(CAST(payment_amount AS DECIMAL)) 
     FROM training_participants 
     WHERE training_session_id = ts.id), 
    1
  ) as 占比百分比
FROM training_sessions ts
INNER JOIN training_participants tp ON tp.training_session_id = ts.id
WHERE ts.name = 'AI实战培训'
GROUP BY ts.id, ts.name, tp.salesperson_name
ORDER BY 业绩金额 DESC;
```

**预期结果示例**：
```
课程名称        业务员    成交人数    业绩金额     占比百分比
AI实战培训      小周      4          22720       66.7
AI实战培训      李四      2          11360       33.3
```

#### 2️⃣ 查询所有课程的业务员明细

```sql
-- 查询本月所有课程的业务员业绩明细
SELECT 
  ts.name as 课程名称,
  ts.date as 开课日期,
  tp.salesperson_name as 业务员,
  COUNT(tp.id) as 成交人数,
  SUM(CAST(tp.payment_amount AS DECIMAL)) as 业绩金额,
  COUNT(CASE WHEN tp.participation_mode = 'online' THEN 1 END) as 线上人数,
  COUNT(CASE WHEN tp.participation_mode = 'offline' THEN 1 END) as 线下人数
FROM training_sessions ts
INNER JOIN training_participants tp ON tp.training_session_id = ts.id
WHERE ts.date >= '2025-11-01' 
  AND ts.date <= '2025-11-30'
GROUP BY ts.id, ts.name, ts.date, tp.salesperson_name
ORDER BY ts.date DESC, 业绩金额 DESC;
```

#### 3️⃣ TypeScript/JavaScript 实现（按业务员分组）

```typescript
// 查询培训场次及其参训人员
const { data: sessions } = await supabase
  .from('training_sessions')
  .select(`
    id,
    name,
    date,
    training_participants(
      id,
      salesperson_name,
      payment_amount,
      participation_mode
    )
  `)
  .gte('date', startDate)
  .lte('date', endDate);

// 处理每个课程的数据
const courseDetails = sessions?.map(session => {
  const participants = session.training_participants || [];
  
  // 按业务员分组统计
  const salespersonStats = new Map();
  let totalRevenue = 0;
  
  participants.forEach(p => {
    const spName = p.salesperson_name || '未分配';
    const revenue = Number(p.payment_amount) || 0;
    totalRevenue += revenue;
    
    if (!salespersonStats.has(spName)) {
      salespersonStats.set(spName, { name: spName, count: 0, revenue: 0 });
    }
    
    const stats = salespersonStats.get(spName);
    stats.count += 1;
    stats.revenue += revenue;
  });
  
  // 计算占比
  const salespersonList = Array.from(salespersonStats.values()).map(sp => ({
    name: sp.name,
    count: sp.count,
    revenue: sp.revenue,
    percentage: totalRevenue > 0 ? ((sp.revenue / totalRevenue) * 100).toFixed(1) : '0'
  }));
  
  return {
    courseName: session.name,
    sessionDate: session.date,
    totalParticipants: participants.length,
    totalRevenue: totalRevenue,
    salespersonList: salespersonList  // 业务员明细列表
  };
});
```

### ⚠️ 常见错误

#### ❌ 错误1：使用 training_sessions.salesperson_id

```sql
-- ❌ 错误：这样只能看到培训负责人，看不到实际成交的业务员
SELECT 
  ts.name,
  up.name as 业务员,
  COUNT(*) as 人数
FROM training_sessions ts
LEFT JOIN user_profiles up ON up.id = ts.salesperson_id
LEFT JOIN training_participants tp ON tp.training_session_id = ts.id
GROUP BY ts.id, up.name;
```

**问题**：
- `training_sessions.salesperson_id` 是培训的组织者/负责人
- 实际成交可能是多个不同的业务员
- 会导致统计结果与实际不符

#### ❌ 错误2：不分组统计，只显示总数

```sql
-- ❌ 错误：看不到各业务员的贡献
SELECT 
  ts.name,
  COUNT(tp.id) as 总人数,
  SUM(tp.payment_amount) as 总金额
FROM training_sessions ts
LEFT JOIN training_participants tp ON tp.training_session_id = ts.id
GROUP BY ts.id, ts.name;
```

**问题**：
- 无法区分是哪些业务员成交的
- 无法评估各业务员的贡献度
- 不利于业绩分析和激励

### 📝 数据关系图

```
training_sessions (课程)
    ├── id
    ├── name (课程名称)
    └── date (开课日期)
         │
         └─┬─> training_participants (参训人员)
           │      ├── salesperson_name ✅ (实际成交业务员)
           │      ├── payment_amount ✅ (成交金额)
           │      └── participation_mode (参训模式)
           │
           └──> 按 salesperson_name 分组
                ├── 业务员A: 3人, ¥15,000 (50%)
                ├── 业务员B: 2人, ¥10,000 (33%)
                └── 业务员C: 1人, ¥5,000 (17%)
```

### 🎯 关键要点

1. **一个课程 → 多个业务员**：同一培训课程可能由多个业务员分别成交客户
2. **数据来源**：`training_participants.salesperson_name`（实际成交人）
3. **统计维度**：
   - 第一层：按课程（training_sessions）
   - 第二层：按业务员（salesperson_name）分组
4. **统计指标**：
   - 每个业务员的成交人数
   - 每个业务员的成交金额
   - 占该课程总收入的百分比

### 💡 实际应用场景

**场景1：查看某课程的业务员贡献**
- 用途：了解哪些业务员在推广此课程上更有效
- 方法：展开课程明细，查看各业务员的成交情况

**场景2：业绩核算**
- 用途：月度业绩结算，准确计算每个业务员的收入
- 方法：汇总所有课程中该业务员的成交金额

**场景3：课程推广分析**
- 用途：分析哪些课程由多个业务员共同推广效果更好
- 方法：统计业务员数量多且总收入高的课程

## 🔄 更新记录
- 2025-11-07：初始版本，明确字段用途，特别标注易混淆字段
- 2025-11-07：新增"业务员业绩统计最佳实践"章节，详细说明正确的查询方法和常见错误
- 2025-11-07：新增"课程业绩明细统计最佳实践"章节，说明如何按课程和业务员分组统计业绩
