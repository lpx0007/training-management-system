# 更新 - 会务客服权限逻辑

**更新日期**: 2025-11-17  
**优先级**: 🔴 高（用户反馈）  
**状态**: ✅ 已完成  

## 问题描述

会务客服虽然已分配了所有招商简章和课表权限（`prospectus_edit`、`schedule_edit`），但在页面上仍然看不到"编辑"和"删除"按钮。

### 用户反馈

> "会务客服我已经开了招商简章的所有权限，但是这里还是无法编辑和修改"

### 问题截图

招商简章列表页面，会务客服看不到编辑按钮：
- 周宁2020年居规房产市场招商简章ZY
- 周宁市场房企编分析

---

## 问题原因

### 原有逻辑

**招商简章** (`ProspectusManagement.tsx` 第139-150行):
```typescript
const canEdit = (prospectus: Prospectus): boolean => {
  if (user?.role === 'admin') return true;
  
  // ❌ 问题：只能编辑自己上传的
  if (user?.role === 'conference_service') {
    return prospectus.uploaded_by === user?.id;
  }
  
  return false;
};
```

**课表管理** (`ScheduleManagement.tsx` 第101-112行):
```typescript
const canEdit = (schedule: Schedule): boolean => {
  if (user?.role === 'admin') return true;
  
  // ❌ 问题：只能编辑自己上传的
  if (user?.role === 'conference_service') {
    return schedule.uploaded_by === user?.id;
  }
  
  return false;
};
```

### 问题分析

**限制过严**：
- 会务客服只能编辑 `uploaded_by === user.id` 的资料
- 如果简章/课表是管理员或其他人上传的，会务客服无法编辑
- 即使管理员已分配 `prospectus_edit` 权限，前端代码仍然阻止了操作

**场景示例**：
```
场景：管理员上传了"周宁市场房企编分析"简章
      管理员给会务客服分配了 prospectus_edit 权限

结果：
✅ 会务客服可以在权限管理中看到权限
✅ 会务客服可以访问招商简章页面
❌ 会务客服看不到"编辑"和"删除"按钮
   原因：prospectus.uploaded_by != user.id
```

---

## 修复方案

### 新的权限逻辑

**方案**：基于权限判断，而非上传人

**修改后的逻辑**：

```typescript
const canEdit = (prospectus: Prospectus): boolean => {
  // 管理员可以编辑所有
  if (user?.role === 'admin') return true;
  
  // ✅ 会务客服只要有编辑权限，就可以编辑所有简章
  if (user?.role === 'conference_service') {
    return user?.permissions?.includes('prospectus_edit') || false;
  }
  
  return false;
};
```

**核心改变**：
- **之前**：`prospectus.uploaded_by === user?.id` （基于上传人）
- **现在**：`user?.permissions?.includes('prospectus_edit')` （基于权限）

---

## 修改文件

### 1. 招商简章管理 ✅

**文件**: `src/pages/ProspectusManagement.tsx`

**修改位置**: 第139-151行

**修改内容**:
```typescript
// 判断是否可以编辑/删除简章
const canEdit = (prospectus: Prospectus): boolean => {
  // 管理员可以编辑所有
  if (user?.role === 'admin') return true;
  
  // 会务客服如果有编辑权限，可以编辑所有简章
  if (user?.role === 'conference_service') {
    // 检查是否有 prospectus_edit 权限
    return user?.permissions?.includes('prospectus_edit') || false;
  }
  
  // 其他角色不能编辑
  return false;
};
```

---

### 2. 课表管理 ✅

**文件**: `src/pages/ScheduleManagement.tsx`

**修改位置**: 第101-113行

**修改内容**:
```typescript
// 判断是否可以编辑/删除课表
const canEdit = (schedule: Schedule): boolean => {
  // 管理员可以编辑所有
  if (user?.role === 'admin') return true;
  
  // 会务客服如果有编辑权限，可以编辑所有课表
  if (user?.role === 'conference_service') {
    // 检查是否有 schedule_edit 权限
    return user?.permissions?.includes('schedule_edit') || false;
  }
  
  // 其他角色不能编辑
  return false;
};
```

---

## 验证步骤

### 步骤1：刷新页面

会务客服需要：
1. **退出登录**
2. **清除浏览器缓存** (Ctrl+Shift+Delete)
3. **重新登录**

---

### 步骤2：验证招商简章

1. 会务客服登录
2. 进入"招商简章"页面
3. 查看简章列表

**预期结果**：
- ✅ 所有简章都显示"编辑"按钮
- ✅ 所有简章都显示"删除"按钮
- ✅ 点击"编辑"可以修改简章信息
- ✅ 点击"删除"可以删除简章

包括：
- 管理员上传的简章 ✅
- 其他会务客服上传的简章 ✅
- 自己上传的简章 ✅

---

### 步骤3：验证课表管理

1. 进入"课表管理"页面
2. 查看课表列表

**预期结果**：
- ✅ 所有课表都显示"编辑"按钮
- ✅ 所有课表都显示"删除"按钮
- ✅ 可以编辑和删除所有课表

---

### 步骤4：验证权限控制

**测试不同权限组合**：

| 权限配置 | 预期结果 |
|---------|---------|
| 有 `prospectus_view` + `prospectus_edit` | ✅ 可以查看和编辑所有简章 |
| 只有 `prospectus_view` | ✅ 可以查看，❌ 不能编辑 |
| 没有任何权限 | ❌ 无法访问页面 |
| 有 `schedule_view` + `schedule_edit` | ✅ 可以查看和编辑所有课表 |
| 只有 `schedule_view` | ✅ 可以查看，❌ 不能编辑 |

---

## 权限矩阵（更新后）

### 招商简章权限

| 操作 | admin | conference_service (有edit权限) | conference_service (无edit权限) | 其他角色 |
|------|-------|-------------------------------|-------------------------------|---------|
| 查看列表 | ✅ | ✅ | ✅ | 视权限 |
| 上传简章 | ✅ | ✅ | ❌ | ❌ |
| 编辑**所有**简章 | ✅ | ✅ (新增) | ❌ | ❌ |
| 删除**所有**简章 | ✅ | ✅ (新增) | ❌ | ❌ |
| 下载简章 | ✅ | ✅ | ✅ | 视权限 |
| 关联课程 | ✅ | ❌ | ❌ | ❌ |

### 课表管理权限

| 操作 | admin | conference_service (有edit权限) | conference_service (无edit权限) | 其他角色 |
|------|-------|-------------------------------|-------------------------------|---------|
| 查看列表 | ✅ | ✅ | ✅ | 视权限 |
| 上传课表 | ✅ | ✅ | ❌ | ❌ |
| 编辑**所有**课表 | ✅ | ✅ (新增) | ❌ | ❌ |
| 删除**所有**课表 | ✅ | ✅ (新增) | ❌ | ❌ |
| 下载课表 | ✅ | ✅ | ✅ | 视权限 |
| 关联课程 | ✅ | ❌ | ❌ | ❌ |

---

## 逻辑对比

### 之前（基于上传人）

**优点**：
- ✅ 数据隔离性好
- ✅ 责任明确（只能管理自己的）

**缺点**：
- ❌ 不够灵活
- ❌ 团队协作不便
- ❌ 管理员分配权限后仍无法操作

**适用场景**：
- 每个会务客服独立管理自己的资料
- 不需要跨人员编辑

---

### 现在（基于权限）

**优点**：
- ✅ 更灵活
- ✅ 符合RBAC权限模型
- ✅ 管理员可以通过权限控制访问
- ✅ 便于团队协作

**缺点**：
- ⚠️ 需要管理员谨慎分配权限
- ⚠️ 会务客服可以编辑他人资料

**适用场景**：
- 会务团队协作管理资料
- 灵活的权限控制
- 需要多人编辑同一资料

---

## 安全建议

### 数据库RLS策略（可选增强）

如果需要更严格的控制，可以添加数据库层保护：

```sql
-- 招商简章RLS策略
CREATE POLICY "conference_service_edit_prospectus" 
ON prospectuses
FOR UPDATE 
USING (
  EXISTS (
    SELECT 1 FROM user_profiles up
    INNER JOIN user_permissions perm ON up.id = perm.user_id
    WHERE up.id = auth.uid()
      AND up.role = 'conference_service'
      AND perm.permission_id = 'prospectus_edit'
  )
);

-- 课表RLS策略
CREATE POLICY "conference_service_edit_schedule" 
ON schedules
FOR UPDATE 
USING (
  EXISTS (
    SELECT 1 FROM user_profiles up
    INNER JOIN user_permissions perm ON up.id = perm.user_id
    WHERE up.id = auth.uid()
      AND up.role = 'conference_service'
      AND perm.permission_id = 'schedule_edit'
  )
);
```

**作用**：
- 提供数据库层的双重保护
- 即使前端被绕过，数据库也会验证权限

**优先级**：
- 中（当前前端控制已足够）
- 如需更高安全性，可考虑实施

---

## 使用场景

### 场景1：会务团队协作

```
情况：
- 会务主管上传了10个招商简章
- 需要团队成员协助修改和维护

解决方案：
✅ 管理员给所有会务客服分配 prospectus_edit 权限
✅ 所有会务客服都能编辑所有简章
✅ 便于团队协作

结果：
团队工作效率提升 ✨
```

---

### 场景2：会务客服接手工作

```
情况：
- 原会务客服A离职
- 新会务客服B接手A的工作
- 需要编辑A上传的简章

解决方案（之前）：
❌ 无法编辑（uploaded_by = A的ID）
❌ 需要管理员逐个修改 uploaded_by

解决方案（现在）：
✅ 管理员给B分配 prospectus_edit 权限
✅ B可以编辑所有简章
✅ 工作交接顺畅

结果：
工作交接更便捷 ✨
```

---

### 场景3：权限回收

```
情况：
- 某会务客服C不再负责简章管理
- 需要收回编辑权限

解决方案：
✅ 管理员取消C的 prospectus_edit 权限
✅ C只能查看，不能编辑
✅ 权限控制清晰

结果：
权限管理更灵活 ✨
```

---

## 注意事项

### 1. 权限分配

⚠️ **管理员需谨慎分配权限**：
- `prospectus_edit` 权限允许编辑**所有**简章
- `schedule_edit` 权限允许编辑**所有**课表
- 不要给不需要编辑权限的用户分配

---

### 2. 审计日志

💡 **建议**：
- 记录所有编辑和删除操作
- 记录操作人和操作时间
- 便于追踪责任和问题排查

```typescript
// 可以在编辑/删除时添加日志
await auditLog.create({
  action: 'edit_prospectus',
  user_id: user.id,
  resource_id: prospectus.id,
  timestamp: new Date()
});
```

---

### 3. 数据备份

💡 **建议**：
- 定期备份简章和课表
- 防止误删或误编辑
- 可快速恢复

---

## 代码说明

### TypeScript lint 警告

修改后会出现以下 lint 警告：

```
'prospectus' is declared but its value is never read.
'schedule' is declared but its value is never read.
```

**原因**：
- 函数参数 `prospectus` 和 `schedule` 未在函数体内使用
- 因为现在基于 `user.permissions` 判断，不再需要检查资料的 `uploaded_by`

**是否需要修复**：
- ❌ 不需要
- 函数签名必须保持一致（调用时需要传入参数）
- 警告不影响功能

**如需消除警告**：
```typescript
const canEdit = (_prospectus: Prospectus): boolean => {
  // 使用下划线前缀表示未使用的参数
}
```

---

## 相关文档

1. **`docs/会务客服简章课表权限方案.md`**
   - 原始权限实施方案
   - 两阶段实施计划

2. **`docs/实施完成-会务客服简章课表权限.md`**
   - 第一阶段实施细节
   - 完整的权限矩阵

3. **`docs/修复-会务客服权限设置失败.md`**
   - 菜单功能缺失问题修复

4. **`docs/更新-会务客服权限逻辑.md`**
   - 本文档（权限逻辑更新）

---

## 版本历史

- **v1.0** (2025-11-16): 第一阶段实施（基于上传人）
- **v1.1** (2025-11-17): **权限逻辑更新（基于权限）** ← 当前版本

---

## 总结

### 核心改进

**从**：
```
会务客服只能编辑自己上传的简章和课表
```

**到**：
```
会务客服可以编辑所有简章和课表（如果有相应权限）
```

### 实现方式

**权限判断**：基于 `user.permissions`  
**UI控制**：动态显示编辑/删除按钮  
**灵活性**：管理员通过权限管理控制访问

### 业务价值

**1. 提升灵活性** ✅
- 权限控制更精细
- 便于团队协作
- 工作交接更顺畅

**2. 简化管理** ✅
- 管理员在UI中直接分配权限
- 无需修改数据库
- 权限回收方便

**3. 符合RBAC** ✅
- 基于角色的访问控制
- 权限和资料所有权解耦
- 架构更合理

现在会务客服可以编辑所有简章和课表了！🎉

---

## FAQ

**Q1：会务客服能编辑其他人上传的简章吗？**  
A：✅ 可以，只要有 `prospectus_edit` 权限

**Q2：如何限制会务客服只能编辑自己的简章？**  
A：取消 `prospectus_edit` 权限，或恢复之前基于上传人的逻辑

**Q3：管理员如何控制权限？**  
A：在"权限管理"页面，勾选或取消相应权限

**Q4：会不会有安全问题？**  
A：UI层已有权限控制，如需更严格可添加RLS策略

**Q5：之前上传的资料会受影响吗？**  
A：❌ 不会，只是编辑权限逻辑改变了
