# 培训场次状态管理说明

**版本**: v1.0  
**日期**: 2025-11-09  
**状态**: ✅ 已优化

---

## 🎯 状态自动判断逻辑

### 状态定义

培训场次有三种状态，根据**当前日期**与**培训日期范围**自动判断：

| 状态 | 英文值 | 判断条件 | 说明 |
|------|--------|----------|------|
| 即将开始 | `upcoming` | 当前日期 < 开始日期 | 培训还未开始 |
| 进行中 | `ongoing` | 开始日期 ≤ 当前日期 ≤ 结束日期 | 培训正在进行 |
| 已完成 | `completed` | 当前日期 > 结束日期 | 培训已经结束 |

### 状态判断函数

```typescript
const calculateTrainingStatus = (startDate: string, endDate?: string): string => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const start = new Date(startDate);
  start.setHours(0, 0, 0, 0);
  
  // 如果有结束日期，使用结束日期；否则使用开始日期
  const end = endDate ? new Date(endDate) : new Date(startDate);
  end.setHours(0, 0, 0, 0);
  
  if (today < start) {
    return 'upcoming';      // 即将开始
  } else if (today > end) {
    return 'completed';     // 已完成
  } else {
    return 'ongoing';       // 进行中
  }
};
```

---

## 🔒 添加参训人权限控制

### 业务规则

**只有未完成的培训才能添加参训人**

- ✅ **即将开始** - 可以添加
- ✅ **进行中** - 可以添加（培训进行时可能有补报名）
- ❌ **已完成** - 不能添加（培训结束后不应再添加参训人）

### 实现位置

#### 1. 培训列表（表格视图）

```typescript
<PermissionGuard permission="training_add_participant">
  {session.status !== 'completed' && (
    <button 
      onClick={() => handleAddCustomer(session.id)}
    >
      添加团组/人
    </button>
  )}
</PermissionGuard>
```

**位置**: `TrainingPerformance.tsx` line 1247-1256

#### 2. 培训详情页面

```typescript
<PermissionGuard permission="training_add_participant">
  {selectedSession.status !== 'completed' && (
    <button 
      onClick={() => handleAddCustomer(selectedSession.id)}
    >
      添加团组/人
    </button>
  )}
</PermissionGuard>
```

**位置**: `TrainingPerformance.tsx` line 2175-2184

---

## 📊 状态显示

### 列表视图

在培训列表中，状态以**标签**形式显示：

```
🟡 即将开始  (黄色)
🔵 进行中    (蓝色)
🟢 已完成    (绿色)
```

### 状态样式

```typescript
<span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
  session.status === 'completed'
    ? 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300'
    : session.status === 'upcoming'
    ? 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300'
    : 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300'
}`}>
  {session.status === 'completed' ? '已完成' : 
   session.status === 'upcoming' ? '即将开始' : '进行中'}
</span>
```

---

## 🔄 状态更新时机

### 自动更新

状态在以下时机自动重新计算：

1. **添加新培训** - 创建时根据日期自动设置状态
2. **页面加载** - 每次加载数据时重新计算状态
3. **编辑培训** - 修改日期时重新计算状态

### 手动更新

管理员可以在**编辑培训**时手动修改状态（如有特殊情况）：

```html
<select name="status">
  <option value="upcoming">即将开始</option>
  <option value="ongoing">进行中</option>
  <option value="completed">已完成</option>
</select>
```

---

## 📝 示例场景

### 场景 1: 多天培训

**培训信息**：
- 开始日期: 2025-11-15
- 结束日期: 2025-11-17
- 当前日期: 2025-11-16

**状态判断**：
```
当前日期 (11-16) >= 开始日期 (11-15) ✅
当前日期 (11-16) <= 结束日期 (11-17) ✅
→ 状态: 进行中 (ongoing)
→ 可以添加参训人 ✅
```

### 场景 2: 单天培训

**培训信息**：
- 开始日期: 2025-11-10
- 结束日期: 2025-11-10（或 null）
- 当前日期: 2025-11-09

**状态判断**：
```
当前日期 (11-09) < 开始日期 (11-10) ✅
→ 状态: 即将开始 (upcoming)
→ 可以添加参训人 ✅
```

### 场景 3: 已结束培训

**培训信息**：
- 开始日期: 2025-10-01
- 结束日期: 2025-10-03
- 当前日期: 2025-11-09

**状态判断**：
```
当前日期 (11-09) > 结束日期 (10-03) ✅
→ 状态: 已完成 (completed)
→ 不能添加参训人 ❌
```

---

## 🔧 技术细节

### 实时状态计算

**核心改进**：状态不再依赖数据库存储的值，而是每次显示时实时计算。

```typescript
// 在列表中显示时
{(() => {
  const realStatus = calculateTrainingStatus(session.date, session.endDate || undefined);
  return (
    <span className={/* 根据 realStatus 显示样式 */}>
      {realStatus === 'completed' ? '已完成' : 
       realStatus === 'upcoming' ? '即将开始' : '进行中'}
    </span>
  );
})()}
```

**优势**：
- ✅ 始终显示最新状态
- ✅ 无需定时任务更新数据库
- ✅ 2026年的培训自动显示为"即将开始"
- ✅ 昨天结束的培训自动显示为"已完成"

### 日期比较

所有日期比较都设置为**零点时间**，避免时区和时间问题：

```typescript
const today = new Date();
today.setHours(0, 0, 0, 0);  // 设为 00:00:00.000

const start = new Date(startDate);
start.setHours(0, 0, 0, 0);
```

### 边界情况

- **没有结束日期** - 使用开始日期作为结束日期
- **结束日期早于开始日期** - 在表单提交时会验证并报错
- **同一天** - 开始日期 = 结束日期 = 当前日期 → 状态为"进行中"

---

## ✅ 优化内容

### 本次优化（2025-11-09）

1. ✅ **优化状态判断逻辑**
   - 之前：只考虑开始日期
   - 现在：同时考虑开始日期和结束日期

2. ✅ **调整添加参训人权限**
   - 之前：只有"即将开始"才能添加
   - 现在："即将开始"和"进行中"都可以添加

3. ✅ **统一按钮文案**
   - "添加培训人" → "添加团组/人"

4. ✅ **实时计算状态显示** ⭐ 重要
   - 之前：显示数据库存储的状态（可能过期）
   - 现在：每次显示时实时计算状态（始终准确）
   - 影响：2026年的培训现在正确显示为"即将开始"

5. ✅ **完善注释和文档**
   - 添加详细的状态判断逻辑说明
   - 创建本说明文档

---

## 🧪 测试清单

### 状态判断测试

- [x] 未来日期 → 即将开始
- [x] 今天开始 → 进行中
- [x] 多天培训进行中 → 进行中
- [x] 培训最后一天 → 进行中
- [x] 过去日期 → 已完成
- [x] 无结束日期 → 正确处理

### 权限测试

- [x] 即将开始 → 显示"添加团组/人"按钮
- [x] 进行中 → 显示"添加团组/人"按钮
- [x] 已完成 → 不显示"添加团组/人"按钮
- [x] 列表和详情页按钮一致

### UI测试

- [x] 状态标签颜色正确
- [x] 按钮文案统一
- [x] 权限守卫生效

---

## 💡 最佳实践

### 创建培训时

1. **设置合理的日期范围**
   - 多天培训务必填写结束日期
   - 单天培训可以不填结束日期

2. **状态会自动计算**
   - 无需手动设置状态
   - 系统根据日期自动判断

### 管理培训时

1. **及时更新日期**
   - 如果培训延期或提前，及时修改日期
   - 状态会自动更新

2. **注意状态限制**
   - 已完成的培训不能添加参训人
   - 如需补录，需先修改日期

---

## 📖 相关文档

- 培训计划管理功能文档
- 权限系统说明文档
- 数据库表结构说明

---

**状态**: ✅ 已优化  
**测试**: ✅ 通过  
**可用性**: ✅ 立即生效

刷新浏览器即可体验优化后的状态管理！🚀
