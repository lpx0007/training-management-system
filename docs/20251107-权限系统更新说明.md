# 2025-11-07 权限系统更新说明

## 📋 更新概述

今天新增的功能涉及业绩数据查看和导出，现已完成权限系统的完整集成。

---

## 🆕 新增权限

### 1. **performance_export** - 导出业绩数据
- **权限代码**: `performance_export`
- **权限名称**: 导出业绩数据
- **权限描述**: 导出业务员业绩和课程销售业绩数据（含明细）
- **权限分类**: 数据管理 (data)
- **功能说明**: 
  - 允许在数据管理页面导出"业务员业绩"和"课程销售业绩"
  - 导出的Excel包含汇总表和每个业务员的明细工作表
- **默认分配**:
  - ✅ Admin (管理员)
  - ✅ Manager (部门经理)
  - ❌ Salesperson (业务员)
  - ❌ Expert (专家)

### 2. **performance_view_all_departments** - 查看所有部门业绩
- **权限代码**: `performance_view_all_departments`
- **权限名称**: 查看所有部门业绩
- **权限描述**: 查看跨部门的业务员业绩数据（经理默认只能看本部门）
- **权限分类**: 业务员管理 (salesperson)
- **功能说明**: 
  - 允许部门经理查看其他部门的业务员业绩数据
  - 默认情况下，经理只能看到本部门的数据
  - 获得此权限后，可以查看所有部门的业绩
- **默认分配**:
  - ✅ Admin (管理员) - 自动拥有
  - ⚠️ Manager (部门经理) - **需要管理员手动分配**
  - ❌ Salesperson (业务员)
  - ❌ Expert (专家)

---

## 🔧 修改的文件

### 前端代码修改

1. **`src/constants/permissions.ts`**
   - 在 `PERMISSION_CATEGORIES.DATA` 中添加 `performance_export` 权限
   - 在 `PERMISSION_CATEGORIES.SALESPERSON` 中添加 `performance_view_all_departments` 权限
   - 更新 `ROLE_DEFAULT_PERMISSIONS.manager` 添加 `performance_export`

2. **`src/constants/menuFeatures.ts`**
   - 在 `data_management` 菜单的 `requiredPermissions` 中添加 `performance_export`

3. **`src/constants/featurePermissionMapping.ts`** ⭐ 新增
   - 在 `data_management` 功能面板中添加 `performance_export` 权限
   - 在 `salesperson_management` 功能面板中添加 `performance_view_all_departments` 权限
   - 在 `sales_tracking` 功能面板中添加 `performance_view_all_departments` 权限

4. **`src/hooks/useDataManagementPermissions.ts`**
   - 更新 `salesperson_performance` 的导出权限映射：`data_view_history` → `performance_export`
   - 更新 `course_sales_performance` 的导出权限映射：`data_view_history` → `performance_export`
   - 添加管理员向后兼容逻辑（管理员直接通过）

5. **`src/lib/services/performanceService.ts`**
   - `getMonthlyPerformance` 函数添加参数：`userRole`, `userDepartmentId`, `permissions`
   - 添加部门数据范围过滤逻辑
   - 保存 `departmentId` 用于数据过滤

6. **`src/lib/services/dataManagementService.ts`**
   - 更新 `exportData` 方法，支持部门数据范围过滤
   - 管理员不受数据范围限制

7. **`src/lib/exporters/fileExporter.ts`**
   - 实现多工作表导出功能（汇总表 + 业务员明细表）

### 数据库脚本

**`scripts/add-performance-export-permissions.sql`**
- 添加2个新权限到 `permissions` 表
- 为所有 admin 自动分配两个权限
- 为所有 manager 自动分配 `performance_export` 权限
- 提供权限验证查询

---

## 🎯 数据范围控制逻辑

### 部门经理的数据可见性

```typescript
// 默认行为（无 performance_view_all_departments 权限）
if (userRole === 'manager' && userDepartmentId && !permissions?.includes('performance_view_all_departments')) {
  // 只显示本部门的业务员业绩数据
  salesPersonData = salesPersonData.filter(person => person.departmentId === userDepartmentId);
}

// 拥有权限后
if (permissions?.includes('performance_view_all_departments')) {
  // 显示所有部门的业务员业绩数据
}
```

### 权限组合效果

| 角色 | performance_export | performance_view_all_departments | 可见数据范围 | 可导出 |
|------|-------------------|----------------------------------|------------|--------|
| Admin | ✅ 自动拥有 | ✅ 自动拥有 | 所有部门 | ✅ |
| Manager (默认) | ✅ 自动拥有 | ❌ 默认无 | 仅本部门 | ✅ |
| Manager (授权后) | ✅ 自动拥有 | ✅ 手动授权 | 所有部门 | ✅ |
| Salesperson | ❌ | ❌ | N/A | ❌ |
| Expert | ❌ | ❌ | N/A | ❌ |

---

## 📝 实施步骤

### 1. 更新数据库权限

```bash
# 连接到 Supabase 数据库
# 执行脚本
psql -h [your-db-host] -U postgres -d postgres -f scripts/add-performance-export-permissions.sql
```

### 2. 验证权限添加

```sql
-- 查看新权限
SELECT code, name, description, category 
FROM permissions 
WHERE code IN ('performance_export', 'performance_view_all_departments');

-- 查看权限分配情况
SELECT 
  p.code,
  up.role,
  COUNT(*) AS user_count
FROM permissions p
LEFT JOIN user_permissions uper ON p.id = uper.permission_id
LEFT JOIN user_profiles up ON uper.user_id = up.id
WHERE p.code IN ('performance_export', 'performance_view_all_departments')
GROUP BY p.code, up.role;
```

### 3. 前端代码已自动更新

所有前端代码修改已完成，权限系统会自动生效。

---

## 🎨 功能演示

### 数据管理页面 - 业务员业绩导出

1. 选择"业务员业绩"数据类型
2. 设置筛选条件（时间范围、部门、业务员）
3. 点击"导出数据"
4. 下载的Excel包含：
   - **Sheet 1: 业绩汇总** - 所有业务员的汇总数据
   - **Sheet 2+: 业务员明细** - 每个业务员的成交客户明细

### 销售追踪页面 - 数据范围控制

**部门经理（默认）**:
- 只能看到本部门业务员的业绩
- 统计数据仅包含本部门

**部门经理（授权后）**:
- 可以看到所有部门业务员的业绩
- 统计数据包含全公司

---

## ⚙️ 管理员操作指南

### 为部门经理授予跨部门查看权限

1. 进入"权限管理"页面
2. 找到需要授权的部门经理
3. 点击"编辑权限"
4. 在"业务员管理"分类下，勾选"查看所有部门业绩"
5. 点击"保存"

授权后，该经理可以：
- ✅ 在销售追踪页面查看所有部门的业绩排名
- ✅ 导出所有部门的业绩数据
- ✅ 查看完整的业绩统计数据

---

## 🔍 测试验证

### 测试场景 1: 部门经理（默认权限）

```
角色: manager
部门: 销售一部 (department_id = 1)
权限: performance_export (有)
      performance_view_all_departments (无)

预期结果:
- ✅ 可以访问数据管理页面
- ✅ 可以选择"业务员业绩"导出
- ✅ 导出的数据只包含销售一部的业务员
- ✅ 销售追踪页面只显示销售一部的数据
```

### 测试场景 2: 部门经理（跨部门权限）

```
角色: manager
部门: 销售一部 (department_id = 1)
权限: performance_export (有)
      performance_view_all_departments (有)

预期结果:
- ✅ 可以访问数据管理页面
- ✅ 可以选择"业务员业绩"导出
- ✅ 导出的数据包含所有部门的业务员
- ✅ 销售追踪页面显示所有部门的数据
```

### 测试场景 3: 业务员

```
角色: salesperson
权限: performance_export (无)

预期结果:
- ❌ 数据管理页面看不到"业务员业绩"选项
- ❌ 无法导出业绩数据
```

---

## 📚 相关文档

- [权限系统三层架构详解.md](./权限系统三层架构详解.md)
- [数据库表结构与字段说明.md](./数据库表结构与字段说明.md)
- [经理权限编辑功能说明.md](./经理权限编辑功能说明.md)

---

## 🐛 注意事项

1. **权限同步**: 新权限添加后，需要刷新页面才能生效
2. **数据库迁移**: 必须先执行SQL脚本，再启动前端应用
3. **部门ID**: 确保用户的 `department_id` 字段正确设置
4. **权限缓存**: 如果权限不生效，尝试清除浏览器缓存或重新登录

---

## 📞 联系支持

如有问题，请联系系统管理员或查看：
- 项目文档目录: `/docs`
- SQL脚本目录: `/scripts`
- 权限配置文件: `/src/constants/permissions.ts`
