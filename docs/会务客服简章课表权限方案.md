# 会务客服简章课表权限方案

**创建日期**: 2025-11-16  
**优先级**: 🟡 中等（权限优化）  
**状态**: ✅ 第一阶段完成  

## 需求说明

会务客服需要能够查看、修改、更新自己负责的课程简章和课表。

### 业务背景

**原权限**:
- ✅ 查看招商简章列表 (prospectus_view)
- ✅ 下载招商简章 (prospectus_download)
- ✅ 查看课表列表 (schedule_view)
- ✅ 下载课表 (schedule_download)

**新增权限需求**:
- ➕ 上传招商简章 (prospectus_upload)
- ➕ 编辑招商简章 (prospectus_edit)
- ➕ 上传课表 (schedule_upload)
- ➕ 编辑课表 (schedule_edit)

**限制条件**:
- 只能管理"自己负责的课程"的简章和课表

## 实现方案

### 方案对比

#### 方案一：基于上传人（短期方案）✅ 已实施

**实现方式**:
- 使用现有的 `uploaded_by` 字段
- 会务客服只能编辑/删除自己上传的简章和课表
- 不需要修改数据库结构

**优点**:
- ✅ 实现简单快速
- ✅ 不需要数据库迁移
- ✅ 使用现有字段
- ✅ 立即可用

**缺点**:
- ❌ 不是真正的"课程负责人"概念
- ❌ 如果课程负责人变更，权限转移麻烦
- ❌ 不能跨用户管理同一课程的资料

**适用场景**:
- 每个会务客服负责不同的课程
- 资料由负责人自己上传和维护
- 短期快速实现

---

#### 方案二：基于课程关联（长期方案）📋 待实施

**实现方式**:
- 在 `prospectuses` 表添加 `course_id` 字段
- 在 `schedules` 表添加 `course_id` 字段
- 通过 course 的 `project_manager_id` 判断权限
- 会务客服可以管理自己负责课程的所有资料

**数据库改动**:
```sql
-- 简章表添加课程关联
ALTER TABLE prospectuses 
ADD COLUMN course_id INTEGER REFERENCES courses(id);

-- 课表表添加课程关联  
ALTER TABLE schedules 
ADD COLUMN course_id INTEGER REFERENCES courses(id);

-- 添加索引
CREATE INDEX idx_prospectuses_course_id ON prospectuses(course_id);
CREATE INDEX idx_schedules_course_id ON schedules(course_id);
```

**优点**:
- ✅ 真正的课程负责人管理
- ✅ 负责人变更时权限自动转移
- ✅ 多人可以管理同一课程资料
- ✅ 权限更清晰合理

**缺点**:
- ❌ 需要数据库迁移
- ❌ 需要修改前端代码
- ❌ 历史数据需要补充course_id
- ❌ 实施周期较长

**适用场景**:
- 课程资料需要团队协作
- 负责人可能变更
- 需要严格的权限控制
- 长期系统规划

## 第一阶段实施（基于上传人）

### 1. 权限定义更新

**文件**: `src/constants/permissions.ts`

**修改内容**:
```typescript
conference_service: [
  // ... 原有权限
  'prospectus_upload',  // 上传招商简章（限自己负责的课程）
  'prospectus_edit',    // 编辑招商简章（限自己负责的课程）
  'schedule_upload',    // 上传课表（限自己负责的课程）
  'schedule_edit',      // 编辑课表（限自己负责的课程）
]
```

### 2. 简章管理页面

**文件**: `src/pages/ProspectusManagement.tsx`

**权限控制逻辑**:
```typescript
// 判断是否可以编辑/删除
const canEdit = (prospectus: Prospectus) => {
  // 管理员可以编辑所有
  if (user?.role === 'admin') return true;
  
  // 会务客服只能编辑自己上传的
  if (user?.role === 'conference_service') {
    return prospectus.uploaded_by === user?.id;
  }
  
  return false;
};
```

**UI显示**:
- 上传按钮：使用 `<PermissionGuard permission="prospectus_upload">`
- 编辑按钮：动态显示，基于 `canEdit()` 判断
- 删除按钮：动态显示，基于 `canEdit()` 判断

### 3. 课表管理页面

**文件**: `src/pages/ScheduleManagement.tsx`

**类似的权限控制逻辑**:
```typescript
const canEdit = (schedule: Schedule) => {
  if (user?.role === 'admin') return true;
  if (user?.role === 'conference_service') {
    return schedule.uploaded_by === user?.id;
  }
  return false;
};
```

### 4. RLS策略（可选）

如果需要数据库层保护，可以添加RLS策略：

```sql
-- 简章编辑策略
CREATE POLICY "conference_service_edit_own_prospectuses"
ON prospectuses
FOR UPDATE
TO authenticated
USING (
  -- 管理员可以编辑所有
  auth.uid() IN (SELECT user_id FROM user_roles WHERE role = 'admin')
  OR
  -- 会务客服只能编辑自己上传的
  (auth.uid() IN (SELECT user_id FROM user_roles WHERE role = 'conference_service')
   AND uploaded_by = auth.uid())
);

-- 类似的课表策略
CREATE POLICY "conference_service_edit_own_schedules"
ON schedules
FOR UPDATE
TO authenticated
USING (
  auth.uid() IN (SELECT user_id FROM user_roles WHERE role = 'admin')
  OR
  (auth.uid() IN (SELECT user_id FROM user_roles WHERE role = 'conference_service')
   AND uploaded_by = auth.uid())
);
```

## 权限矩阵

### 简章管理权限

| 角色 | 查看 | 下载 | 上传 | 编辑自己的 | 编辑所有 | 删除自己的 | 删除所有 |
|------|------|------|------|-----------|---------|-----------|---------|
| 管理员 (admin) | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 会务客服 (conference_service) | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| 部门经理 (manager) | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 业务员 (salesperson) | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 专家 (expert) | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

### 课表管理权限

| 角色 | 查看 | 下载 | 上传 | 编辑自己的 | 编辑所有 | 删除自己的 | 删除所有 |
|------|------|------|------|-----------|---------|-----------|---------|
| 管理员 (admin) | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 会务客服 (conference_service) | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| 部门经理 (manager) | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 业务员 (salesperson) | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 专家 (expert) | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

## 使用场景

### 场景1：会务客服上传新简章

```
步骤：
1. 会务客服登录系统
2. 进入"招商简章"页面
3. 点击"上传简章"（有权限）
4. 填写简章信息，上传文件
5. 系统记录 uploaded_by = 当前用户ID

结果：
✅ 简章上传成功
✅ 该会务客服可以编辑/删除此简章
❌ 其他会务客服不能编辑此简章
✅ 管理员可以编辑此简章
```

---

### 场景2：会务客服编辑自己的简章

```
步骤：
1. 会务客服查看简章列表
2. 看到自己上传的简章，显示"编辑"按钮
3. 点击编辑，修改信息
4. 保存成功

结果：
✅ 编辑成功
✅ 只显示自己上传简章的编辑按钮
```

---

### 场景3：会务客服尝试编辑他人的简章

```
步骤：
1. 会务客服查看简章列表
2. 看到其他人上传的简章
3. 没有"编辑"按钮显示

结果：
❌ 不能编辑他人上传的简章
✅ UI层控制有效
```

---

### 场景4：管理员管理所有简章

```
步骤：
1. 管理员查看简章列表
2. 所有简章都显示"编辑"和"删除"按钮
3. 可以编辑/删除任何简章

结果：
✅ 管理员拥有完全权限
✅ 可以管理所有用户上传的资料
```

## 第二阶段规划（基于课程关联）

### 实施步骤

1. **数据库迁移**
   - 添加 course_id 字段
   - 添加外键约束
   - 添加索引

2. **历史数据处理**
   - 分析现有简章和课表
   - 手动或半自动关联到课程
   - 或保留为"未关联"状态

3. **前端改造**
   - 上传简章时选择关联课程
   - 编辑简章时可修改关联课程
   - 筛选显示：只显示自己负责课程的资料

4. **权限逻辑调整**
   ```typescript
   const canEdit = async (prospectus: Prospectus) => {
     if (user?.role === 'admin') return true;
     
     if (user?.role === 'conference_service') {
       // 查询课程负责人
       if (prospectus.course_id) {
         const course = await courseService.getCourse(prospectus.course_id);
         return course.projectManagerId === user?.id;
       }
       // 未关联课程的，仍使用上传人判断
       return prospectus.uploaded_by === user?.id;
     }
     
     return false;
   };
   ```

5. **UI优化**
   - 简章列表显示关联课程
   - 按课程筛选简章
   - 课程详情页显示相关简章和课表

### 数据模型

```
Course (课程)
├── id
├── name
├── project_manager_id  // 课程负责人
└── ...

Prospectus (简章)
├── id
├── name
├── course_id  // 关联课程 ➕ 新增
├── uploaded_by
└── ...

Schedule (课表)
├── id
├── name
├── course_id  // 关联课程 ➕ 新增
├── uploaded_by
└── ...
```

### 权限判断流程

```
会务客服编辑简章：
1. 检查用户角色 = conference_service ？
2. 如果简章有 course_id：
   2.1 查询课程的 project_manager_id
   2.2 判断 project_manager_id === user.id ？
3. 如果简章没有 course_id：
   3.1 判断 uploaded_by === user.id ？
4. 允许/拒绝操作
```

## 测试验证

### 测试用例1：会务客服上传简章

**步骤**:
1. 使用会务客服账号登录
2. 进入招商简章页面
3. 点击"上传简章"
4. 填写信息并上传文件

**预期结果**:
- ✅ 有"上传简章"按钮权限
- ✅ 上传成功
- ✅ 列表中显示新简章
- ✅ 新简章显示"编辑"和"删除"按钮

---

### 测试用例2：会务客服编辑自己的简章

**步骤**:
1. 会务客服查看自己上传的简章
2. 点击"编辑"按钮
3. 修改信息后保存

**预期结果**:
- ✅ 显示"编辑"按钮
- ✅ 可以修改信息
- ✅ 保存成功

---

### 测试用例3：会务客服查看他人简章

**步骤**:
1. 会务客服A 查看简章列表
2. 看到会务客服B 上传的简章

**预期结果**:
- ✅ 可以查看简章信息
- ✅ 可以下载简章
- ❌ 没有"编辑"按钮
- ❌ 没有"删除"按钮

---

### 测试用例4：管理员管理权限

**步骤**:
1. 管理员登录
2. 查看所有简章

**预期结果**:
- ✅ 所有简章都显示"编辑"按钮
- ✅ 所有简章都显示"删除"按钮
- ✅ 可以编辑任何简章

---

### 测试用例5：其他角色无权限

**步骤**:
1. 使用业务员账号登录
2. 进入招商简章页面

**预期结果**:
- ✅ 可以查看简章列表
- ✅ 可以下载简章
- ❌ 没有"上传简章"按钮
- ❌ 没有"编辑"按钮
- ❌ 没有"删除"按钮

## 部署建议

### 第一阶段部署

1. **权限更新**
   - ✅ 已完成：更新 permissions.ts

2. **前端代码更新**（待实施）
   - 修改 ProspectusManagement.tsx
   - 修改 ScheduleManagement.tsx
   - 添加权限判断逻辑

3. **测试验证**
   - 会务客服上传测试
   - 会务客服编辑测试
   - 权限隔离测试

4. **用户通知**
   - 通知会务客服新权限
   - 说明使用方式

### 第二阶段部署（未来）

1. **数据库迁移**
   - 执行SQL脚本
   - 验证表结构

2. **历史数据处理**
   - 分析现有数据
   - 关联课程（手动或脚本）

3. **前端改造**
   - 添加课程选择功能
   - 修改权限判断逻辑
   - UI优化

4. **全面测试**
   - 功能测试
   - 权限测试
   - 性能测试

5. **灰度发布**
   - 小范围试用
   - 收集反馈
   - 全面推广

## 注意事项

### 第一阶段注意事项

1. **上传人记录**
   - 确保 uploaded_by 正确记录
   - 上传时自动填充当前用户ID

2. **UI提示**
   - 清晰标识哪些是自己上传的
   - 权限不足时给出友好提示

3. **数据备份**
   - 部署前备份简章和课表数据
   - 防止误删除

### 第二阶段注意事项

1. **数据完整性**
   - course_id 可以为NULL（兼容历史数据）
   - 外键约束不能级联删除

2. **权限过渡**
   - 未关联课程的资料仍用上传人判断
   - 逐步完善课程关联

3. **性能考虑**
   - course_id 添加索引
   - 权限判断缓存课程信息

## 总结

### 第一阶段（已实施）

**核心改进**:
- ✅ 会务客服新增上传和编辑权限
- ✅ 基于上传人控制权限
- ✅ 实现简单快速

**限制**:
- ⚠️ 不是真正的"课程负责人"概念
- ⚠️ 权限转移需要手动处理

**适用场景**:
- 短期快速实现
- 每人负责不同课程
- 资料由负责人自己维护

### 第二阶段（待实施）

**核心改进**:
- 📋 简章课表与课程关联
- 📋 基于课程负责人控制权限
- 📋 权限更清晰合理

**优点**:
- ✅ 真正的负责人管理
- ✅ 权限自动转移
- ✅ 团队协作友好

**实施时机**:
- 当前方案使用一段时间后
- 收集用户反馈
- 确认需求后实施

现在会务客服可以上传、编辑自己上传的简章和课表了！🎉

## 版本历史

- **v1.0** (2025-11-16): 第一阶段权限定义完成
- **v2.0** (待定): 第二阶段课程关联方案
